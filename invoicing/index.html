<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cars & Collectibles — Invoice/Quote</title>
  <style>
    :root {
      --bg: #f3f4f6; --panel: #ffffff; --input-bg: #f9fafb; --muted: #6b7280;
      --line: #e5e7eb; --text: #111827; --accent: #2563eb; --warn: #d97706; --danger: #dc2626;
      --shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }
    [data-theme="dark"] {
      --bg: #0b0c10; --panel: #11131a; --input-bg: #0f121a; --muted: #a3a7b7;
      --line: #232634; --text: #e9ecf1; --accent: #3b82f6; --warn: #f59e0b; --danger: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.5);
    }
    [data-theme="midnight"] {
      --bg: #0f172a; --panel: #1e293b; --input-bg: #0f172a; --muted: #94a3b8;
      --line: #334155; --text: #f8fafc; --accent: #38bdf8; --warn: #fbbf24; --danger: #f87171;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.5);
    }
    [data-theme="forest"] {
      --bg: #051a10; --panel: #0a2618; --input-bg: #051a10; --muted: #8ba896;
      --line: #1b4d33; --text: #e8f5e9; --accent: #10b981; --warn: #f59e0b; --danger: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.5);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      transition: background 0.3s ease, color 0.3s ease;
    }
    a{color:var(--accent)}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .hidden{display:none!important}
    .btn{
      appearance:none;border:1px solid var(--line);background:var(--panel);
      color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;
      font-weight:500;transition: all 0.2s;
    }
    .btn:hover{background:#1f2332}
    [data-theme="light"] .btn:hover {background:#f3f4f6}

    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ghost{background:transparent}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#111}
    .btn.danger{background:var(--danger);border-color:var(--danger)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px;box-shadow:var(--shadow)}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:10px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .label{font-size:12px;font-weight:600;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
    input[type="text"], input[type="number"], input[type="date"], textarea, select{
      width:100%;background:var(--input-bg);color:var(--text);
      border:1px solid var(--line);border-radius:8px;padding:8px;transition:border-color 0.2s;
    }
    input:focus, textarea:focus, select:focus{outline:none;border-color:var(--accent)}
    textarea{min-height:70px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px}
    th{color:var(--muted);text-align:left;background:var(--input-bg);font-weight:600}
    td.right, th.right{text-align:right}
    tr.sel{background:var(--line)}
    tbody tr{cursor:pointer;transition:background 0.1s}

    .totals{display:grid;grid-template-columns:auto auto auto auto auto auto;gap:10px;align-items:center}
    .totals .value{font-weight:600}
    .totals .total{font-weight:800;font-size:18px}

    .login-container{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80vh}
    .login{width:100%;max-width:400px;padding:40px;border-radius:16px;background:var(--panel);box-shadow:var(--shadow)}
    .login .title{font-weight:800;font-size:24px;margin-bottom:24px;text-align:center;color:var(--accent)}
    .login input{padding:12px;font-size:15px}
    .login .btn{width:100%;padding:12px;font-size:16px;margin-top:8px}
    .help{color:var(--muted);font-size:13px}

    .menu{position:relative}
    .menu .menu-panel{position:absolute;z-index:10;top:100%;left:0;background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:6px;min-width:150px;display:none;box-shadow:var(--shadow)}
    .menu.open .menu-panel{display:block}
    .menu .menu-item{display:block;width:100%;text-align:left;border:none;background:transparent;color:var(--text);padding:6px 8px;border-radius:8px}
    .menu .menu-item:hover{background:var(--line)}

    .section-title{font-weight:700;margin:8px 0 6px;color:#fff}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px}

    .footer-note{color:var(--muted);font-size:12px;margin-top:8px}

    /* === Mobile responsiveness (colors unchanged) === */
    @media (max-width: 900px){
      .container{padding:12px}
      .grid{grid-template-columns:1fr}
      .kv{grid-template-columns:1fr}
      .btn, input[type="text"], input[type="number"], input[type="date"], textarea, select{min-height:44px}
      .totals{grid-template-columns:auto 1fr}

      table thead{display:none}
      table, tbody, tr, td{display:block;width:100%}
      table{border:0}
      tbody{display:block}
      tr{background:var(--panel);border:1px solid var(--line);border-radius:10px;margin-bottom:10px}
      td{display:flex;justify-content:space-between;gap:12px;padding:10px}
      td.right{text-align:left}

      td:nth-child(1)::before{content:"Description";color:var(--muted);font-weight:600}
      td:nth-child(2)::before{content:"Qty";color:var(--muted);font-weight:600}
      td:nth-child(3)::before{content:"Rate";color:var(--muted);font-weight:600}
      td:nth-child(4)::before{content:"Amount";color:var(--muted);font-weight:600}

      td:nth-child(1){flex-direction:column;align-items:stretch}
      td:nth-child(1)::before{margin-bottom:4px}
      td input[type="text"], td input[type="number"]{width:55%;min-width:140px;text-align:right;background:var(--input-bg)}

      .menu .menu-panel{right:0;left:auto;min-width:180px}
    }

    @media (max-width: 600px){
      .help{display:none}
    }
  </style>

  <!-- Export libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div id="login" class="login-container">
      <div class="login">
        <div class="title">Cars & Collectibles</div>
        <div style="margin-bottom:16px">
          <div class="label">Username</div>
          <input id="lgUser" type="text" autocomplete="username" placeholder="Enter username" />
        </div>
        <div style="margin-bottom:16px">
          <div class="label">Password</div>
          <input id="lgPass" type="password" autocomplete="current-password" placeholder="Enter password" />
        </div>
        <div class="row" style="margin-bottom:16px">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px"><input id="lgShow" type="checkbox" /> Show password</label>
        </div>
        <div id="lgMsg" class="help" style="text-align:center;color:var(--danger);margin-bottom:16px">&nbsp;</div>
        <button id="lgBtn" class="btn primary">Sign In</button>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <!-- top bar -->
      <div class="bar row">
        <div class="menu">
          <button class="btn" id="fileMenuBtn">File ▾</button>
          <div class="menu-panel" id="fileMenu">
            <button class="menu-item" id="saveDraftBtn">Save Draft (.json)</button>
            <button class="menu-item" id="loadDraftBtn">Load Draft (.json)</button>
            <button class="menu-item" id="aboutBtn">About</button>
          </div>
        </div>
        <div class="menu">
          <button class="btn" id="themeMenuBtn">Theme ▾</button>
          <div class="menu-panel" id="themeMenu">
            <button class="menu-item" data-theme="light">Light (Default)</button>
            <button class="menu-item" data-theme="dark">Dark</button>
            <button class="menu-item" data-theme="midnight">Midnight</button>
            <button class="menu-item" data-theme="forest">Forest</button>
          </div>
        </div>
        <button class="btn" id="copyTotalBtn">Copy Total</button>
        <span class="help">Cars & Collectibles — Invoice/Quote</span>
      </div>

      <!-- top forms -->
      <div class="panel">
        <div class="grid">
          <!-- Removed Business section (locked constants used instead) -->
          <div>
            <div class="section-title">Bill To</div>
            <div class="kv">
              <div class="label">Name</div><input id="custName" type="text" />
              <div class="label">Email</div><input id="custEmail" type="text" />
              <div class="label">Phone</div><input id="custPhone" type="text" />
              <div class="label">Address</div><textarea id="custAddress"></textarea>
            </div>
          </div>
        </div>

        <div class="grid" style="margin-top:8px">
          <div>
            <div class="section-title">Document</div>
            <div class="kv">
              <div class="label">Type</div>
              <div class="row" style="gap:6px">
                <select id="docType">
                  <option value="invoice">Invoice</option>
                  <option value="quote">Quote</option>
                </select>
                <div class="label" style="margin-left:8px">Currency</div>
                <input id="currency" type="text" value="$" style="width:70px" />
              </div>
              <div class="label">Prefix</div><input id="invPrefix" type="text" value="INV-" />
              <div class="label" id="docNumberLabel">Number</div><input id="invNumber" type="text" />
              <div class="label">Date</div><input id="invDate" type="date" />
              <div class="label" id="dueLabel">Due</div><input id="dueDate" type="date" />
              <div class="label">PO #</div><input id="poNumber" type="text" />
            </div>
          </div>
          <div>
            <div class="section-title">Payment & Notes</div>
            <div class="kv">
              <div class="label">Terms</div><input id="terms" type="text" value="Due upon receipt" />
              <div class="label">Accepted</div><input id="accepted" type="text" value="Cash, Venmo, PayPal" />
              <div class="label">Instructions</div><textarea id="instructions"></textarea>
              <div class="label">Notes</div><textarea id="notes"></textarea>
            </div>
          </div>
        </div>
      </div>
	  
      <!-- quick actions bar -->
      <div class="bar row">
        <button class="btn" id="addRowBtn">Add row</button>
        <button class="btn" id="removeRowBtn">Remove row</button>
        <button class="btn" id="dupRowBtn">Duplicate row</button>
        <button class="btn" id="pasteRowsBtn">Paste rows</button>
        <span style="width:16px"></span>
        <button class="btn" id="miniBtn">Mini Session</button>
        <button class="btn" id="stillBtn">Still Session</button>
        <button class="btn" id="rollerBtn">Roller Session</button>
        <button class="btn" id="featureBtn">Full Feature</button>
      </div>

      <!-- items table -->
      <div class="panel">
        <table id="items">
          <thead>
            <tr>
              <th style="width:60%">Description</th>
              <th class="right" style="width:10%">Qty</th>
              <th class="right" style="width:15%">Rate</th>
              <th class="right" style="width:15%">Amount</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>

      <!-- totals + actions -->
      <div class="bar" style="justify-content:space-between;align-items:center">
        <div class="totals">
          <div class="label">Subtotal</div><div id="lbSubtotal" class="value">$0.00</div>
          <div class="label">Tax %</div>
          <div class="row" style="gap:6px">
            <input id="taxPercent" type="number" step="0.1" min="0" value="0" style="width:90px" />
            <button class="btn ghost" id="toggleTaxBtn">Toggle Tax</button>
          </div>
          <div class="label">Tax</div><div id="lbTax" class="value">$0.00</div>
          <div class="label">Discount</div><div id="lbDiscount" class="value">-$0.00</div>
          <div class="label total">Total</div><div id="lbTotal" class="total">$0.00</div>
        </div>
        <div class="row">
          <button class="btn" id="nextBtn">Next #</button>
          <div class="menu">
            <button class="btn" id="discountBtn">Discount ▾</button>
            <div class="menu-panel" id="discountMenu">
              <div class="label" style="padding:4px 8px">Percent off</div>
              <button class="menu-item" data-discount="pct:5">5%</button>
              <button class="menu-item" data-discount="pct:10">10%</button>
              <button class="menu-item" data-discount="pct:15">15%</button>
              <button class="menu-item" data-discount="pct:20">20%</button>
              <hr style="border:0;border-top:1px solid var(--line)">
              <button class="menu-item" data-discount="pct:custom">Custom % …</button>
              <button class="menu-item" data-discount="flat:custom">Flat $ …</button>
              <button class="menu-item" data-discount="clear">Clear</button>
            </div>
          </div>
          <button class="btn" id="exportBtn">Export HTML</button>
          <button class="btn" id="openBtn">Open in Browser</button>
          <button class="btn" id="exportPdfBtn">Export PDF</button>
          <button class="btn" id="exportPngBtn">Export PNG</button>
        </div>
      </div>

      <div class="footer-note">Data is kept locally in your browser while the page is open. Use Save/Load Draft for persistence.</div>
    </div>
  </div>

<script>
(() => {
  // ===== CONFIG =====
  const AUTH_USER = 'carsandcollectibles';
  const AUTH_PASSWORD_SHA256 = 'a185c321c381be70dce7271b1016e96e01a7a75041a6a74e68b43c23af374738'; // cars2024
  const PRICE_MINI = 50.0, PRICE_STILL = 100.0, PRICE_ROLLER = 200.0, PRICE_FEATURE = 400.0;
  const DEFAULT_TAX = 6.0;

  // Locked business info (no UI)
  const BUSINESS = {
    name: 'Cars & Collectibles LLC',
    email: 'sales@carsandcollectibles.com',
    phone: '2089187761',
    website: 'https://carsandcollectibles.com',
    address: 'Boise, Idaho',
    logo: 'logo.png'
  };

  // ===== STATE =====
  let items = []; // {desc, qty, rate}
  let selectedIndex = -1;
  let discount = 0.0;
  let logoDataUrl = BUSINESS.logo; // fixed
  let docType = 'invoice'; // or 'quote'

  // ===== DOM =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];

  // Login elements
  const elLogin = $('#login'), elApp = $('#app');
  const lgUser = $('#lgUser'), lgPass = $('#lgPass'), lgMsg = $('#lgMsg');
  $('#lgShow').addEventListener('change', e => { lgPass.type = e.target.checked ? 'text' : 'password'; });
  $('#lgBtn').addEventListener('click', async () => {
    try {
      const ok = await checkCredentials(lgUser.value, lgPass.value);
      if (ok) { elLogin.classList.add('hidden'); elApp.classList.remove('hidden'); initApp(); }
      else { lgMsg.textContent = 'Invalid username or password.'; }
    } catch (err) {
      lgMsg.textContent = 'This browser doesn\'t support Web Crypto (SHA-256).';
    }
  });

  async function checkCredentials(user, pass) {
    if (user.trim().toLowerCase() !== AUTH_USER) return false;
    const hex = await sha256Hex(pass);
    return hex === AUTH_PASSWORD_SHA256;
  }
  async function sha256Hex(s) {
    const buf = new TextEncoder().encode(s);
    const digest = await crypto.subtle.digest('SHA-256', buf);
    return [...new Uint8Array(digest)].map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // ===== APP =====
  function initApp() {
    // Defaults
    $('#invDate').value = today();
    $('#dueDate').value = today();
    $('#invNumber').value = nextNumber($('#invPrefix').value || 'INV-');
    
    // Theme Load
    const savedTheme = localStorage.getItem('cc_theme') || 'light';
    setTheme(savedTheme);

    // Autosave Load
    const saved = localStorage.getItem('cc_autosave');
    if (saved) {
      try { fromJson(JSON.parse(saved)); } catch(e) { console.error(e); addBlankRow(); }
    } else { addBlankRow(); }

    // Menus
    attachMenu('#fileMenuBtn', '#fileMenu');
    attachMenu('#themeMenuBtn', '#themeMenu');
    attachMenu('#discountBtn', '#discountMenu');

    // File menu
    $('#aboutBtn').addEventListener('click', () => alert('Cars & Collectibles — Web Invoice/Quote'));
    $('#saveDraftBtn').addEventListener('click', saveDraft);
    $('#loadDraftBtn').addEventListener('click', loadDraft);
    $('#copyTotalBtn').addEventListener('click', () => navigator.clipboard.writeText($('#lbTotal').textContent));

    // Theme menu
    $('#themeMenu').addEventListener('click', e => {
      const t = e.target.getAttribute('data-theme');
      if(t) setTheme(t);
    });

    // Quick actions
    $('#addRowBtn').addEventListener('click', addBlankRow);
    $('#removeRowBtn').addEventListener('click', removeSelected);
    $('#dupRowBtn').addEventListener('click', duplicateSelected);
    $('#pasteRowsBtn').addEventListener('click', pasteRows);

    $('#miniBtn').addEventListener('click', () => addOrBump('Mini Session', 1, PRICE_MINI));
    $('#stillBtn').addEventListener('click', () => addOrBump('Still Session', 1, PRICE_STILL));
    $('#rollerBtn').addEventListener('click', () => addOrBump('Roller Session', 1, PRICE_ROLLER));
    $('#featureBtn').addEventListener('click', () => addOrBump('Full Feature', 1, PRICE_FEATURE));

    // Totals controls
    $('#taxPercent').addEventListener('input', recalc);
    $('#toggleTaxBtn').addEventListener('click', () => {
      const t = parseFloat($('#taxPercent').value||'0');
      $('#taxPercent').value = t > 0 ? '0' : DEFAULT_TAX.toString();
      recalc();
    });

    // Discount menu
    $('#discountMenu').addEventListener('click', e => {
      const el = e.target.closest('[data-discount]');
      if (!el) return;
      const spec = el.getAttribute('data-discount');
      if (spec === 'clear') { discount = 0; recalc(); return; }
      const [kind, val] = spec.split(':');
      if (kind === 'pct') {
        let pct = (val === 'custom') ? parseFloat(prompt('Percent off (e.g. 12.5):')||'0') : parseFloat(val);
        if (!isFinite(pct) || pct < 0) pct = 0;
        discount = round2(subtotal() * (pct/100));
        recalc();
      } else if (kind === 'flat') {
        let amt = (val === 'custom') ? parseFloat(prompt('Flat amount:')||'0') : parseFloat(val);
        if (!isFinite(amt) || amt < 0) amt = 0;
        discount = round2(amt); recalc();
      }
    });

    // Numbering
    $('#nextBtn').addEventListener('click', () => {
      const prefix = ($('#invPrefix').value || (docType === 'quote' ? 'Q-' : 'INV-'));
      $('#invNumber').value = nextNumber(prefix);
    });

    // Doc type toggle
    $('#docType').addEventListener('change', () => {
      docType = $('#docType').value; // invoice|quote
      const pfx = $('#invPrefix').value.trim();
      if (pfx === '' || pfx === 'INV-' || pfx === 'Q-') {
        $('#invPrefix').value = (docType === 'quote') ? 'Q-' : 'INV-';
      }
      const curNo = $('#invNumber').value || '';
      const dash = curNo.indexOf('-');
      if (dash > 0) {
        $('#invNumber').value = (docType === 'quote' ? 'Q-' : 'INV-') + curNo.substring(dash+1);
      }
      $('#docNumberLabel').textContent = (docType === 'quote') ? 'Quote #' : 'Invoice #';
      $('#dueLabel').textContent = (docType === 'quote') ? 'Valid until' : 'Due';
      document.title = (docType === 'quote' ? 'Quote' : 'Invoice') + ' — Cars & Collectibles';
    });

    // NOTE: Logo upload removed (no UI, fixed logo)
    // Subtotal-dependent fields (safe, no-op if missing)
    ['currency','terms','accepted','instructions','notes','invPrefix','invNumber','invDate','dueDate','poNumber','custName','custEmail','custPhone','custAddress']
      .forEach(id => { const el = $('#'+id); el && el.addEventListener('input', saveState); });

    // Export buttons
    $('#exportPdfBtn').addEventListener('click', exportPDF);
    $('#exportPngBtn').addEventListener('click', exportPNG);

    recalc();
  }

  function setTheme(name) {
    document.documentElement.setAttribute('data-theme', name);
    localStorage.setItem('cc_theme', name);
  }

  // ===== Items Table =====
  function addBlankRow() { addItem({desc:'', qty:1, rate:0}); }
  function addItem(it) { items.push({...it}); renderItems(items.length - 1); recalc(); }
  function removeSelected() {
    if (selectedIndex < 0) return;
    items.splice(selectedIndex,1);
    selectedIndex = -1; renderItems(); recalc();
  }
  function duplicateSelected() {
    if (selectedIndex < 0) return;
    const it = items[selectedIndex];
    items.push({...it}); renderItems(items.length - 1); recalc();
  }
  function pasteRows() {
    if (!navigator.clipboard) { const s = prompt('Paste rows (desc, qty, rate) one per line:'); if (s) parseRows(s); return; }
    navigator.clipboard.readText().then(text => { if (text) parseRows(text); });
  }
  function parseRows(s) {
    const lines = s.split(/\r?\n/);
    for (const line of lines) {
      const parts = line.split(/\t|,/);
      if (parts.length >= 3) {
        const desc = parts[0].trim();
        const qty = parseFloat(parts[1]);
        const rate = parseFloat(parts[2]);
        if (desc) items.push({desc, qty: isFinite(qty)?qty:0, rate: isFinite(rate)?rate:0});
      }
    }
    renderItems(items.length - 1); recalc();
  }
  function addOrBump(description, qtyToAdd, rate) {
    const target = normalizeDesc(description);
    let idx = items.findIndex(it => normalizeDesc(it.desc) === target);
    if (idx >= 0) {
      items[idx].qty = round2(items[idx].qty + qtyToAdd);
      if (!items[idx].rate) items[idx].rate = rate;
      renderItems(idx);
    } else {
      items.push({desc:description, qty:qtyToAdd, rate});
      renderItems(items.length - 1);
    }
    recalc();
  }
  function renderItems(selectIdx = -1) {
    const tbody = $('#itemsBody');
    tbody.innerHTML = '';
    items.forEach((it, i) => {
      const tr = document.createElement('tr');
      if (i === selectedIndex) tr.classList.add('sel');
      tr.innerHTML = `
        <td><input type="text" data-k="desc" value="${escapeHtml(it.desc)}" style="width:100%"></td>
        <td class="right"><input type="number" step="0.01" min="0" data-k="qty" value="${it.qty}"></td>
        <td class="right"><input type="number" step="0.01" min="0" data-k="rate" value="${it.rate}"></td>
        <td class="right"><span>${money(it.qty*it.rate, $('#currency').value||'$')}</span></td>`;
      tr.addEventListener('click', () => { selectedIndex = i; $$('#itemsBody tr').forEach(r=>r.classList.remove('sel')); tr.classList.add('sel'); });
      tr.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('input', () => {
          const k = inp.getAttribute('data-k');
          if (k === 'desc') items[i].desc = inp.value;
          else items[i][k] = parseFloat(inp.value || '0') || 0;
          const amt = round2(items[i].qty * items[i].rate);
          tr.querySelector('td:last-child span').textContent = money(amt, $('#currency').value||'$');
          recalc();
        });
      });
      tbody.appendChild(tr);
    });
    if (selectIdx >= 0) { selectedIndex = selectIdx; const tr = tbody.children[selectIdx]; if (tr) tr.classList.add('sel'); }
  }

  // ===== Totals =====
  function subtotal() { return items.reduce((s,it)=> s + round2((it.qty||0)*(it.rate||0)), 0); }
  function recalc() {
    const cur = ($('#currency').value||'$').trim() || '$';
    const sub = subtotal();
    const taxRate = parseFloat($('#taxPercent').value || '0') || 0;
    const tax = round2(sub * (taxRate/100));
    const tot = Math.max(0, round2(sub + tax - (discount||0)));
    $('#lbSubtotal').textContent = money(sub, cur);
    $('#lbTax').textContent = money(tax, cur);
    $('#lbDiscount').textContent = '-' + money(discount||0, cur);
    $('#lbTotal').textContent = money(tot, cur);
    saveState();
  }

  // ===== Export / Draft =====
  const BASE_CSS = `@media print { @page { size: __PAGE_SIZE__; margin: 0.6in; }}:root { --text:#111; --muted:#666; --line:#e5e7eb; --brand:#111827;}*{box-sizing:border-box}body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,Noto Sans,sans-serif;margin:0;color:var(--text)}.wrapper{max-width:8.5in;margin:0 auto;padding:32px}.header{display:flex;justify-content:space-between;align-items:center;gap:16px}.brand{display:flex;align-items:center;gap:12px}.brand .name{font-size:20px;font-weight:700;color:var(--brand)}.brand .meta{font-size:12px;color:var(--muted)}.logo{width:56px;height:56px;object-fit:contain;border-radius:8px;border:1px solid var(--line);padding:6px;background:#fff}.h1{font-size:28px;font-weight:800}.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:18px}.card{border:1px solid var(--line);border-radius:12px;padding:14px}.small{font-size:12px;color:var(--muted)}.kv{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px}.table{width:100%;border-collapse:collapse;margin-top:16px}.table th,.table td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:13px;vertical-align:top}.table th{text-align:left;font-weight:700;background:#fafafa}.right{text-align:right}.totals{margin-top:10px;margin-left:auto;width:320px}.totals .row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed var(--line);font-size:14px}.totals .total{font-weight:800;font-size:18px;border-bottom:none;padding-top:10px}.footer{display:flex;gap:16px;margin-top:18px}.note,.pay{flex:1;border:1px solid var(--line);border-radius:12px;padding:12px}.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#111;color:#fff;font-size:11px;font-weight:700;letter-spacing:.3px}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}`;

  const HTML_TEMPLATE = `<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/>`+
  `<meta name="viewport" content="width=device-width, initial-scale=1"/>`+
  `<title>{inv_number} — {doc_title} — {business_name}</title><style>{css}</style></head><body>`+
  `<div class="wrapper"><div class="header">`+
  `<div class="brand">{logo_img}<div><div class="name">{business_name}</div>`+
  `<div class="meta">{business_address}{business_phone}<div><a href="mailto:{business_email}">{business_email}</a> · <a href="{business_website}">{business_website}</a></div></div>`+
  `</div></div><div class="h1">{doc_title}</div></div><div class="grid">`+
  `<div class="card"><div class="small">BILL TO</div><div style="margin-top:6px;font-weight:700">{cust_name}</div>`+
  `<div>{cust_address}</div><div>{cust_phone}</div><div><a href="mailto:{cust_email}">{cust_email}</a></div></div>`+
  `<div class="card"><div class="kv"><div>{doc_number_label}</div><div class="mono">{inv_number}</div><div>Date</div><div>{inv_date}</div>`+
  `<div>{due_label}</div><div>{due_date}</div><div>PO #</div><div>{po_number}</div><div>Terms</div><div>{terms}</div></div></div>`+
  `</div>`+
  `<table class="table"><thead><tr><th style="width:60%">Description</th><th class="right">Qty</th><th class="right">Rate</th><th class="right">Amount</th></tr></thead><tbody>{rows}</tbody></table>`+
  `<div class="totals"><div class="row"><span>Subtotal</span><span>{subtotal}</span></div>`+
  `<div class="row"><span>Tax ({tax_rate}%)</span><span>{tax}</span></div>`+
  `<div class="row"><span>Discount</span><span>-{discount}</span></div>`+
  `<div class="row total"><span>Total</span><span>{total}</span></div></div>`+
  `<div class="footer"><div class="note"><div class="small" style="margin-bottom:6px">NOTES</div><div>{notes}</div></div>`+
  `<div class="pay"><div class="small" style="margin-bottom:6px">PAYMENT</div><div><span class="badge">Accepted</span> {accepted_methods}</div>`+
  `<pre class="mono" style="white-space:pre-wrap;margin-top:8px">{instructions}</pre></div></div>`+
  `</div></body></html>`;

  $('#openBtn').addEventListener('click', () => {
    const html = renderHtml();
    const w = window.open('', '_blank');
    if (!w) return alert('Popup blocked. Allow popups for this site.');
    w.document.open(); w.document.write(html); w.document.close();
  });
  $('#exportBtn').addEventListener('click', () => {
    const html = renderHtml();
    const blob = new Blob([html], {type:'text/html;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const name = ($('#invNumber').value || 'invoice').replace(/\//g,'-') + '.html';
    a.download = name; a.click(); URL.revokeObjectURL(a.href);
  });

  function renderHtml() {
    const cur = ($('#currency').value||'$').trim() || '$';
    let rows = '';
    for (const it of items) {
      const desc = escapeHtml(it.desc||'');
      const qty = trimZeros(it.qty||0);
      const rate = money(it.rate||0, cur);
      const amt = money((it.qty||0)*(it.rate||0), cur);
      rows += `<tr><td>${desc}</td><td class="right">${qty}</td><td class="right">${rate}</td><td class="right">${amt}</td></tr>\n`;
    }
    const sub = subtotal();
    const taxRate = parseFloat($('#taxPercent').value||'0')||0;
    const tax = round2(sub * (taxRate/100));
    const tot = Math.max(0, round2(sub + tax - (discount||0)));

    const logoImg = logoDataUrl ? `<img class="logo" src="${logoDataUrl}" alt="logo"/>` : '';

    const docTitle = (docType === 'quote') ? 'Quote' : 'Invoice';
    const docNumberLabel = (docType === 'quote') ? 'Quote #' : 'Invoice #';
    const dueLabel = (docType === 'quote') ? 'Valid until' : 'Due';

    return HTML_TEMPLATE
      .replace('{css}', BASE_CSS.replace('__PAGE_SIZE__', 'letter'))
      .replaceAll('{logo_img}', logoImg)
      .replaceAll('{business_name}', esc(BUSINESS.name))
      .replaceAll('{business_email}', esc(BUSINESS.email))
      .replaceAll('{business_phone}', safeDiv(BUSINESS.phone))
      .replaceAll('{business_website}', esc(BUSINESS.website))
      .replaceAll('{business_address}', safeDiv(BUSINESS.address))
      .replaceAll('{cust_name}', esc($('#custName').value))
      .replaceAll('{cust_email}', esc($('#custEmail').value))
      .replaceAll('{cust_phone}', esc($('#custPhone').value))
      .replaceAll('{cust_address}', esc($('#custAddress').value))
      .replaceAll('{inv_number}', esc($('#invNumber').value))
      .replaceAll('{inv_date}', esc($('#invDate').value))
      .replaceAll('{due_date}', esc($('#dueDate').value))
      .replaceAll('{po_number}', esc($('#poNumber').value))
      .replaceAll('{terms}', esc($('#terms').value))
      .replaceAll('{rows}', rows)
      .replaceAll('{subtotal}', money(sub, cur))
      .replaceAll('{tax_rate}', (taxRate).toFixed(2))
      .replaceAll('{tax}', money(tax, cur))
      .replaceAll('{discount}', money(discount||0, cur))
      .replaceAll('{total}', money(tot, cur))
      .replaceAll('{notes}', esc($('#notes').value))
      .replaceAll('{accepted_methods}', esc($('#accepted').value))
      .replaceAll('{instructions}', esc($('#instructions').value))
      .replaceAll('{doc_title}', docTitle)
      .replaceAll('{doc_number_label}', docNumberLabel)
      .replaceAll('{due_label}', dueLabel);
  }

  // === Export helpers ===
  async function exportPNG(){
    const html = renderHtml();
    const iframe = await makeFrame(html);
    try {
      await waitForImages(iframe);
      const doc = iframe.contentDocument;
      const el = doc.body;
      const width = doc.documentElement.scrollWidth;
      const height = doc.documentElement.scrollHeight;
      const canvas = await html2canvas(el, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        scrollX: 0,
        scrollY: 0,
        windowWidth: width,
        windowHeight: height
      });
      const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
      downloadBlob(blob, fileBase()+'.png');
    } catch (e){ alert('PNG export failed: '+e.message); }
    finally { iframe.remove(); }
  }

  // Fixed-scale PDF export (no zoom)
  async function exportPDF(){
    const html = renderHtml();
    const iframe = await makeFrame(html);
    try{
      await waitForImages(iframe);

      const docEl = iframe.contentDocument.documentElement;
      const bodyEl = iframe.contentDocument.body;
      const canvas = await html2canvas(bodyEl, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        scrollX: 0,
        scrollY: 0,
        windowWidth: docEl.scrollWidth,
        windowHeight: docEl.scrollHeight
      });

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: 'pt', format: 'letter', compress: true });

      const pageWidth  = pdf.internal.pageSize.getWidth();   // 612 pt
      const pageHeight = pdf.internal.pageSize.getHeight();  // 792 pt
      const margin = 36;                                     // 0.5"
      const usableWidth  = pageWidth  - margin * 2;
      const usableHeight = pageHeight - margin * 2;

      const imgData = canvas.toDataURL('image/png');
      const imgRatio = canvas.height / canvas.width;
      const imgWidthPt  = usableWidth;
      const imgHeightPt = imgWidthPt * imgRatio;

      pdf.addImage(imgData, 'PNG', margin, margin, imgWidthPt, imgHeightPt);

      let heightLeft = imgHeightPt - usableHeight;
      while (heightLeft > 0) {
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', margin, margin - (imgHeightPt - heightLeft), imgWidthPt, imgHeightPt);
        heightLeft -= usableHeight;
      }

      pdf.save(fileBase() + '.pdf');
    } catch(e){
      alert('PDF export failed: ' + e.message);
    } finally {
      iframe.remove();
    }
  }

  function fileBase(){
    return ($('#invNumber').value || 'invoice').replace(/\//g,'-');
  }
  function makeFrame(html){
    return new Promise(resolve => {
      const iframe = document.createElement('iframe');
      iframe.style.position='fixed';
      iframe.style.left='-10000px';
      iframe.style.top='0';
      iframe.style.width='816px';
      iframe.style.height='1120px';
      document.body.appendChild(iframe);
      iframe.onload = () => resolve(iframe);
      iframe.srcdoc = html;
    });
  }
  function waitForImages(iframe){
    const doc = iframe.contentDocument;
    const imgs = Array.from(doc.images || []);
    if (imgs.length === 0) return Promise.resolve();
    return new Promise((resolve) => {
      let left = imgs.length;
      const done = () => (--left <= 0) && resolve();
      imgs.forEach(img => {
        if (img.complete) done();
        else {
          img.addEventListener('load', done);
          img.addEventListener('error', done);
        }
      });
      setTimeout(resolve, 1500);
    });
  }

  function saveDraft() {
    const data = toJson();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'invoice_draft.json';
    a.click(); URL.revokeObjectURL(a.href);
  }
  function loadDraft() {
    const inp = document.createElement('input');
    inp.type = 'file'; inp.accept = 'application/json';
    inp.onchange = async () => {
      const f = inp.files && inp.files[0]; if (!f) return;
      const text = await f.text();
      try { const obj = JSON.parse(text); fromJson(obj); recalc(); } catch(e) { alert('Failed: '+e.message); }
    };
    inp.click();
  }

  function toJson() {
    return {
      // Save locked business info too (for completeness)
      biz_name: BUSINESS.name,
      biz_email: BUSINESS.email,
      biz_phone: BUSINESS.phone,
      biz_website: BUSINESS.website,
      biz_address: BUSINESS.address,
      logo_data_url: BUSINESS.logo,
      cust_name: $('#custName').value,
      cust_email: $('#custEmail').value,
      cust_phone: $('#custPhone').value,
      cust_address: $('#custAddress').value,
      inv_prefix: $('#invPrefix').value,
      inv_number: $('#invNumber').value,
      inv_date: $('#invDate').value,
      inv_due: $('#dueDate').value,
      po_number: $('#poNumber').value,
      currency: $('#currency').value,
      tax_percent: $('#taxPercent').value,
      discount: discount,
      terms: $('#terms').value,
      accepted: $('#accepted').value,
      instructions: $('#instructions').value,
      notes: $('#notes').value,
      doc_type: docType,
      items: items.map(it => ({description: it.desc, qty: it.qty, rate: it.rate}))
    };
  }

  function saveState() {
    localStorage.setItem('cc_autosave', JSON.stringify(toJson()));
  }
  function fromJson(m) {
    // Ignore business fields (locked)
    logoDataUrl = BUSINESS.logo;

    $('#custName').value = m.cust_name || '';
    $('#custEmail').value = m.cust_email || '';
    $('#custPhone').value = m.cust_phone || '';
    $('#custAddress').value = m.cust_address || '';

    $('#invPrefix').value = m.inv_prefix || 'INV-';
    $('#invNumber').value = m.inv_number || nextNumber($('#invPrefix').value);
    $('#invDate').value = m.inv_date || today();
    $('#dueDate').value = m.inv_due || today();
    $('#poNumber').value = m.po_number || '';
    $('#currency').value = m.currency || '$';
    $('#taxPercent').value = (m.tax_percent != null) ? m.tax_percent : '0';
    discount = parseFloat(m.discount||'0')||0;

    $('#terms').value = m.terms || 'Due upon receipt';
    $('#accepted').value = m.accepted || 'Cash, Card';
    $('#instructions').value = m.instructions || '';
    $('#notes').value = m.notes || '';

    docType = (m.doc_type === 'quote') ? 'quote' : 'invoice';
    $('#docType').value = docType;
    $('#docNumberLabel').textContent = (docType === 'quote') ? 'Quote #' : 'Invoice #';
    $('#dueLabel').textContent = (docType === 'quote') ? 'Valid until' : 'Due';

    items = (m.items || []).map(it => ({desc: it.description||'', qty: +it.qty||0, rate: +it.rate||0}));
    if (items.length === 0) addBlankRow(); else renderItems();
  }

  // ===== Helpers =====
  function normalizeDesc(s){return (s||'').trim().replace(/\s+/g,' ').toLowerCase();}
  function escapeHtml(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#x27;');}
  function esc(s){return escapeHtml(s||'');}
  function safeDiv(s){s = (s||'').trim(); return s?('<div>'+escapeHtml(s)+'</div>'):'';}
  function today(){return new Date().toISOString().slice(0,10);} // yyyy-mm-dd
  function round2(v){return Math.round(v*100)/100;}
  function money(v, cur){return (cur||'$') + (Number(v)||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
  function trimZeros(d){return Math.abs(d - Math.round(d)) < 1e-9 ? String(Math.round(d)) : String(d);}
  function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);});}

  function nextNumber(prefix){
    try {
      const k = 'cc_counter';
      let n = parseInt(localStorage.getItem(k)||'0',10) + 1;
      localStorage.setItem(k, String(n));
      prefix = prefix || 'INV-';
      return prefix + String(n).padStart(4,'0');
    } catch(e) {
      return (prefix||'INV-') + Math.floor(Math.random()*9000+1000);
    }
  }
  function attachMenu(btnSel, panelSel){
    const btn = $(btnSel), panel = $(panelSel); const host = btn.parentElement; host.classList.remove('open');
    btn.addEventListener('click', (e) => { e.stopPropagation(); host.classList.toggle('open'); });
    document.addEventListener('click', () => host.classList.remove('open'));
  }
  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  }
})();
</script>
</body>
</html>
