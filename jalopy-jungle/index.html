<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PROFIT - Parts Resale Optimization & Field Inventory Tool</title>

  <!-- Bootstrap & libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <!-- QR Code Libs -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>


  <style>
  
  /* Jalopy subtabs */
.jalopy-subtab-bar {
  display: flex;
  gap: .5rem;
  margin-bottom: .75rem;
}

.jalopy-subtab-btn {
  padding: .35rem .75rem;
  border-radius: 999px;
  border: 1px solid #ced4da;
  background: transparent;
  font-size: .9rem;
  cursor: pointer;
}

body.dark-mode .jalopy-subtab-btn {
  border-color: #2b3745;
  color: #f1f1f1;
}

.jalopy-subtab-btn.active {
  background: orange;
  color: #000;
  border-color: orange;
}

    /* Slate Theme */
    body.theme-slate { background-color: #27272a; color: #e4e4e7; }
    body.theme-slate .table { color: #e4e4e7; }
    body.theme-slate .table-dark { background-color: #3f3f46; }
    body.theme-slate .tab-card { background: #3f3f46; border-color: #52525b; box-shadow: none; }
    body.theme-slate .modal-content { background-color: #3f3f46; color: #e4e4e7; }
    body.theme-slate .jalopy-subtab-btn { border-color: #52525b; color: #e4e4e7; }
    body.theme-slate .sticky-note { background: #494950; border-color: #6a6a73; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    body.theme-slate .text-muted { color: #a1a1aa !important; }
    body.theme-slate .sticky-note .sticky-header { background: rgba(255,255,255,.06); border-bottom-color: rgba(255,255,255,.08); }
    body.theme-slate .sticky-note .sticky-title { color: #f0f0f0; }
    /* ---------- Theme / base ---------- */
    /* Sunrise Theme (Light) */
    body.theme-sunrise { background-color: #fdf6e3; color: #586e75; }
    body.theme-sunrise .table { color: #586e75; }
    body.theme-sunrise .table-dark { background-color: #eee8d5; color: #586e75; }
    body.theme-sunrise .tab-card { background: #f5efdc; border-color: #e9e2c9; box-shadow: 0 4px 12px rgba(0,0,0,.04); }
    body.theme-sunrise .modal-content { background-color: #f5efdc; color: #586e75; }
    body.theme-sunrise .jalopy-subtab-btn { border-color: #dcd5c0; color: #586e75; }
    body.theme-sunrise .jalopy-subtab-btn.active { background: #b58900; color: #fff; border-color: #b58900; }

    /* Paper Theme (Light) */
    body.theme-paper { background-color: #f7f7f7; color: #111; }
    body.theme-paper .table { color: #111; }
    body.theme-paper .table-dark { background-color: #e8e8e8; color: #111; }
    body.theme-paper .tab-card { background: #fff; border-color: #ddd; box-shadow: 0 6px 18px rgba(0,0,0,.05); }
    body.theme-paper .modal-content { background-color: #fff; color: #111; }
    body.theme-paper .jalopy-subtab-btn { border-color: #ccc; color: #111; }
    body.theme-paper .jalopy-subtab-btn.active { background: #333; color: #fff; border-color: #333; }

    /* Ocean Theme (Dark) */
    body.theme-ocean { background-color: #1d2d3d; color: #b0c4de; }
    body.theme-ocean .table { color: #b0c4de; }
    body.theme-ocean .table-dark { background-color: #2a4058; }
    body.theme-ocean .tab-card { background: #2a4058; border-color: #416183; box-shadow: none; }
    body.theme-ocean .modal-content { background-color: #2a4058; color: #b0c4de; }
    body.theme-ocean .jalopy-subtab-btn { border-color: #416183; color: #b0c4de; }
    body.theme-ocean .text-muted { color: #8294ac !important; }

    /* Forest Theme (Dark) */
    body.theme-forest { background-color: #1a2a27; color: #a2b8b4; }
    body.theme-forest .table { color: #a2b8b4; }
    body.theme-forest .table-dark { background-color: #243b36; }
    body.theme-forest .tab-card { background: #243b36; border-color: #3a5e56; box-shadow: none; }
    body.theme-forest .modal-content { background-color: #243b36; color: #a2b8b4; }
    body.theme-forest .jalopy-subtab-btn { border-color: #3a5e56; color: #a2b8b4; }
    body.theme-forest .text-muted { color: #889c98 !important; }

    /* Crimson Theme (Dark) */
    body.theme-crimson { background-color: #2a1a1a; color: #d9c2c2; }
    body.theme-crimson .table { color: #d9c2c2; }
    body.theme-crimson .table-dark { background-color: #402a2a; }
    body.theme-crimson .tab-card { background: #402a2a; border-color: #634343; box-shadow: none; }
    body.theme-crimson .modal-content { background-color: #402a2a; color: #d9c2c2; }
    body.theme-crimson .jalopy-subtab-btn { border-color: #634343; color: #d9c2c2; }
    body.theme-crimson .text-muted { color: #9e8686 !important; }

    /* Nord Theme (Dark) */
    body.theme-nord { background-color: #2e3440; color: #d8dee9; }
    body.theme-nord .table { color: #d8dee9; }
    body.theme-nord .table-dark { background-color: #3b4252; }
    body.theme-nord .tab-card { background: #3b4252; border-color: #4c566a; box-shadow: none; }
    body.theme-nord .modal-content { background-color: #3b4252; color: #d8dee9; }
    body.theme-nord .jalopy-subtab-btn { border-color: #4c566a; color: #d8dee9; }
    body.theme-nord .text-muted { color: #a8b0c1 !important; }

    /* Dracula Theme (Dark) */
    body.theme-dracula { background-color: #282a36; color: #f8f8f2; }
    body.theme-dracula .table { color: #f8f8f2; }
    body.theme-dracula .table-dark { background-color: #44475a; }
    body.theme-dracula .tab-card { background: #44475a; border-color: #6272a4; box-shadow: none; }
    body.theme-dracula .modal-content { background-color: #44475a; color: #f8f8f2; }
    body.theme-dracula .jalopy-subtab-btn { border-color: #6272a4; color: #f8f8f2; }
    body.theme-dracula .text-muted { color: #b4b4ad !important; }

    /* Gruvbox Theme (Dark) */
    body.theme-gruvbox { background-color: #282828; color: #ebdbb2; }
    body.theme-gruvbox .table { color: #ebdbb2; }
    body.theme-gruvbox .table-dark { background-color: #3c3836; }
    body.theme-gruvbox .tab-card { background: #3c3836; border-color: #504945; box-shadow: none; }
    body.theme-gruvbox .modal-content { background-color: #3c3836; color: #ebdbb2; }
    body.theme-gruvbox .jalopy-subtab-btn { border-color: #504945; color: #ebdbb2; }
    body.theme-gruvbox .text-muted { color: #bdae93 !important; }

    /* Latte Theme (Light) */
    body.theme-latte { background-color: #eff1f5; color: #4c4f69; }
    body.theme-latte .table { color: #4c4f69; }
    body.theme-latte .table-dark { background-color: #e6e9ef; color: #4c4f69; }
    body.theme-latte .tab-card { background: #e6e9ef; border-color: #ccd0da; box-shadow: 0 4px 12px rgba(0,0,0,.04); }
    body.theme-latte .modal-content { background-color: #e6e9ef; color: #4c4f69; }
    body.theme-latte .jalopy-subtab-btn { border-color: #bcc0cc; color: #4c4f69; }

    /* Mint Theme (Light) */
    body.theme-mint { background-color: #f0fbf4; color: #0f3d2f; }
    body.theme-mint .table { color: #0f3d2f; }
    body.theme-mint .table-dark { background-color: #dcfce7; color: #0f3d2f; }
    body.theme-mint .tab-card { background: #e7f9ee; border-color: #b5e6c9; box-shadow: 0 4px 12px rgba(0,0,0,.04); }
    body.theme-mint .modal-content { background-color: #e7f9ee; color: #0f3d2f; }
    body.theme-mint .jalopy-subtab-btn { border-color: #a3d9b9; color: #0f3d2f; }

    /* Silly Goose Animations */
    @keyframes silly-bg-shift {
      0%   { background-color: #f0f8ff; } 20% { background-color: #fff0f5; }
      40%  { background-color: #f5fff0; } 60% { background-color: #fff5f0; }
      80%  { background-color: #f0fff5; } 100% { background-color: #f0f8ff; }
    }
    @keyframes silly-rainbow-text {
      0%   { color: #ff4500; } 15% { color: #ff8c00; } 30% { color: #ffd700; }
      45%  { color: #32cd32; } 60% { color: #00ced1; } 75% { color: #1e90ff; }
      90%  { color: #9400d3; } 100% { color: #ff4500; }
    }
    @keyframes silly-wobble {
      0%, 100% { transform: rotate(0); }
      25% { transform: rotate(-1.5deg); }
      75% { transform: rotate(1.5deg); }
    }

    /* Silly Goose Theme */
    body.theme-sillygoose { background-color: #f0f8ff; color: #4b0082; }
    body.theme-sillygoose .table { color: #2e8b57; }
    body.theme-sillygoose .table-dark { background-color: #ffdab9; color: #8b4513; }
    body.theme-sillygoose .tab-card { background: #e6e6fa; border-color: #ff69b4; box-shadow: 0 6px 18px rgba(255,20,147,.2); }
    body.theme-sillygoose .modal-content { background-color: #fafad2; color: #ff4500; }
    body.theme-sillygoose { color: #4b0082; animation: silly-bg-shift 25s linear infinite; }
    body.theme-sillygoose .display-1 { animation: silly-rainbow-text 6s linear infinite; }
    body.theme-sillygoose .tab-card {
      background: #e6e6fa; border: 2px solid;
      animation: silly-rainbow-text 8s linear infinite reverse;
      box-shadow: 0 6px 18px rgba(255,20,147,.2);
    }
    body.theme-sillygoose .tab-card:hover { animation: silly-wobble 0.4s ease-in-out infinite; }
    body.theme-sillygoose .table { color: #2e8b57; border-color: #ff69b4; }
    body.theme-sillygoose .table-dark { background-color: #ffdab9; color: #8b4513; border-color: #ffb469; }
    body.theme-sillygoose .table tbody tr:nth-child(6n+1) { background-color: rgba(255, 105, 180, 0.15); } /* Pink */
    body.theme-sillygoose .table tbody tr:nth-child(6n+2) { background-color: rgba(255, 165, 0, 0.15); } /* Orange */
    body.theme-sillygoose .table tbody tr:nth-child(6n+3) { background-color: rgba(255, 255, 0, 0.15); } /* Yellow */
    body.theme-sillygoose .table tbody tr:nth-child(6n+4) { background-color: rgba(0, 255, 0, 0.15); }   /* Green */
    body.theme-sillygoose .table tbody tr:nth-child(6n+5) { background-color: rgba(0, 191, 255, 0.15); } /* Blue */
    body.theme-sillygoose .table tbody tr:nth-child(6n+6) { background-color: rgba(148, 0, 211, 0.15); } /* Violet */
    body.theme-sillygoose .modal-content { background-color: #fafad2; color: #ff4500; border: 2px solid #ff4500; }
    body.theme-sillygoose .jalopy-subtab-btn { border-color: #00ced1; color: #00008b; }
    body.theme-sillygoose .jalopy-subtab-btn.active { background: #ff1493; color: #fff; border-color: #ff1493; }
    body.dark-mode { background-color:#121212; color:#f1f1f1; }
    body.dark-mode .table { color:#f1f1f1; }
    body.dark-mode .table-dark { background-color:#2c2c2c; }
    body.dark-mode .small, body.dark-mode .small a { color:#f0f0f0 !important; }

    th { cursor:pointer; }
    .display-1:hover { color:orange; cursor:pointer; }
    .btn.disabled-look { opacity:.5; cursor:not-allowed; }

    /* Hover highlight */
    #inventoryTable tbody tr:hover td,
    #trustyTable tbody tr:hover td { background-color:orange !important; color:#000; }
    body:not(.theme-sillygoose) #inventoryTable tbody tr:hover td,
    body:not(.theme-sillygoose) #trustyTable tbody tr:hover td { background-color:orange !important; color:#000; }

    /* Dark-mode styling for modals */
    .dark-mode .modal-content,
    .dark-mode .modal-content .modal-header,
    .dark-mode .modal-content .modal-body,
    .dark-mode .modal-content .modal-footer {
      background-color:#2c2c2c; color:#f1f1f1;
    }

    /* Nav active text orange */
    .nav-tabs .nav-link.active, .nav-pills .nav-link.active { color:orange !important; }
    body:not(.theme-sillygoose) .nav-tabs .nav-link.active, body:not(.theme-sillygoose) .nav-pills .nav-link.active { color:orange !important; }
    body.theme-sillygoose .nav-tabs .nav-link.active, body.theme-sillygoose .nav-pills .nav-link.active { color: #ff1493 !important; }

    /* QR code container needs a white background regardless of theme */
    #qrCodeContainer { background: #fff !important; }

    /* ---------- App lock / blur ---------- */
    .serial-locked #appRoot { filter: blur(6px); pointer-events: none; user-select: none; }
    .serial-locked .modal { pointer-events: auto; }
    .force-show-modal .modal { display:block !important; opacity:1 !important; }
    .force-show-modal .modal-backdrop { display:block !important; opacity:.45 !important; }

    /* Login modal look */
    #serialGate .modal-content { border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,.35); }
    #serialGateBrand { font-weight: 800; letter-spacing: .5px; }

    .btn-premium { background-color:gold !important; border-color:goldenrod !important; color:#000 !important; }

    /* Small polish */
    .tab-card {
      background:#fff; border-radius:16px; border:1px solid rgba(0,0,0,.06);
      box-shadow:0 8px 24px rgba(0,0,0,.06); padding:16px;
    }
    .dark-mode .tab-card { background:#1b1b1b; border-color:#2a2a2a; box-shadow:none; }
    .table thead th { position: sticky; top: 0; z-index: 2; }
    .table-hover tbody tr { transition: transform .08s ease, box-shadow .12s ease; }
    .table-hover tbody tr:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,.06); }

    /* ---------- Sticky Notes ---------- */
    .sticky-note {
      position: fixed; /* viewport-level so they float over tabs */
      top: 120px; left: 120px;
      width: 220px; min-width: 160px; min-height: 120px;
      background: #fffbe6;
      border: 1px solid #e5d47b;
      border-radius: 10px;
      box-shadow: 0 10px 26px rgba(0,0,0,.15);
      display: flex; flex-direction: column;
      resize: both; overflow: hidden;
      z-index: 2000;
    }
    .sticky-note .sticky-header {
      display:flex; align-items:center; justify-content:space-between;
      gap:.5rem;
      padding: .35rem .5rem;
      background: rgba(0,0,0,.04);
      border-bottom: 1px solid rgba(0,0,0,.06);
      cursor: move;
      user-select:none;
    }
    .sticky-note .sticky-title {
      font-size: .9rem; font-weight:600; color:#444; margin:0;
    }
    .sticky-note .sticky-actions .btn {
      --bs-btn-padding-y: .1rem;
      --bs-btn-padding-x: .3rem;
      --bs-btn-font-size: .8rem;
    }
    .sticky-note .sticky-body {
      padding: .5rem .6rem .8rem .6rem;
      flex:1; overflow:auto;
    }
    .sticky-note .sticky-body[contenteditable="true"]:focus {
      outline: none;
    }
    .sticky-color {
      width: 14px; height: 14px; border-radius: 3px; display:inline-block; border:1px solid rgba(0,0,0,.2);
    }
    /* color themes */
    .sticky-note.yellow { background:#fffbe6; border-color:#e5d47b; }
    .sticky-note.blue   { background:#eaf3ff; border-color:#93b7f0; }
    .sticky-note.pink   { background:#ffeaf2; border-color:#f59bb5; }
    .sticky-note.green  { background:#e9ffe8; border-color:#98d79b; }

    /* dark mode tweaks */
    .dark-mode .sticky-note {
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border-color: rgba(255,255,255,.15);
    }
    .dark-mode .sticky-note .sticky-header { background: rgba(255,255,255,.06); border-bottom-color: rgba(255,255,255,.08); }
    .dark-mode .sticky-note .sticky-title { color:#e8e8e8; }

    /* FAB group (Add Sticky) */
    #stickyFab {
      position: fixed; right: 16px; bottom: 16px; z-index: 2100;
      display: none; gap: .5rem; flex-direction: column;
    }
	
	/* Trends: clickable headers + little caret */
#trendsTable thead th { cursor: pointer; user-select: none; }
#trendsTable thead th .sort-caret { margin-left:.35rem; opacity:.7; }

/* ===== Pick List: Clean Card Print (Tight top space) ===== */

/* On-screen preview toggle (shown only while printing is triggered) */
body.printing #pickListPrintRoot { display: block; }

/* Optional: keep the print root hidden during normal browsing */
#pickListPrintRoot { display: none; }

@media print {
  /* Hide everything except the print document */
  body * { visibility: hidden !important; }
  #pickListPrintRoot, #pickListPrintRoot * { visibility: visible !important; }
  #pickListPrintRoot { position: relative !important; display: block !important; }

  /* Force white background & crisp colors */
  html, body {
    background: #fff !important; color: #000 !important;
    -webkit-print-color-adjust: exact; print-color-adjust: exact;
  }

  /* LETTER portrait with tight top margin (reduce white space above) */
  @page { size: Letter portrait; margin: 6mm 8mm 8mm 8mm; }

  /* ===== Repeating Header / Footer ===== */
  .pl-header {
    position: fixed; top: 0; left: 0; right: 0;
    display: flex; align-items: center; gap: 10px;
    padding: 2mm 0 1.5mm;
    border-bottom: 0.2mm solid #d0d0d0;
    font: 600 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .pl-header img { max-height: 18px; width: auto; object-fit: contain; }
  .pl-header .brand { font-weight: 800; font-size: 11px; }
  .pl-header .meta  { margin-left: auto; font-weight: 500; font-size: 10px; color: #444; }

  .pl-footer {
    position: fixed; bottom: 0; left: 0; right: 0;
    padding: 3mm 0;
    border-top: 0.2mm solid #d0d0d0;
    font: 10px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: #555;
  }
  .pl-footer .right { float: right; }
  .pl-footer .pageno::after { content: "Page " counter(page) " of " counter(pages); }

  /* Body: only as much top/bottom offset as header/footer need */
  .pl-body { padding-top: 22mm; padding-bottom: 10mm; }

  /* ===== Yard Sections ===== */
  .pl-section { page-break-after: always; }
  .pl-section:last-child { page-break-after: auto; }
  .pl-section:last-of-type { page-break-after: auto; }
  .pl-section .pl-title {
    font: 700 14px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 0 0 6px 0; page-break-before: avoid;
  }
  .pl-section .pl-sub {
    font: 11px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: #666; margin: 0 0 8px 0;
  }

  /* ===== Two-column Card Grid (compact) ===== */
  .pl-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 7mm 7mm; /* row gap / column gap */
  }

  /* ===== Vehicle Card ===== */
  .pl-card {
    border: 0.3mm solid #000;
    border-radius: 2mm;
    padding: 4mm;
    page-break-inside: avoid;
    display: flex; flex-direction: column; gap: 2.5mm;
  }

  .pl-top {
    display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
  }
  .pl-row-badge {
    font: 800 12px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: #000; color: #fff;
    padding: 2px 8px; border-radius: 10px; letter-spacing: .2px;
  }
  .pl-yard-pill {
    font: 600 11px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: #000; border: 0.3mm solid #000; border-radius: 999px;
    padding: 1px 8px; margin-left: auto;
  }

  .pl-titleline {
    display: flex; align-items: baseline; gap: 6px; flex-wrap: wrap;
  }
  .pl-year  { font: 800 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .pl-make  { font: 800 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .pl-model { font: 600 14px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

  .pl-notes { font: 11px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #333; }
  .pl-notes .label { font-weight: 700; margin-right: 4px; }

  .pl-checks {
    display: flex; flex-wrap: wrap; gap: 10px 14px; align-items: center;
    font: 11px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .pl-box  { display: inline-block; width: 12px; height: 12px; border: 2px solid #000; margin-right: 6px; vertical-align: -2px; }
  .pl-line { border-bottom: 1px dashed #000; display: inline-block; min-width: 42mm; height: 0; transform: translateY(-2px); }
  .pl-line.sm { min-width: 22mm; }

  /* Optional: mini metadata row under title, if used */
  .pl-meta { font: 10px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #555; }
}


  </style>
</head>

<body class="serial-locked"><!-- start locked -->

  <!-- ====== GATE / LOGIN MODAL ====== -->
  <div class="modal fade" id="serialGate" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3 p-md-4">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title" id="serialGateBrand">PROFIT Access</h5>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">Enter your serial key and email to unlock all features.</p>
          <div class="mb-2">
            <label class="form-label">Serial Key</label>
            <input id="serialInput" class="form-control form-control-lg" placeholder="e.g. ABC-123-XYZ">
          </div>
          <div class="mb-2">
            <label class="form-label">Email</label>
            <input id="emailInput" type="email" class="form-control form-control-lg" placeholder="you@example.com">
          </div>
          <div id="serialFeedback" class="text-danger small mt-1" style="display:none;">Invalid serial key or missing email.</div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button class="btn btn-primary w-100" id="submitSerial">Unlock</button>
        </div>
        <div class="text-center text-muted small mt-2">
          Need help? Contact <a href="https://carsandcollectibles.com" target="_blank">Cars &amp; Collectibles LLC</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== APP ROOT (blurred while locked) ====== -->
  <div id="appRoot">
    <div class="container py-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4 tab-card">
        <div>
          <div class="display-1 mb-1">PROFIT</div>
          <div class="h5">Parts Resale Optimization &amp; Field Inventory Tool</div>
          <div class="small">Cars and Collectibles LLC â€¢ <a href="https://carsandcollectibles.com" target="_blank">carsandcollectibles.com</a></div>
          <div class="small text-muted" id="signedInEmail" style="display:none;">Signed in as: <span id="signedInEmailValue"></span></div>
        </div>
        <div class="text-end">
          <div id="currentThemeDisplay" class="small text-muted mb-1"></div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" id="settingsBtn"><i class="bi bi-gear"></i> Settings</button>
            <button class="btn btn-outline-primary" id="addStickyBtn" title="Add Sticky (Shift+N)">
              <i class="bi bi-sticky"></i> Add Sticky
            </button>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#homeTab" type="button">Home</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#jalopyTab" type="button">Jalopy Jungle</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#trustyTab" type="button">Trusty</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pickListTab" type="button">Pick List</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#favoritesTab" type="button">Favorites</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#alertsTab" type="button">Alerts</button>
        </li>
		<li class="nav-item">
			<button class="nav-link" data-bs-toggle="tab" data-bs-target="#trendsTab" type="button">Trends</button>
		</li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#qrSyncTab" type="button">QR Sync</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#whatsNewTab" type="button">
            What's New
            <span id="newVehicleCountBadge" class="badge bg-danger ms-1" style="display:none;"></span>
          </button>
        </li>


      </ul>

      <!-- Vehicle Info Modal (from Wikipedia) - MOVED HERE -->
      <div class="modal fade" id="vehicleInfoModal" tabindex="-1" aria-labelledby="vehicleInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="vehicleInfoModalLabel">Vehicle Information</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="vehicleInfoContent"><div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Fetching data from Wikipedia...</p></div></div>
          </div>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="tab-content pt-3">
        <!-- Home Tab -->
        <div class="tab-pane fade show active" id="homeTab">
          <div class="tab-card">
            <h5 class="mb-1">Featured Vehicles</h5>
            <div id="featuredVehiclesContainer" class="row g-4">
              <!-- Featured vehicle cards will be injected here by JS -->
              <div class="col-12 text-center text-muted p-5">
                <div class="spinner-border spinner-border-sm" role="status"></div>
                <span class="ms-2">Loading featured vehicles...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Jalopy -->
        <div class="tab-pane fade" id="jalopyTab">
  <div class="tab-card">

    <!-- Jalopy subtabs -->
    <div class="jalopy-subtab-bar">
      <button
        type="button"
        class="jalopy-subtab-btn active"
        data-jalopy-subtab="jalopyInventorySubtab">
        Inventory
      </button>
      <button
        type="button"
        class="jalopy-subtab-btn"
        data-jalopy-subtab="jalopyPricingSubtab">
        Pricing
      </button>
    </div>

    <!-- INVENTORY SUBTAB: existing Jalopy content moved here -->
    <div id="jalopyInventorySubtab" class="jalopy-subtab" style="">
      <div class="mb-3">
        <select class="form-select" id="csvSelector"></select>
      </div>
      <div class="mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Filter rows...">
      </div>
      <div class="mb-3">
        <button class="btn btn-success" id="exportBtn">
          <i class="bi bi-download"></i> Export Table to CSV
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover" id="inventoryTable">
          <thead class="table-dark"><tr id="tableHeader"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div id="statistics" class="mt-3 small"></div>
      <canvas id="ageChart" style="max-width:100%; margin-top:1em;"></canvas>
    </div>

<!-- PRICING SUBTAB -->
<div id="jalopyPricingSubtab" class="jalopy-subtab" style="display:none;">
  <div class="mb-2 d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Jalopy Jungle Pricing</h5>
    <small class="text-muted">Source: <code>pricing/jalopy-prices.csv</code></small>
  </div>

  <!-- Filters / Search -->
  <div class="row g-2 mb-3">
    <div class="col-md-4">
      <label class="form-label mb-1">Section</label>
      <select id="pricingSectionFilter" class="form-select form-select-sm">
        <option value="">All sections</option>
        <!-- options populated by JS -->
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label mb-1">AS IS</label>
      <select id="pricingAsIsFilter" class="form-select form-select-sm">
        <option value="">Any</option>
        <option value="true">AS IS only</option>
        <option value="false">Non-AS-IS</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label mb-1">Search</label>
      <input
        id="pricingSearch"
        class="form-control form-control-sm"
        placeholder="Search section, part, priceâ€¦">
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered table-hover" id="jalopyPricingTable">
      <thead class="table-dark">
        <tr>
          <th data-pricing-col="section">Section</th>
          <th data-pricing-col="part">Part</th>
          <th data-pricing-col="asIsBool">AS IS</th>
          <th data-pricing-col="carPriceNum">Car Price</th>
          <th data-pricing-col="vanPriceNum">Van/SUV/Truck Price</th>
          <th data-pricing-col="coreNum">Core</th>
          <th data-pricing-col="pick">Pick</th>
        </tr>
      </thead>
      <tbody id="jalopyPricingBody"></tbody>
    </table>
  </div>
</div>


  </div>
</div>


        <!-- Trusty -->
        <div class="tab-pane fade" id="trustyTab">
          <div class="tab-card">
            <div class="mb-3">
              <select class="form-select" id="trustySelector"></select>
            </div>
            <div class="mb-3">
              <input type="text" id="trustySearchInput" class="form-control" placeholder="Filter rows...">
            </div>
            <div class="mb-3">
              <button class="btn btn-success" id="trustyExportBtn"><i class="bi bi-download"></i> Export Table to CSV</button>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover" id="trustyTable">
                <thead class="table-dark"><tr id="trustyTableHeader"></tr></thead>
                <tbody id="trustyTableBody"></tbody>
              </table>
            </div>

            <div id="trustyStatistics" class="mt-3 small"></div>
            <canvas id="trustyAgeChart" style="max-width:100%; margin-top:1em;"></canvas>
          </div>
        </div>

        <!-- Pick List -->
        <div class="tab-pane fade" id="pickListTab">
          <div class="tab-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <button class="btn btn-success" id="exportPickListBtn"><i class="bi bi-box-arrow-down"></i> Export Table to CSV</button>
                <button class="btn btn-outline-secondary ms-2" id="printPickListBtn"><i class="bi bi-printer"></i> Print Pick List</button>
              </div>
              <div id="pickListGrandTotal" class="text-end">
                <!-- Grand total will be injected here -->
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover" id="pickListTable">
                <thead class="table-dark">
                  <tr>
                    <th>Year</th>
                    <th>Make</th>
                    <th>Model</th>
                    <th>Row</th>
                    <th>Yard</th>
                    <th>Notes</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody id="pickListBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Favorites Tab -->
        <div class="tab-pane fade" id="favoritesTab">
          <div class="tab-card">
            <h5 class="mb-1">Favorite Vehicles</h5>
            <p class="text-muted mb-3">Add vehicles you are always looking for. New arrivals that match these will be highlighted in the "What's New" tab.</p>
            
            <div class="row g-2 align-items-end mb-3">
              <div class="col"><label class="form-label">Year / Range</label><input id="favYearInput" type="text" class="form-control" placeholder="e.g., 1997 or 99-04"/></div>
              <div class="col"><label class="form-label">Make</label><input id="favMakeInput" type="text" class="form-control" placeholder="e.g., Ford"/></div>
              <div class="col"><label class="form-label">Model</label><input id="favModelInput" type="text" class="form-control" placeholder="e.g., Thunderbird"/></div>
              <div class="col-auto"><button class="btn btn-primary" id="addFavVehicleBtn">Add Favorite</button></div>
            </div>

            <h6>Your Favorites List</h6>
            <ul id="favVehiclesList" class="list-group list-group-flush mt-2">
              <!-- Favorite vehicles will be rendered here by JS -->
            </ul>
          </div>
        </div>

        <!-- Alerts -->
        <div class="tab-pane fade" id="alertsTab">
          <div class="tab-card">
            <h5 class="mb-1">Vehicle Alert Signup</h5>
            <p class="text-muted mb-3">Receive notifications when vehicles matching your criteria are added at Jalopy Jungle or Trusty.</p>

            <form id="alertForm" class="row g-3">
              <!-- Email field removed: will be auto-inserted from serial sign-in -->
              <div class="col-md-6">
                <label class="form-label">Make(s)</label>
                <input type="text" name="makes" class="form-control" placeholder="e.g., Ford"/>
              </div>

              <div class="col-md-6">
                <label class="form-label">Model(s)</label>
                <input type="text" name="models" class="form-control" placeholder="e.g., Thunderbird"/>
              </div>

              <div class="col-md-6">
                <label class="form-label">Year Range</label>
                <input type="text" name="years" class="form-control" placeholder="e.g., 1994-1997"/>
              </div>

              <div class="col-md-6">
                <label class="form-label">Preferred Yard</label>
                <select name="yards" class="form-select">
                  <option value="">Any</option>
                  <option>Jalopy Jungle (Boise)</option>
                  <option>Jalopy Jungle (Nampa)</option>
                  <option>Jalopy Jungle (Caldwell)</option>
                  <option>Jalopy Jungle (Garden City)</option>
                  <option>Jalopy Jungle (Twin Falls)</option>
                  <option>Trusty Pick-A-Part</option>
                </select>
              </div>

              <div class="col-12">
                <button type="submit" class="btn btn-success w-100">Submit Alert</button>
              </div>
            </form>

            <p id="statusMsg" class="text-center mt-2 small text-muted"></p>
          </div>
        </div>
		
		<!-- Trends -->
<div class="tab-pane fade" id="trendsTab">
  <div class="tab-card">
    <div class="d-flex flex-wrap gap-2 align-items-end mb-3">
      <div>
        <label class="form-label mb-1">Time Window</label>
        <select id="trendsWindow" class="form-select form-select-sm" style="width:140px">
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
      </div>
      <div>
        <label class="form-label mb-1">Min Sales</label>
        <input id="trendsMinCount" type="number" class="form-control form-control-sm" value="3" min="1" style="width:100px"/>
      </div>
      <div class="ms-auto">
        <button id="refreshTrendsBtn" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-arrow-repeat"></i> Refresh Trends
        </button>
      </div>
	  <div>
  <label class="form-label mb-1">Yard</label>
  <select id="trendsYard" class="form-select form-select-sm" style="width:200px">
    <option value="auto" selected>Auto (follow Jalopy)</option>
    <option value="all">All yards</option>
    <option value="vehicles_of_interest">Vehicles of Interest</option>
    <option value="boise">Boise</option>
    <option value="caldwell">Caldwell</option>
    <option value="garden_city">Garden City</option>
    <option value="nampa">Nampa</option>
    <option value="twin_falls">Twin Falls</option>
  </select>
</div>
      <div>
        <label class="form-label mb-1">Search</label>
        <input id="trendsSearch" class="form-control form-control-sm"
               placeholder="year, make, model, or search term">
      </div>


    </div>
	
	<!-- Heatmap (Make Ã— Year) -->
<div id="trendsHeatmapBox" class="mb-3">
  <div class="d-flex justify-content-between align-items-center mb-1">
    <strong>Heatmap â€” Sales Count by Make Ã— Year</strong>
    <small id="trendsHeatmapNote" class="text-muted"></small>
  </div>
  <canvas id="trendsHeatmapCanvas" height="260"></canvas>
</div>


    <div class="table-responsive" id="trendsScroll" style="max-height:60vh; overflow:auto;">
<!-- inside #trendsTab -->
<table class="table table-striped table-bordered table-hover" id="trendsTable">
  <thead class="table-dark">
    <tr>
      <th>Year</th>
	  <th>Make</th>
	  <th>Model</th>
      <th>Search Term</th>
      <th>Listing Title</th>
      <th>Last Sold Price</th>
      <th>Date Sold</th>
      <th>Time To Sell</th>
      <th>Total Sold</th>
    </tr>
  </thead>
  <tbody id="trendsTableBody"></tbody>
</table>

<div class="small text-muted mt-2" id="trendsSummary"></div>

    </div>

  </div>
</div>

        <!-- QR Sync Tab -->
        <div class="tab-pane fade" id="qrSyncTab">
          <div class="tab-card">
            <h5 class="mb-1">Data Sync via QR Code</h5>
            <p class="text-muted mb-4">Easily transfer your Pick List, Favorites, and Settings between devices.</p>

            <div class="row g-4">
              <!-- Generate QR -->
              <div class="col-md-6">
                <h6>1. Generate QR Code from this device</h6>
                <p class="small">Click the button to generate a QR code containing all your current data. Scan this code on your other device.</p>
                <button class="btn btn-primary" id="generateQrBtn"><i class="bi bi-arrow-repeat"></i> Refresh QR Code</button>                
                <div id="qrCodeContainer" class="mt-3 text-center p-3 border rounded" style="min-height: 284px;"></div>
              </div>

              <!-- Scan QR -->
              <div class="col-md-6">
                <h6>2. Scan QR Code on this device</h6>
                <p class="small">Click to start your camera, then point it at the QR code generated from your other device to import its data.</p>
                <div id="qrScannerContainer" style="max-width: 500px;"></div>
                <div id="qrScanStatus" class="small text-muted mt-2"></div>
              </div>
            </div>
          </div>
        </div>

                <!-- What's New Tab -->
        <div class="tab-pane fade" id="whatsNewTab">
          <div class="tab-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="mb-0">What's New Today</h5>
                <p class="text-muted small mb-0">This report shows vehicles added since the last time you viewed each inventory list. Vehicles matching items in your Pick List are highlighted in yellow.</p>
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="rerunNewVehicleAnalysisBtn" title="Clears the 'viewed' status and re-runs the comparison for testing.">
                <i class="bi bi-arrow-clockwise"></i> Re-run Analysis
              </button>
            </div>
            <hr>
            <div id="newVehiclesReport">
              <!-- Report content will be generated here -->
            </div>
          </div>
        </div>

		
      </div>
    </div>

    <!-- Export Pick List Modal -->
    <div class="modal fade" id="exportPickListModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Export Pick List</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="pickExportMode" id="exportAsIs" value="asis" checked>
              <label class="form-check-label" for="exportAsIs">
                Export the table as it is (current order)
              </label>
            </div>

            <div class="form-check mb-3">
              <input class="form-check-input" type="radio" name="pickExportMode" id="exportGrouped" value="grouped">
              <label class="form-check-label" for="exportGrouped">
                Export with vehicles grouped by Yard
              </label>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="radio" name="pickExportMode" id="exportSingleYard" value="single">
              <label class="form-check-label" for="exportSingleYard">
                Export only a single Yard
              </label>
            </div>

            <div class="mt-2">
              <select id="singleYardSelect" class="form-select" disabled>
                <option value="">Select Yardâ€¦</option>
              </select>
            </div>

            <div class="small text-muted mt-3">
              CSV columns vary by export type. "Export by Part" is recommended for data analysis.
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-success" id="confirmExportPick">Export</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="homeYardSelect" class="form-label">Home Yard</label>
              <select id="homeYardSelect" class="form-select">
                <option value="">-- select yard --</option>
                <option>Boise</option>
                <option>Caldwell</option>
                <option>Garden City</option>
                <option>Nampa</option>
                <option>Twin Falls</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="themeSelect" class="form-label">Theme</label>
              <select id="themeSelect" class="form-select">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
                <option value="slate">Slate</option>
                <option value="sunrise">Sunrise</option>
                <option value="paper">Paper</option>
                <option value="ocean">Ocean</option>
                <option value="forest">Forest</option>
                <option value="crimson">Crimson</option>
                <option value="nord">Nord</option>
                <option value="dracula">Dracula</option>
                <option value="gruvbox">Gruvbox</option>
                <option value="latte">Latte</option>
                <option value="mint">Mint</option>
                <option value="sillygoose">Silly Goose</option>
              </select>
            </div>

            <!-- Data code sync -->
            <hr>
            <button class="btn btn-outline-primary w-100 mb-2" id="exportDataBtn">ðŸ“‹ Copy Data Code</button>
            <textarea id="dataCodeOutput" class="form-control mb-2" rows="3" readonly placeholder="Your data code will appear hereâ€¦"></textarea>
            <label for="dataCodeInput" class="form-label">Paste Data Code to Sync:</label>
            <textarea id="dataCodeInput" class="form-control mb-2" rows="3" placeholder="Paste someoneâ€™s data code hereâ€¦"></textarea>
            <button class="btn btn-primary w-100" id="importDataBtn">ðŸ”„ Import Data Code</button>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-primary" id="saveSettings">Save Settings</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Note</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea id="noteInput" class="form-control" rows="4" placeholder="Enter your note here..."></textarea>
            <div id="noteLimitInfo" class="text-muted mt-2" style="display:none;">Notes are limited to 20 characters. Upgrade to premium for unlimited characters.</div>
            <div id="noteLengthFeedback" class="text-danger mt-2" style="display:none;">Max 20 characters for non-premium users.</div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-danger" id="clearNote">Clear Note</button>
            <button class="btn btn-primary" id="saveNote">Save Note</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Part to Pick List Modal -->
    <div class="modal fade" id="addPartToPickModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Part to Pick List</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Select a vehicle from your pick list to add this part to:</p>
            <p class="mb-2"><strong>Part:</strong> <span id="partToPickName" class="fw-bold"></span></p>
            <div id="pickListForPart" class="list-group">
              <!-- Pick list vehicles will be rendered here -->
            </div>
            <div id="pickListForPartEmpty" class="text-muted text-center p-3" style="display:none;">Your pick list is empty.</div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-primary" id="confirmAddPartToPick">Add Part</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Parts to Vehicle from Pick List Modal -->
    <div class="modal fade" id="addPartsFromPickListModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Parts to Vehicle</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>Vehicle:</strong> <span id="vehicleForPartsName" class="fw-bold"></span></p>
            <p class="text-muted small mb-3">Select parts from the pricing list below to add to this vehicle.</p>

            <!-- Pricing table UI for the modal -->
            <div class="row g-2 mb-3">
              <div class="col-md-4">
                <label class="form-label mb-1">Section</label>
                <select id="modalPricingSectionFilter" class="form-select form-select-sm"></select>
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">AS IS</label>
                <select id="modalPricingAsIsFilter" class="form-select form-select-sm">
                  <option value="">Any</option><option value="true">AS IS only</option><option value="false">Non-AS-IS</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">Search</label>
                <input id="modalPricingSearch" class="form-control form-control-sm" placeholder="Search section, part, priceâ€¦">
              </div>
            </div>
            <div class="table-responsive" style="max-height: 50vh;">
              <table class="table table-striped table-bordered table-hover table-sm" id="modalJalopyPricingTable">
                <thead class="table-dark"></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-primary" id="confirmAddPartsFromPickList">Add Selected Parts</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sold Data Modal -->
    <div class="modal fade" id="soldModal" tabindex="-1" aria-labelledby="soldModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="soldModalLabel">Sold Data</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="soldDataContainer">
              <table class="table table-striped table-bordered">
                <thead class="table-dark">
                  <tr>
                    <th>Search Term</th>
                    <th>Listing Title</th>
                    <th>Last Sold Price</th>
                    <th>Date Sold</th>
                    <th>Time To Sell</th>
                    <th>Total Sold</th>
                  </tr>
                </thead>
                <tbody id="soldDataBody"></tbody>
              </table>
            </div>
            <div id="soldDataEmpty" class="text-center text-muted" style="display:none;">
              No sold data found for this vehicle.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast container for favorite-vehicle alerts -->
    <div id="favToastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>
  </div><!-- /#appRoot -->

  <!-- Sticky FAB -->
  <div id="stickyFab" aria-hidden="true">
    <button class="btn btn-primary rounded-circle" id="fabAddSticky" title="Add Sticky (Shift+N)">
      <i class="bi bi-plus-lg"></i>
    </button>
    <button class="btn btn-outline-danger rounded-circle" id="fabClearStickies" title="Clear All Stickies">
      <i class="bi bi-trash"></i>
    </button>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /***********************
   * Premium / Serial Gate
   ***********************/
  let isPremium = false, premiumName = '';
  let serialData = []; // from json/serial-keys.json

  function getGateInstance() {
    return bootstrap.Modal.getOrCreateInstance(
      document.getElementById('serialGate'),
      { backdrop:'static', keyboard:false }
    );
  }
  function showGate() {
    document.body.classList.add('serial-locked');
    try {
      const inst = getGateInstance();
      inst.show();
      document.getElementById('serialGate')
        .addEventListener('shown.bs.modal', () => {
          const input = document.getElementById('serialInput');
          if (input) input.focus();
          // prefill saved values if any
          const savedKey = localStorage.getItem('premiumKey') || '';
          const savedEmail = localStorage.getItem('premiumEmail') || '';
          if (savedKey) document.getElementById('serialInput').value = savedKey;
          if (savedEmail) document.getElementById('emailInput').value = savedEmail;
        }, { once:true });
      setTimeout(() => {
        const gateEl = document.getElementById('serialGate');
        if (!gateEl.classList.contains('show')) {
          document.body.classList.add('force-show-modal');
        }
      }, 100);
    } catch {
      document.body.classList.add('force-show-modal');
    }
  }
  function unlockApp(name) {
    isPremium = true; premiumName = name || '';
    document.body.classList.remove('serial-locked','force-show-modal');
    const inst = bootstrap.Modal.getInstance(document.getElementById('serialGate'));
    if (inst) inst.hide();
    updateSignedInEmailUI();
    initApp();
  }
  async function validateStoredKey() {
    try {
      const r = await fetch('json/serial-keys.json');
      serialData = await r.json();
    } catch (e) {
      console.warn('Could not load serial-keys.json:', e);
      serialData = [];
    }
    const savedKey = localStorage.getItem('premiumKey');
    const savedEmail = localStorage.getItem('premiumEmail');
    const entry = serialData.find(e => e.key === savedKey);
    if (entry && savedEmail) { unlockApp(entry.name); } else { showGate(); }

    const submitBtn = document.getElementById('submitSerial');
    const keyInput   = document.getElementById('serialInput');
    const emailInput = document.getElementById('emailInput');
    submitBtn.onclick = () => {
      const key = keyInput.value.trim();
      const email = emailInput.value.trim();
      const match = serialData.find(e => e.key === key);
      if (match && email) {
        localStorage.setItem('premiumKey', key);
        localStorage.setItem('premiumEmail', email);
        document.getElementById('serialFeedback').style.display = 'none';
        unlockApp(match.name);
      } else {
        document.getElementById('serialFeedback').style.display = 'block';
      }
    };
    // Enter to submit
    [keyInput, emailInput].forEach(el => {
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); submitBtn.click(); }
      });
    });
  }

  function updateSignedInEmailUI() {
    const email = localStorage.getItem('premiumEmail') || '';
    const wrap = document.getElementById('signedInEmail');
    const val  = document.getElementById('signedInEmailValue');
    if (email && wrap && val) {
      val.textContent = email;
      wrap.style.display = '';
    } else if (wrap) {
      wrap.style.display = 'none';
    }
  }

  /***********************
   * Utility Functions
   ***********************/
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => { clearTimeout(timeout); func(...args); };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // New enhanced search logic (moved to global scope)
  function enhancedSearch(query, data) {
    const q = query.toLowerCase().trim();
    const yearRangeRegex = /\b(\d{2,4})-(\d{2,4})\b/;
    const singleYearRegex = /\b(\d{4})\b/;
    const singleTwoDigitYearRegex = /\b(\d{2})\b/;

    let yearRange = q.match(yearRangeRegex);
    let singleYear = !yearRange ? q.match(singleYearRegex) : null;
    let singleTwoDigitYear = !yearRange && !singleYear ? q.match(singleTwoDigitYearRegex) : null;

    let startYear, endYear;
    let remainingQuery = q;

    const parseYear = (yrStr) => {
      let year = parseInt(yrStr, 10);
      if (yrStr.length === 2) {
        year += (year > 50 ? 1900 : 2000); // YY to YYYY conversion
      }
      return year;
    };

    if (yearRange) {
      startYear = parseYear(yearRange[1]);
      endYear = parseYear(yearRange[2]);
      remainingQuery = q.replace(yearRange[0], '').trim();
    } else if (singleYear) {
      startYear = endYear = parseYear(singleYear[0]);
      remainingQuery = q.replace(singleYear[0], '').trim();
    } else if (singleTwoDigitYear) {
      startYear = endYear = parseYear(singleTwoDigitYear[0]);
      remainingQuery = q.replace(singleTwoDigitYear[0], '').trim();
    }

    return data.filter(r => {
      const vehicleYear = parseInt(r.Year, 10);
      const yearMatch = !startYear || (vehicleYear >= startYear && vehicleYear <= endYear);
      const textMatch = !remainingQuery || Object.values(r).some(v => String(v).toLowerCase().includes(remainingQuery));
      return yearMatch && textMatch;
    });
  }

  // Renamed for clarity and moved to global scope
  function trustyEnhancedSearch(query, data) {
    // This function is identical to enhancedSearch, so we can just reuse it.
    // If they ever diverge, the logic can be different here.
    return enhancedSearch(query, data);
  }

  /***********************
   * App state & helpers
   ***********************/
  const PREV_YARD_INV_KEY = 'previousYardInventories';
  const PREV_INV_KEY = 'prevInventorySnapshot';
  const FAV_KEY = 'favoriteVehicles';
  const PREV_KEY = 'prevFavoriteSnapshot';

  const LOCATION_KEYS  = ['boise','caldwell','garden_city','nampa','twin_falls'];
  const LOCATION_NAMES = { boise:'Boise', caldwell:'Caldwell', garden_city:'Garden City', nampa:'Nampa', twin_falls:'Twin Falls' };

  let notes = {};
  let selectedRowKey = null;
  let currentData = [];     // Jalopy current
  let sortDirection = {};
  let ageChart = null;

  let trustyData = [];      // Trusty current
  let trustySortDirection = {};
  let trustyAgeChart = null;
  let isGrandTotalTaxExcluded = false;

  /* Utility to parse inventory filenames with both time separators:
     inventory_boise_2025-06-08_07-17-49.csv
     inventory_trusty_2025-08-25-07-20-23.csv */
  function parseStamp(filename, expectTrusty=false) {
    const base = String(filename).trim();
    const re = expectTrusty
      ? /^inventory_(.+?)_(\d{4}-\d{2}-\d{2})[_-](\d{2})[-_](\d{2})[-_](\d{2})\.csv$/i
      : /^inventory_(.+?)_(\d{4}-\d{2}-\d{2})[_-](\d{2})[-_](\d{2})[-_](\d{2})\.csv$/i;
    const m = base.match(re);
    if (!m) return null;
    const loc = m[1].toLowerCase();
    const dtKey = `${m[2].replaceAll('-','')}${m[3]}${m[4]}${m[5]}`;
    const dtDisplay = `${m[2]} ${m[3]}:${m[4]}:${m[5]}`;
    return { loc, dtKey, dtDisplay, filename: base };
  }

  function showFavToast(htmlContent) {
    const container = document.getElementById('favToastContainer');
    const toastEl = document.createElement('div');
    toastEl.className = 'toast'; toastEl.role = 'alert';
    toastEl.ariaLive = 'assertive'; toastEl.ariaAtomic = 'true';
    toastEl.innerHTML = `
      <div class="toast-header">
        <strong class="me-auto">ðŸš¨ New Favorite!</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body">${htmlContent}</div>`;
    container.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
    toast.show();
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
  }

  function checkNewFavoriteVehicles(data = window.currentData) {
    const favs = JSON.parse(localStorage.getItem(FAV_KEY) || '[]')
      .map(v => `${v.year.trim()} / ${v.make.trim()} / ${v.model.trim()}`);
    if (!favs.length) return;

    const todayLabels = Array.from(new Set(
      data.map(r => `${String(r.Year).trim()} / ${String(r.Make).trim()} / ${String(r.Model).trim()}`)
    ));
    const prevLabels = JSON.parse(localStorage.getItem(PREV_INV_KEY) || '[]');
    const newLabels  = todayLabels.filter(lbl => !prevLabels.includes(lbl));
    const hits = newLabels.filter(lbl => favs.includes(lbl));
    if (hits.length) showFavToast(hits.map(l => `â€¢ ${l}`).join('<br>'));
    localStorage.setItem(PREV_INV_KEY, JSON.stringify(todayLabels));
  }

  function applyHomeYardDefault() {
    const home = (localStorage.getItem('homeYard') || '').trim().toLowerCase().replace(/\s+/g,'_');
    if (!home) return;
    const selector = document.getElementById('csvSelector');
    const opt = selector.querySelector(`option[data-loc="${home}"]`);
    if (opt) { selector.value = opt.value; loadCSV(opt.value); }
  }

  /********* Jalopy listing *********/
  async function listCSVFiles() {
    const selector = document.getElementById('csvSelector');
    selector.innerHTML = '';
    try {
      const res = await fetch('./inventory-csvs/index.json', { cache:'no-store' });
      const files = await res.json();
      const latest = {};
      files.forEach(f => {
        const p = parseStamp(f, false);
        if (!p) return;
        if (!latest[p.loc] || p.dtKey > latest[p.loc].dtKey) latest[p.loc] = p;
      });

      LOCATION_KEYS.forEach(locKey => {
        const entry = latest[locKey];
        if (!entry) return;
        const opt = document.createElement('option');
        opt.value = 'inventory-csvs/' + entry.filename;
        opt.dataset.loc = locKey;
        opt.textContent = `${LOCATION_NAMES[locKey]} (${entry.dtDisplay})`;
        selector.appendChild(opt);
      });

      selector.onchange = (e) => {
        const locKey = e.target.selectedOptions[0].dataset.loc;
        localStorage.setItem('homeYard', locKey);
        loadCSV(e.target.value);
      };

      let savedHome = (localStorage.getItem('homeYard') || '').trim().toLowerCase().replace(/\s+/g,'_');
      const toSelect = selector.querySelector(`option[data-loc="${savedHome}"]`) || selector.options[0];
      if (toSelect) { selector.value = toSelect.value; loadCSV(toSelect.value); }
    } catch (err) {
      console.error('Error listing inventory CSVs (Jalopy):', err);
    }
  }

  function loadCSV(path) {
    document.getElementById('searchInput').value = '';
    const locKey = document.getElementById('csvSelector')?.selectedOptions?.[0]?.dataset?.loc;

    Papa.parse(path, {
      download:true, header:true,
      complete(r) {
        currentData = r.data.filter(row => row.Year && row.Make && row.Model && row.Row);
        checkNewFavoriteVehicles(currentData);
        if (locKey) processInventoryChanges(locKey, currentData, 'jalopy');
        renderTable(currentData);
        renderFeaturedVehicles(currentData);
        showStatistics(currentData);
      }
    });
  }

  async function renderFeaturedVehicles(data, count = 4) {
    const container = document.getElementById('featuredVehiclesContainer');
    if (!container) return;
  
    const selector = document.getElementById('csvSelector');
    const locKey = selector?.selectedOptions?.[0]?.dataset?.loc;
    const yardName = LOCATION_NAMES[locKey] || (locKey ? locKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown Yard');

    container.innerHTML = ''; // Clear loading spinner
  
    if (!data || data.length === 0) {
      container.innerHTML = '<div class="col-12 text-center text-muted p-5">No vehicles available to feature.</div>';
      return;
    }
  
    // Shuffle data and pick unique vehicles by Make and Model
    const shuffledData = [...data].sort(() => 0.5 - Math.random());
    const selected = [];
    const seenMakeModel = new Set();

    for (const vehicle of shuffledData) {
      if (selected.length >= count) break;
      const makeModelKey = `${vehicle.Make}|${vehicle.Model}`;
      if (!seenMakeModel.has(makeModelKey)) {
        selected.push(vehicle);
        seenMakeModel.add(makeModelKey);
      }
    }
  
    // Create card for each vehicle and fetch its info
    for (const vehicle of selected) {
      const col = document.createElement('div');
      col.className = 'col-12 mb-4'; // Full width column
      col.innerHTML = `
        <div class="tab-card p-0">
          <div class="row g-0">
            <div class="col-md-4 card-img-left-container text-center bg-light" style="display: flex; align-items: center; justify-content: center; min-height: 200px;">
              <div class="spinner-border spinner-border-sm" role="status"></div>
            </div>
            <div class="col-md-8 p-3">
              <div class="card-body d-flex flex-column h-100">
                <h5 class="card-title">${vehicle.Year} ${vehicle.Make}</h5>
                <h6 class="card-subtitle mb-2 text-muted">${vehicle.Model} <span class="badge bg-secondary fw-normal">${yardName}</span></h6>
                <p class="card-text small text-muted flex-grow-1">Loading summary...</p>
                <div class="mt-auto pt-2 d-flex gap-2">
                  <button class="btn btn-sm btn-outline-info w-50 info-btn">
                    <i class="bi bi-info-circle"></i> More Info (Wikipedia)
                  </button>
                  <button class="btn btn-sm btn-outline-warning w-50 fav-btn">
                    <i class="bi bi-star"></i> Create Favorite
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      container.appendChild(col);
  
      // Fetch Wikipedia data and update the card
      const wikiInfo = await getWikipediaInfo(vehicle.Year, vehicle.Make, vehicle.Model);
      const imgContainer = col.querySelector('.card-img-left-container');
      const summaryP = col.querySelector('.card-text');
  
      if (wikiInfo.imgSrc) {
        imgContainer.innerHTML = `<img src="${wikiInfo.imgSrc}" class="img-fluid rounded-start" style="width: 100%; height: 100%; object-fit: cover;">`;
      } else {
        imgContainer.innerHTML = `<span class="small text-muted">No Image</span>`;
      }
      summaryP.textContent = wikiInfo.summary.substring(0, 400) + (wikiInfo.summary.length > 400 ? '...' : '');
  
      col.querySelector('.info-btn').addEventListener('click', () => fetchVehicleInfo(vehicle.Year, vehicle.Make, vehicle.Model, document.getElementById('vehicleInfoModal')));
      col.querySelector('.fav-btn').addEventListener('click', () => addVehicleToFavorites(vehicle.Year, vehicle.Make, vehicle.Model));
    }
  }

  function renderTable(data) {
    const hdr = document.getElementById('tableHeader');
    const bd  = document.getElementById('tableBody');
    hdr.innerHTML = ''; bd.innerHTML = '';
    if (!data.length) return;

    const cols = Object.keys(data[0]).concat('Info','Note','Pick');
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      th.onclick = () => sortTableByColumn(c);
      hdr.appendChild(th);
    });

    const storedPick = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const pickKeys = new Set(storedPick.map(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|')));

    data.forEach(row => {
      const tr  = document.createElement('tr');
      const key = Object.values(row).join('|');
      tr.dataset.key = key;

      Object.values(row).forEach(v => {
        const td = document.createElement('td');
        td.textContent = v; tr.appendChild(td);
      });

      // Info cell
      const infoTd = document.createElement('td');
      const infoBtn = document.createElement('button');
      infoBtn.className = 'btn btn-sm btn-outline-info';
      infoBtn.innerHTML = '<i class="bi bi-info-circle"></i>';
      infoBtn.title = 'Get vehicle info from Wikipedia';
      infoBtn.onclick = (e) => {
        e.stopPropagation();
        fetchVehicleInfo(row.Year, row.Make, row.Model, document.getElementById('vehicleInfoModal'));
      };
      infoTd.appendChild(infoBtn);
      tr.appendChild(infoTd);

      // Note cell
      const nt = document.createElement('td');
      nt.textContent = (notes[key] || '');
      nt.style.cursor = 'pointer';
      nt.addEventListener('click', e => {
        e.stopPropagation();
        selectedRowKey = key;
        const ni = document.getElementById('noteInput');
        ni.value = notes[key] || '';
        document.getElementById('noteLengthFeedback').style.display = 'none';
        document.getElementById('noteLimitInfo').style.display = 'none';
        new bootstrap.Modal(document.getElementById('noteModal')).show();
      });
      tr.appendChild(nt);

      tr.addEventListener('click', () => openSoldModal(row));

      // Pick
      const pickTd = document.createElement('td');
      const btn = document.createElement('button');
      btn.classList.add('pick-btn','btn','btn-sm');

      if (pickKeys.has(['Year','Make','Model','Row'].map(k => row[k]).join('|'))) {
        btn.textContent = 'âœ“ Picked'; btn.classList.add('btn-success'); tr.classList.add('table-success');
      } else {
        btn.textContent = 'âž• Pick'; btn.classList.add('btn-outline-primary');
      }

      btn.addEventListener('click', e => {
        e.stopPropagation();
        const isPicked = btn.classList.contains('btn-success');
        const selector = document.getElementById('csvSelector');
        const locKey = selector?.selectedOptions?.[0]?.dataset?.loc || '';
        const yardName = `Jalopy Jungle ` + LOCATION_NAMES[locKey] || (locKey ? locKey : '');

        if (!isPicked) {
          addToPickList({ ...row, Yard: yardName });
          btn.textContent = 'âœ“ Picked';
          btn.classList.replace('btn-outline-primary','btn-success');
          tr.classList.add('table-success');
        } else {
          removeFromPickList(['Year','Make','Model','Row'].map(k => row[k]).join('|'));
          btn.textContent = 'âž• Pick';
          btn.classList.replace('btn-success','btn-outline-primary');
          tr.classList.remove('table-success');
        }
      });

      pickTd.appendChild(btn);
      tr.appendChild(pickTd);
      bd.appendChild(tr);
    });

    // New enhanced search logic
    function enhancedSearch(query, data) {
      const q = query.toLowerCase().trim();
      const yearRangeRegex = /\b(\d{2,4})-(\d{2,4})\b/;
      const singleYearRegex = /\b(\d{4})\b/;
      const singleTwoDigitYearRegex = /\b(\d{2})\b/;

      let yearRange = q.match(yearRangeRegex);
      let singleYear = !yearRange ? q.match(singleYearRegex) : null;
      let singleTwoDigitYear = !yearRange && !singleYear ? q.match(singleTwoDigitYearRegex) : null;

      let startYear, endYear;
      let remainingQuery = q;

      const parseYear = (yrStr) => {
        let year = parseInt(yrStr, 10);
        if (yrStr.length === 2) {
          year += (year > 50 ? 1900 : 2000); // YY to YYYY conversion
        }
        return year;
      };

      if (yearRange) {
        startYear = parseYear(yearRange[1]);
        endYear = parseYear(yearRange[2]);
        remainingQuery = q.replace(yearRange[0], '').trim();
      } else if (singleYear) {
        startYear = endYear = parseYear(singleYear[0]);
        remainingQuery = q.replace(singleYear[0], '').trim();
      } else if (singleTwoDigitYear) {
        startYear = endYear = parseYear(singleTwoDigitYear[0]);
        remainingQuery = q.replace(singleTwoDigitYear[0], '').trim();
      }

      return data.filter(r => {
        const vehicleYear = parseInt(r.Year, 10);
        const yearMatch = !startYear || (vehicleYear >= startYear && vehicleYear <= endYear);
        const textMatch = !remainingQuery || Object.values(r).some(v => String(v).toLowerCase().includes(remainingQuery));
        return yearMatch && textMatch;
      });
    }

  }

  function sortTableByColumn(col) {
    const dir = sortDirection[col] === 'asc' ? 'desc' : 'asc';
    sortDirection[col] = dir;
    currentData.sort((a,b) => a[col] < b[col] ? (dir==='asc'?-1:1) : a[col] > b[col] ? (dir==='asc'?1:-1) : 0);
    renderTable(currentData); showStatistics(currentData);
  }

  document.getElementById('saveNote').onclick = () => {
    const ni = document.getElementById('noteInput'), val = ni.value;
    document.getElementById('noteLengthFeedback').style.display = 'none';
    if (selectedRowKey) {
      notes[selectedRowKey] = val;
      localStorage.setItem('jalopyNotes', JSON.stringify(notes));
      renderTable(currentData);
      renderTrustyTable(trustyData);
      loadPickListData(); // Refresh pick list to show new note
    }
    bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
  };
  document.getElementById('clearNote').onclick = () => {
    const noteInput = document.getElementById('noteInput');
    const noteModalInstance = bootstrap.Modal.getInstance(document.getElementById('noteModal'));

    if (selectedRowKey) {
        delete notes[selectedRowKey];
        localStorage.setItem('jalopyNotes', JSON.stringify(notes));
        renderTable(currentData);
        renderTrustyTable(trustyData);
        loadPickListData(); // Refresh pick list to show cleared note
        noteInput.value = '';
        document.getElementById('noteLengthFeedback').style.display = 'none';
    }
    if (noteModalInstance) noteModalInstance.hide();
    if (selectedRowKey) {
      delete notes[selectedRowKey];
      localStorage.setItem('jalopyNotes', JSON.stringify(notes));
      renderTable(currentData);
      renderTrustyTable(trustyData);
      loadPickListData(); // Refresh pick list to show cleared note
      document.getElementById('noteInput').value = '';
      document.getElementById('noteLengthFeedback').style.display = 'none';
    }
  };

  /* ========== CSV helpers (with branding) ========== */
  function csvEscape(val) {
    const s = String(val ?? '');
    const needsQuotes = /[",\n]/.test(s);
    const escaped = s.replace(/"/g, '""');
    return needsQuotes ? `"${escaped}"` : escaped;
  }
  function fileStamp() {
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
  }
  function brandingBannerLines(contextLabel='Export') {
    const d = new Date();
    const ts = d.toISOString().slice(0,19).replace('T',' ');
    return [
      ['PROFIT â€“ Cars and Collectibles LLC'].map(csvEscape).join(','),
      ['Website: https://carsandcollectibles.com'].map(csvEscape).join(','),
      [`${contextLabel} generated: ${ts}`].map(csvEscape).join(','),
      '' // blank spacer line
    ];
  }

  function exportTableToCSVGeneric(hdrSel, bodySel, filename, excludeHeaders = ['Pick']) {
    // headers (drop excluded)
    const rawHeaders = Array.from(document.querySelectorAll(hdrSel + ' th'))
      .map(th => th.textContent.trim());
    const excludeSet = new Set(excludeHeaders.map(h => h.trim().toLowerCase()));
    const keepIdx = rawHeaders
      .map((h, i) => ({ h, i }))
      .filter(({ h }) => !excludeSet.has(h.toLowerCase()))
      .map(({ i }) => i);
    const headers = keepIdx.map(i => rawHeaders[i]);

    // rows
    const rows = Array.from(document.querySelectorAll(bodySel + ' tr')).map(tr => {
      const cells = Array.from(tr.cells).map(td => td.textContent);
      return keepIdx.map(i => cells[i] ?? '');
    });

    // build CSV with branding
    const top = brandingBannerLines('Inventory Export');
    const lines = [
      ...top,
      headers.map(csvEscape).join(','),
      ...rows.map(r => r.map(csvEscape).join(','))
    ];
    const csv = lines.join('\n');

    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.append(a);
    a.click();
    a.remove();
  }
  document.getElementById('exportBtn').onclick = () =>
    exportTableToCSVGeneric('#tableHeader', '#tableBody', 'inventory_with_notes.csv');

  function showStatistics(data) {
    const s = document.getElementById('statistics');
    const canvas = document.getElementById('ageChart');
    if (!s) return;
    const valid = data.map(r => {
      const y = parseInt(r.Year), rn = parseInt(r.Row);
      return (!isNaN(y) && !isNaN(rn)) ? { row:rn, age:new Date().getFullYear()-y } : null;
    }).filter(Boolean);
    
    if (!valid.length) {
      s.innerHTML = `<strong>Average Age:</strong> N/A<br/>
                     <strong># Models:</strong> 0<br/>
                     <strong># Makes:</strong> 0<br/>
                     <strong>Newest Age:</strong> N/A<br/>
                     <strong>Oldest Age:</strong> N/A`;
      if (ageChart){ ageChart.destroy(); ageChart=null; }
      return;
    }

    valid.sort((a,b)=>a.row-b.row);
    const cum=[]; valid.forEach((it,i)=>{
      const slice=valid.slice(0,i+1).map(x=>x.age);
      cum.push(+(slice.reduce((s,v)=>s+v,0)/slice.length).toFixed(1));
    });
    const ages = valid.map(x=>x.age);
    const models=new Set(data.map(r=>`${r.Make}|${r.Model}`));
    const makes=new Set(data.map(r=>r.Make));

    s.innerHTML = `<strong>Average Age:</strong> ${cum.at(-1)}<br/>
                   <strong># Models:</strong> ${models.size}<br/>
                   <strong># Makes:</strong> ${makes.size}<br/>
                   <strong>Newest Age:</strong> ${Math.min(...ages)}<br/>
                   <strong>Oldest Age:</strong> ${Math.max(...ages)}`;

    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (ageChart) ageChart.destroy();
    ageChart = new Chart(ctx,{
      type:'bar',
      data:{ labels: valid.map(x=>x.row), datasets:[{
        label:'Cumulative Avg Age', data:cum, backgroundColor:'rgba(52,152,219,0.7)', borderColor:'rgba(41,128,185,1)', borderWidth:1
      }]},
      options:{ responsive:true, scales:{
        x:{ title:{ display:true, text:'Row' }},
        y:{ title:{ display:true, text:'Age' }, beginAtZero:true }
      }, plugins:{ legend:{ display:false } } }
    });
  }

  /********* Trusty listing *********/
  async function listTrustyFiles() {
    const selector = document.getElementById('trustySelector');
    selector.innerHTML = '';
    try {
      const res = await fetch('./inventory-csvs/trusty/index.json', { cache:'no-store' });
      const files = await res.json();
      const latest = {};
      files.forEach(f => {
        const p = parseStamp(f, true);
        if (!p) return;
        if (!latest[p.loc] || p.dtKey > latest[p.loc].dtKey) latest[p.loc] = p;
      });

      Object.keys(latest).sort().forEach(locKey => {
        const entry = latest[locKey];
        const opt = document.createElement('option');
        opt.value = 'inventory-csvs/trusty/' + entry.filename;
        opt.dataset.loc = locKey;
        opt.textContent = `Trusty (${entry.dtDisplay})`;
        selector.appendChild(opt);
      });

      selector.onchange = (e) => {
        loadTrustyCSV(e.target.value);
      };

      if (selector.options.length) {
        selector.value = selector.options[0].value;
        loadTrustyCSV(selector.value);
      }
    } catch (err) {
      console.error('Error listing inventory CSVs (Trusty):', err);
    }
  }

  function loadTrustyCSV(path) {
    document.getElementById('trustySearchInput').value = '';
    const locKey = 'trusty'; // Trusty has a single source
    Papa.parse(path, {
      download:true, header:true,
      complete(r) {
        trustyData = r.data.filter(row => row.Year && row.Make && row.Model && row.Row);
        processInventoryChanges(locKey, trustyData, 'trusty');
        renderTrustyTable(trustyData);
        showTrustyStatistics(trustyData);
      }
    });
  }

  function addVehicleToFavorites(year, make, model) {
    const list = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    // Prevent duplicates
    const exists = list.some(v => v.year === year && v.make === make && v.model === model); // This check is simple and might not catch year ranges.
    if (exists) {
      alert(`${year} ${make} ${model} is already in your favorites.`);
      return;
    }

    if (confirm(`Add ${year} ${make} ${model} to your favorites?`)) {
      list.push({ year, make, model });
      localStorage.setItem(FAV_KEY, JSON.stringify(list));
      // Optional: show a confirmation toast/alert
      showFavToast(`Added ${year} ${make} ${model} to favorites!`);
      // If the favorites tab is active, re-render it
      if (document.querySelector('#favoritesTab.active')) renderFavoriteVehicles();
    }
  }
  function renderTrustyTable(data) {
    const hdr = document.getElementById('trustyTableHeader');
    const bd  = document.getElementById('trustyTableBody');
    hdr.innerHTML = ''; bd.innerHTML = '';
    if (!data.length) return;

    const cols = Object.keys(data[0]).concat('Info','Note','Pick');
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      th.onclick = () => sortTrustyByColumn(c);
      hdr.appendChild(th);
    });

    const storedPick = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const pickKeys = new Set(storedPick.map(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|')));
    
    data.forEach(row => {
      const tr  = document.createElement('tr');
      const key = Object.values(row).join('|');
      tr.dataset.key = key;

      Object.values(row).forEach(v => {
        const td = document.createElement('td');
        td.textContent = v; tr.appendChild(td);
      });

      // Info cell
      const infoTd = document.createElement('td');
      const infoBtn = document.createElement('button');
      infoBtn.className = 'btn btn-sm btn-outline-info';
      infoBtn.innerHTML = '<i class="bi bi-info-circle"></i>';
      infoBtn.title = 'Get vehicle info from Wikipedia';
      infoBtn.onclick = (e) => {
        e.stopPropagation();
        fetchVehicleInfo(row.Year, row.Make, row.Model, document.getElementById('vehicleInfoModal'));
      };
      infoTd.appendChild(infoBtn);
      tr.appendChild(infoTd);

      // Note cell
      const nt = document.createElement('td');
      nt.textContent = (notes[key] || '');
      nt.style.cursor = 'pointer';
      nt.addEventListener('click', e => {
        e.stopPropagation();
        selectedRowKey = key;
        const ni = document.getElementById('noteInput');
        ni.value = notes[key] || '';
        document.getElementById('noteLengthFeedback').style.display = 'none';
        document.getElementById('noteLimitInfo').style.display = 'none';
        new bootstrap.Modal(document.getElementById('noteModal')).show();
      });
      tr.appendChild(nt);

      tr.addEventListener('click', () => openSoldModal(row));

      // Pick
      const pickTd = document.createElement('td');
      const btn = document.createElement('button');
      btn.classList.add('pick-btn','btn','btn-sm');

      if (pickKeys.has(['Year','Make','Model','Row'].map(k => row[k]).join('|'))) {
        btn.textContent = 'âœ“ Picked'; btn.classList.add('btn-success'); tr.classList.add('table-success');
      } else {
        btn.textContent = 'âž• Pick'; btn.classList.add('btn-outline-primary');
      }

      btn.addEventListener('click', e => {
        e.stopPropagation();
        const isPicked = btn.classList.contains('btn-success');
        const yardName = `Trusty`;

        if (!isPicked) {
          addToPickList({ ...row, Yard: yardName });
          btn.textContent = 'âœ“ Picked';
          btn.classList.replace('btn-outline-primary','btn-success');
          tr.classList.add('table-success');
        } else {
          removeFromPickList(['Year','Make','Model','Row'].map(k => row[k]).join('|'));
          btn.textContent = 'âž• Pick';
          btn.classList.replace('btn-success','btn-outline-primary');
          tr.classList.remove('table-success');
        }
      });

      pickTd.appendChild(btn);
      tr.appendChild(pickTd);
      bd.appendChild(tr);
    });
  }

  function sortTrustyByColumn(col) {
    const dir = trustySortDirection[col] === 'asc' ? 'desc' : 'asc';
    trustySortDirection[col] = dir;
    trustyData.sort((a,b) => a[col] < b[col] ? (dir==='asc'?-1:1) : a[col] > b[col] ? (dir==='asc'?1:-1) : 0);
    renderTrustyTable(trustyData); showTrustyStatistics(trustyData);
  }

  function showTrustyStatistics(data) {
    const s = document.getElementById('trustyStatistics');
    const valid = data.map(r => {
      const y = parseInt(r.Year), rn = parseInt(r.Row);
      return (!isNaN(y) && !isNaN(rn)) ? { row:rn, age:new Date().getFullYear()-y } : null;
    }).filter(Boolean);

    if (!valid.length) {
      s.innerHTML = `<strong>Average Age:</strong> N/A<br/>
                     <strong># Models:</strong> 0<br/>
                     <strong># Makes:</strong> 0<br/>
                     <strong>Newest Age:</strong> N/A<br/>
                     <strong>Oldest Age:</strong> N/A`;
      if (trustyAgeChart){ trustyAgeChart.destroy(); trustyAgeChart=null; }
      return;
    }

    valid.sort((a,b)=>a.row-b.row);
    const cum=[]; valid.forEach((it,i)=>{
      const slice=valid.slice(0,i+1).map(x=>x.age);
      cum.push(+(slice.reduce((s,v)=>s+v,0)/slice.length).toFixed(1));
    });
    const ages = valid.map(x=>x.age);
    const models=new Set(data.map(r=>`${r.Make}|${r.Model}`));
    const makes=new Set(data.map(r=>r.Make));

    s.innerHTML = `<strong>Average Age:</strong> ${cum.at(-1)}<br/>
                   <strong># Models:</strong> ${models.size}<br/>
                   <strong># Makes:</strong> ${makes.size}<br/>
                   <strong>Newest Age:</strong> ${Math.min(...ages)}<br/>
                   <strong>Oldest Age:</strong> ${Math.max(...ages)}`;

    const ctx = document.getElementById('trustyAgeChart').getContext('2d');
    if (trustyAgeChart) trustyAgeChart.destroy();
    trustyAgeChart = new Chart(ctx,{
      type:'bar',
      data:{ labels: valid.map(x=>x.row), datasets:[{
        label:'Cumulative Avg Age', data:cum, backgroundColor:'rgba(52,152,219,0.7)', borderColor:'rgba(41,128,185,1)', borderWidth:1
      }]},
      options:{ responsive:true, scales:{
        x:{ title:{ display:true, text:'Row' }},
        y:{ title:{ display:true, text:'Age' }, beginAtZero:true }
      }, plugins:{ legend:{ display:false } } }
    });
  }

  /**************
   * Pick List  *
   **************/
  function getPickList() {
    try {
      return JSON.parse(localStorage.getItem('myPickList') || '[]');
    } catch {
      return [];
    }
  }
  function savePickList(list) {
    localStorage.setItem('myPickList', JSON.stringify(list));
  }

  function addToPickList(row, persist=true) {
    const tbody = document.getElementById('pickListBody');
    const key = ['Year','Make','Model','Row'].map(k => String(row[k]).trim()).join('|');
    renderPickListRow(tbody, row);

    if (persist) {
      let pickList = getPickList();
      if (!pickList.some(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|') === key)) {
        pickList.push(row);
        savePickList(pickList);
      }
    }
  }
  function removeFromPickList(key) {
    const tbody = document.getElementById('pickListBody');
    const rowEl = tbody.querySelector(`tr[data-key="${key}"]`);
    if (rowEl) tbody.removeChild(rowEl);
    let pickList = getPickList();
    pickList = pickList.filter(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|') !== key);
    savePickList(pickList);
  }

  function renderPickListRow(tbody, row) {
    const key = ['Year','Make','Model','Row'].map(k => String(row[k]).trim()).join('|');
    // Reconstruct the full original key to match how it's stored from the main tables.
    // The main tables use Object.values(row).join('|'), which includes all columns.
    // We must replicate that here to find the note.
    const originalKeyForNotes = [row.Year, row.Make, row.Model, row.Row, row.Date, row.Yard].join('|');

    const tr = document.createElement('tr');
    tr.dataset.key = key;

    // Make row clickable to add parts
    tr.style.cursor = 'pointer';
    tr.title = 'Click to add parts to this vehicle';

    // Main vehicle info
    ['Year','Make','Model','Row','Yard'].forEach(k => {
      const td = document.createElement('td');
      td.textContent = row[k] || '';
      tr.appendChild(td);
    });

    // Notes
    const noteTd = document.createElement('td');
    noteTd.textContent = (JSON.parse(localStorage.getItem('jalopyNotes') || '{}')[originalKeyForNotes] || '');
    noteTd.style.cursor = 'pointer';
    noteTd.addEventListener('click', e => {
      e.stopPropagation(); // Prevent opening the "Add Parts" modal
      selectedRowKey = originalKeyForNotes;
      const ni = document.getElementById('noteInput');
      ni.value = (JSON.parse(localStorage.getItem('jalopyNotes') || '{}')[originalKeyForNotes] || '');
      document.getElementById('noteLengthFeedback').style.display = 'none';
      document.getElementById('noteLimitInfo').style.display = 'none';
      // Ensure we have a modal instance to show
      const noteModalInstance = bootstrap.Modal.getOrCreateInstance(document.getElementById('noteModal'));
      noteModalInstance.show();
    });

    tr.appendChild(noteTd);

    // Remove button
    const rmTd = document.createElement('td');
    const rmBtn = document.createElement('button');
    rmBtn.className = 'btn btn-sm btn-outline-danger';
    rmBtn.textContent = 'âœ• Remove';
    rmBtn.addEventListener('click', e => {
      e.stopPropagation();
      tbody.removeChild(tr);
      if (partsTr) tbody.removeChild(partsTr); // Also remove parts row

      // Reset pick buttons in inventory tables
      [document.getElementById('tableBody'), document.getElementById('trustyTableBody')].forEach(tbodyEl => {
        if (!tbodyEl) return;
        const origRow = tbodyEl.querySelector(`tr[data-key="${originalKeyForNotes}"]`);
        if (origRow) {
          const pickBtn = origRow.querySelector('button.pick-btn');
          if (pickBtn) {
            pickBtn.textContent = 'âž• Pick';
            pickBtn.classList.replace('btn-success','btn-outline-primary');
            origRow.classList.remove('table-success');
          }
        }
      });

      let pickList = getPickList();
      pickList = pickList.filter(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|') !== key);
      savePickList(pickList);
    });
    rmTd.appendChild(rmBtn);
    tr.appendChild(rmTd);
    tbody.appendChild(tr);

    // Add click listener to the row itself (but not its buttons)
    tr.addEventListener('click', (e) => {
      if (e.target.tagName !== 'BUTTON') openAddPartsFromPickListModal(row);
    });

    // Render parts row if parts exist
    let partsTr = null;
    if (row.parts && row.parts.length > 0) {
      partsTr = document.createElement('tr');
      partsTr.dataset.partsForKey = key;
      const partsTd = document.createElement('td');
      partsTd.colSpan = 7; // Full width
      partsTd.className = 'p-2';

      // Calculate costs
      const isTaxExcluded = row.taxExcluded || false;
      const subtotal = (row.parts || []).reduce((sum, p) => sum + (p.carPriceNum || 0), 0);
      const salesTax = subtotal * 0.06;
      const totalWithTax = isTaxExcluded ? subtotal : subtotal + salesTax;

      // Build parts HTML
      const partsHtml = row.parts.map((p, partIndex) => `
        <span class="badge text-bg-secondary me-1 align-middle">
          ${p.part} (${p.section}) - $${p.carPriceNum || '0.00'}
          <button type="button" class="btn-close ms-1" style="font-size: .6em; vertical-align: middle;"
                  onclick="removePartFromVehicle('${key}', ${partIndex})"></button>
        </span>
      `).join('');
      
      const taxHtml = `
        <span style="cursor: pointer; ${isTaxExcluded ? 'text-decoration: line-through;' : 'text-decoration: underline dotted;'}" 
              onclick="toggleVehicleTax('${key}')">
          <strong>Sales Tax (6%):</strong> $${salesTax.toFixed(2)}
        </span>`;

      partsTd.innerHTML = `<div class="ms-4"><strong>Parts:</strong> ${partsHtml || 'None'}</div>
                         <div class="ms-4 mt-1 small">
                           <strong>Subtotal:</strong> $${subtotal.toFixed(2)} &nbsp;&nbsp; ${taxHtml} &nbsp;&nbsp; <strong>Total:</strong> <span class="fw-bold text-success">$${totalWithTax.toFixed(2)}</span>
                         </div>`;
      partsTr.appendChild(partsTd);
      tbody.appendChild(partsTr);
    }
  }

  function loadPickListData() {
    const pickList = getPickList();
    const tbody    = document.getElementById('pickListBody');
    tbody.innerHTML = '';
    pickList.forEach(row => renderPickListRow(tbody, row));
    updatePickListGrandTotal();
  }

  function removePartFromVehicle(vehicleKey, partIndex) {
    let pickList = getPickList();
    const vehicleIndex = pickList.findIndex(v => ['Year','Make','Model','Row'].map(k => v[k]).join('|') === vehicleKey);

    if (vehicleIndex > -1) {
      if (pickList[vehicleIndex].parts && pickList[vehicleIndex].parts[partIndex] !== undefined) {
        pickList[vehicleIndex].parts.splice(partIndex, 1);
        savePickList(pickList);
        loadPickListData();
      }
    }
  }

  function toggleVehicleTax(vehicleKey) {
    let pickList = getPickList();
    const vehicleIndex = pickList.findIndex(v => ['Year','Make','Model','Row'].map(k => v[k]).join('|') === vehicleKey);

    if (vehicleIndex > -1) {
        pickList[vehicleIndex].taxExcluded = !pickList[vehicleIndex].taxExcluded;
        savePickList(pickList);
        loadPickListData(); // Re-render to update this vehicle and the grand total
    }
  }

  function updatePickListGrandTotal() {
    const pickList = getPickList();
    let grandSubtotal = 0;

    pickList.forEach(vehicle => {
      if (vehicle.parts && vehicle.parts.length > 0) {
        const vehicleSubtotal = vehicle.parts.reduce((sum, part) => sum + (part.carPriceNum || 0), 0);
        if (!vehicle.taxExcluded) {
          grandSubtotal += vehicleSubtotal;
        } else {
          grandSubtotal += vehicleSubtotal; // Subtotal is always added
        }
      }
    });

    const totalTaxableAmount = pickList.filter(v => !v.taxExcluded).reduce((total, v) => total + (v.parts || []).reduce((sum, p) => sum + (p.carPriceNum || 0), 0), 0);
    const grandSalesTax = totalTaxableAmount * 0.06;
    const grandTotalWithTax = grandSubtotal + grandSalesTax;

    const finalGrandTotal = isGrandTotalTaxExcluded ? grandSubtotal : grandTotalWithTax;

    const totalEl = document.getElementById('pickListGrandTotal');
    if (totalEl) {
      totalEl.innerHTML = `<div><span class="text-muted">Subtotal:</span> <span class="fw-bold">$${grandSubtotal.toFixed(2)}</span></div>
                         <div style="cursor: pointer; ${isGrandTotalTaxExcluded ? 'text-decoration: line-through;' : ''}" 
                              onclick="isGrandTotalTaxExcluded = !isGrandTotalTaxExcluded; updatePickListGrandTotal();">
                           <span class="text-muted">Sales Tax (6%):</span> <span class="fw-bold">$${grandSalesTax.toFixed(2)}</span>
                         </div>
                         <div class="h5 mt-1">
                           <span class="fw-normal">Grand Total:</span> <span class="fw-bold text-success">$${finalGrandTotal.toFixed(2)}</span>
                         </div>`;
    }
  }

  /****************
   * Sold modal   *
   ****************/
  function openSoldModal(row) {
    const locKey = document.getElementById('csvSelector')?.selectedOptions?.[0]?.dataset?.loc;

    fetch('./ebay-sales/ebay-sales.json')
      .then(r => r.json())
      .then(files => {
        const prefix = `inventory_${locKey}_`;
        const soldFiles = files.filter(f => f.startsWith(prefix) && f.includes('_ebay_sales_'));
        if (!soldFiles.length) throw 'no-sold-files';

        let latestFile = soldFiles[0];
        let latestDate = latestFile.match(/_ebay_sales_(\d{4}-\d{2}-\d{2})\.csv$/)[1];
        soldFiles.forEach(f => {
          const m = f.match(/_ebay_sales_(\d{4}-\d{2}-\d{2})\.csv$/);
          if (m && m[1] > latestDate) { latestDate = m[1]; latestFile = f; }
        });
        return latestFile;
      })
      .then(latestFile => {
        const path = `./ebay-sales/${latestFile}`;
        return new Promise((resolve, reject) => {
          Papa.parse(path, { download:true, header:true,
            complete: res => resolve(res.data),
            error: err => reject(err)
          });
        });
      })
      .then(data => {
        const filtered = data.filter(r =>
          r.Year === row.Year && r.Make === row.Make && r.Model === row.Model
        );
        renderSoldTable(filtered);
      })
      .catch(err => {
        console.warn('Sold-data load:', err);
        renderSoldTable([]);
      })
      .finally(() => {
        new bootstrap.Modal(document.getElementById('soldModal')).show();
      });
  }

  function renderSoldTable(data) {
    const tbody = document.getElementById('soldDataBody');
    tbody.innerHTML = '';
    if (!data || !data.length) {
      document.getElementById('soldDataEmpty').style.display = '';
      return;
    }
    document.getElementById('soldDataEmpty').style.display = 'none';
    data.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r['Search Term']||''}</td>
        <td>${r['Listing Title']||''}</td>
        <td>${r['Last Sold Price']||''}</td>
        <td>${r['Date Sold']||''}</td>
        <td>${r['Time to Sell']||''}</td>
        <td>${r['Total Sold']||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  /***********************
   * Wikipedia Info Fetch
   ***********************/
  async function getWikipediaInfo(year, make, model) {
    const searchTerm = `${year} ${make} ${model}`;
    try {
      const WIKI_API = 'https://en.wikipedia.org/w/api.php?origin=*&format=json';
      const searchUrl = `${WIKI_API}&action=query&list=search&srlimit=1&srsearch=${encodeURIComponent(searchTerm)}`;
      const searchRes = await fetch(searchUrl);
      const searchData = await searchRes.json();
      const pageTitle = searchData.query?.search?.[0]?.title;
  
      if (!pageTitle) {
        throw new Error('No Wikipedia article found.');
      }
  
      const pageUrl = `${WIKI_API}&action=query&prop=extracts|pageimages&exintro&explaintext&piprop=thumbnail&pithumbsize=400&titles=${encodeURIComponent(pageTitle)}`;
      const pageRes = await fetch(pageUrl);
      const pageData = await pageRes.json();
      const page = Object.values(pageData.query.pages)[0];
  
      return {
        summary: page.extract || 'No summary available.',
        imgSrc: page.thumbnail?.source || '',
        link: `https://en.wikipedia.org/wiki/${encodeURIComponent(pageTitle)}`,
        error: null
      };
    } catch (error) {
      return { summary: `Could not fetch information for "${searchTerm}".`, imgSrc: '', link: '', error };
    }
  }

  async function fetchVehicleInfo(year, make, model, modalElement) {
    if (!modalElement) return;
    // Ensure we have a fresh modal instance to control
    const modal = new bootstrap.Modal(modalElement);
    const contentEl = modalElement.querySelector('.modal-body');
    const titleEl = modalElement.querySelector('.modal-title');

    titleEl.textContent = `${year} ${make} ${model}`;
    contentEl.innerHTML = `<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Fetching data from Wikipedia...</p></div>`;
    modal.show();

    const { summary, imgSrc, link, error } = await getWikipediaInfo(year, make, model);

    if (error) {
      contentEl.innerHTML = `<p class="text-danger">${summary}</p>`;
    } else {
      // Populate content
      contentEl.innerHTML = `
        ${imgSrc ? `<img src="${imgSrc}" class="img-fluid rounded mb-3" style="max-height: 300px; margin: 0 auto; display: block;">` : ''}
        <p>${summary}</p>
        <a href="${link}" target="_blank" class="btn btn-sm btn-outline-secondary">Read more on Wikipedia</a>
      `;
    }
  }

  /****************
   * Settings     *
   ****************/
  const settingsBtn = document.getElementById('settingsBtn');

  settingsBtn.onclick = () => {
    const sel = document.getElementById('homeYardSelect');
    sel.value = localStorage.getItem('homeYard') || '';
    const themeSel = document.getElementById('themeSelect');
    themeSel.value = localStorage.getItem('theme') || 'light';

    // Add live preview and auto-save listener
    themeSel.onchange = () => {
      const newTheme = themeSel.value;
      applyTheme(newTheme);
      localStorage.setItem('theme', newTheme);
    };

    new bootstrap.Modal(document.getElementById('settingsModal')).show();
  };
  document.getElementById('saveSettings').onclick = () => {
    const yard = document.getElementById('homeYardSelect').value;
    localStorage.setItem('homeYard', yard.trim().toLowerCase().replace(/\s+/g,'_'));
    bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
    applyHomeYardDefault();
  };

  function updateThemeDisplay(theme) {
    const themeDisplay = document.getElementById('currentThemeDisplay');
    if (!themeDisplay) return;
    const currentTheme = theme || localStorage.getItem('theme') || 'light';
    const themeName = currentTheme.charAt(0).toUpperCase() + currentTheme.slice(1); // Capitalize
    themeDisplay.textContent = `${themeName}`;
  }

  function applyTheme(theme) {
    document.body.className = document.body.className.replace(/\btheme-\w+\b/g, '').replace('dark-mode', '').trim();
    if (theme === 'dark') {
      document.body.classList.add('dark-mode');
    } else if (theme && theme !== 'light') {
      document.body.classList.add(`theme-${theme}`);
    }
    updateThemeDisplay(theme);
  }
  // Favorites UI
  document.querySelector('button[data-bs-target="#favoritesTab"]')?.addEventListener('shown.bs.tab', renderFavoriteVehicles);
  document.getElementById('addFavVehicleBtn').onclick = () => {
    const year  = document.getElementById('favYearInput').value.trim();
    const make  = document.getElementById('favMakeInput').value.trim();
    const model = document.getElementById('favModelInput').value.trim();
    const yearRegex = /^\d{2,4}(-\d{2,4})?$/;
    if (!year || !make || !model) {
      return alert('Please fill in all three fields.');
    }
    if (!yearRegex.test(year)) {
      return alert('Invalid Year format. Please use a single year (e.g., 1997 or 97) or a range (e.g., 2005-2009 or 05-09).');
    }
    const list = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    list.push({ year, make, model });
    localStorage.setItem(FAV_KEY, JSON.stringify(list));
    document.getElementById('favYearInput').value = '';
    document.getElementById('favMakeInput').value = '';
    document.getElementById('favModelInput').value = '';
    renderFavoriteVehicles();
  };
  function renderFavoriteVehicles() {
    const ul = document.getElementById('favVehiclesList');
    ul.innerHTML = '';
    const list = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    list.forEach((v, idx) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
      li.innerHTML = `<span><strong>${v.year}</strong> ${v.make} / ${v.model}</span>
                      <button class="btn btn-sm btn-outline-danger">âœ•</button>`;
      li.querySelector('button').onclick = () => {
        list.splice(idx, 1);
        localStorage.setItem(FAV_KEY, JSON.stringify(list));
        renderFavoriteVehicles();
      };
      ul.appendChild(li);
    });
  }

  // Data Code (sync favorites + picklist + prefs)
  function getDataCode() {
    const pickList   = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const favorites  = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    const homeYard   = localStorage.getItem('homeYard') || '';
    const theme = localStorage.getItem('theme') || 'light';
    const prevYardInventories = JSON.parse(localStorage.getItem(PREV_YARD_INV_KEY) || '{}');
    const combined = JSON.stringify({ pickList, favorites, homeYard, theme });
    return LZString.compressToBase64(combined);
  }
  function applyDataCode(code) {
    try {
      const json = LZString.decompressFromBase64(code);
      const obj  = JSON.parse(json);
      const theme = obj.theme || 'light';
      const prevYardInventories = obj.prevYardInventories || {};
      localStorage.setItem('myPickList', JSON.stringify(obj.pickList || []));
      localStorage.setItem(FAV_KEY, JSON.stringify(obj.favorites || []));
      localStorage.setItem('homeYard', (obj.homeYard || '').trim().toLowerCase().replace(/\s+/g,'_'));
      localStorage.setItem('theme', theme);
      localStorage.setItem(PREV_YARD_INV_KEY, JSON.stringify(prevYardInventories));
      loadPickListData();
      renderFavoriteVehicles();
      if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
      alert('Data synced successfully!');
    } catch(e) {
      alert('Invalid Data Code.');
    }
  }
  document.getElementById('exportDataBtn').onclick = () => {
    const code = getDataCode();
    const out  = document.getElementById('dataCodeOutput');
    out.value  = code;
    out.select(); document.execCommand('copy');
    alert('Data Code copied to clipboard!');
  };
  document.getElementById('importDataBtn').onclick = () => {
    const code = document.getElementById('dataCodeInput').value.trim();
    if (code) applyDataCode(code);
  };

  /* ---------- Pick List CSV (with branding) ---------- */
  function gatherPickListRowsFromDOM() {
    const tbody = document.getElementById('pickListBody');
    const rows = [];
    const notesMap = JSON.parse(localStorage.getItem('jalopyNotes') || '{}');
    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
      const tds = tr.querySelectorAll('td');
      if (tds.length < 6) return;
      const Year  = tds[0].textContent.trim();
      const Make  = tds[1].textContent.trim();
      const Model = tds[2].textContent.trim();
      const Row   = tds[3].textContent.trim();
      const Yard  = tds[4].textContent.trim();
      const key   = [Year, Make, Model, Row].join('|');
      const Notes = (notesMap[key] || '').replace(/\r?\n/g,' ');
      rows.push({ Year, Make, Model, Row, Yard, Notes });
    });
    return rows;
  }
  function gatherPickListRowsFromStorage() {
    const pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const notesMap = JSON.parse(localStorage.getItem('jalopyNotes') || '{}');
    return pickList.map(r => {
      const key = [r.Year, r.Make, r.Model, r.Row].join('|');
      const vehicleNotes = (notesMap[key] || '').replace(/\r?\n/g, ' ');
      const partsList = (r.parts || [])
        .map(p => `${p.part} (${p.section})`)
        .join('; ');

      const data = {
        Year:  r.Year || '',
        Make:  r.Make || '',
        Model: r.Model || '',
        Row:   r.Row || '',
        Yard:  r.Yard || '',
        Notes: vehicleNotes,
        Parts: partsList
      };
      return data;
    });
  }
  function gatherPickListRowsForPartCentricExport() {
    const pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const notesMap = JSON.parse(localStorage.getItem('jalopyNotes') || '{}');
    const allPartRows = [];

    pickList.forEach(vehicle => {
      // Use the more specific key to find notes
      const originalKeyForNotes = [vehicle.Year, vehicle.Make, vehicle.Model, vehicle.Row, vehicle.Date, vehicle.Yard].join('|');
      const vehicleNotes = (notesMap[originalKeyForNotes] || '').replace(/\r?\n/g, ' ');

      if (vehicle.parts && vehicle.parts.length > 0) {
        vehicle.parts.forEach(part => {
          allPartRows.push({
            Year: vehicle.Year || '',
            Make: vehicle.Make || '',
            Model: vehicle.Model || '',
            Row: vehicle.Row || '',
            Yard: vehicle.Yard || '',
            Notes: vehicleNotes,
            PartSection: part.section || '',
            Part: part.part || '',
            PartPrice: part.carPriceNum || 0,
            Core: part.coreNum || 0,
          });
        });
      } else {
        // Include vehicles that are on the list but have no parts selected yet
        allPartRows.push({
          Year: vehicle.Year || '', Make: vehicle.Make || '', Model: vehicle.Model || '',
          Row: vehicle.Row || '', Yard: vehicle.Yard || '', Notes: vehicleNotes,
          PartSection: '', Part: '', PartPrice: '', Core: '',
        });
      }
    });
    return allPartRows;
  }
  function downloadCSV(rows, filename, contextLabel = 'Pick List Export') {
    const headers = ['Year', 'Make', 'Model', 'Row', 'Yard', 'Notes', 'Parts']; // Ensure Parts is here
    const lines = [
      ...brandingBannerLines(contextLabel),
      headers.map(csvEscape).join(',')
    ];
    rows.forEach(r => {
      lines.push([r.Year, r.Make, r.Model, r.Row, r.Yard, r.Notes, r.Parts].map(csvEscape).join(','));
    });
    const csv = lines.join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }
  function downloadPartCentricCSV(rows, filename) {
    const headers = ['Year', 'Make', 'Model', 'Row', 'Yard', 'Notes', 'PartSection', 'Part', 'PartPrice', 'Core'];
    const lines = [
      ...brandingBannerLines('Pick List Export (by Part)'),
      headers.map(csvEscape).join(',')
    ];
    rows.forEach(r => {
      lines.push(headers.map(h => r[h] ?? '').map(csvEscape).join(','));
    });
    const csv = lines.join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }
  function downloadPartCentricCSV(rows, filename) {
    const headers = ['Year', 'Make', 'Model', 'Row', 'Yard', 'Notes', 'PartSection', 'Part', 'PartPrice', 'Core'];
    const lines = [
      ...brandingBannerLines('Pick List Export (by Part)'),
      headers.map(csvEscape).join(',')
    ];
    rows.forEach(r => {
      lines.push(headers.map(h => r[h] ?? '').map(csvEscape).join(','));
    });
    const csv = lines.join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }
  function downloadCSVGroupedByYard(rows, filename) {
    const sorted = [...rows].sort((a,b) =>
      (a.Yard||'').localeCompare(b.Yard||'') ||
      (a.Make||'').localeCompare(b.Make||'') ||
      (a.Model||'').localeCompare(b.Model||'') ||
      (parseInt(a.Year)||0) - (parseInt(b.Year)||0) ||
      (String(a.Row||'')).localeCompare(String(b.Row||''))
    );
    const headers = ['Year', 'Make', 'Model', 'Row', 'Yard', 'Notes', 'Parts']; // Ensure Parts is here
    const lines = [
      ...brandingBannerLines('Pick List Export (Grouped by Yard)'),
      headers.map(csvEscape).join(',')
    ];
    let currentYard = null;
    sorted.forEach(r => {
      if (r.Yard !== currentYard) {
        currentYard = r.Yard;
        lines.push('');
        lines.push([`YARD: ${currentYard}`,'','','','','',''].map(csvEscape).join(','));
      }
      lines.push([r.Year, r.Make, r.Model, r.Row, r.Yard, r.Notes, r.Parts].map(csvEscape).join(','));
    });
    const csv = lines.join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Export modal wiring
  function openExportPickListModal() {
    const rows = gatherPickListRowsFromStorage();
    const yards = Array.from(new Set(rows.map(r => r.Yard).filter(Boolean))).sort();
    const select = document.getElementById('singleYardSelect');
    select.innerHTML = '<option value="">Select Yardâ€¦</option>';
    yards.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y;
      select.appendChild(opt);
    });
    document.getElementById('exportByPart').checked = true;
    select.disabled = true;
    ['exportByPart', 'exportAsIs','exportGrouped','exportSingleYard'].forEach(id => {
      document.getElementById(id).onchange = () => {
        select.disabled = !document.getElementById('exportSingleYard').checked;
        const btn = document.getElementById('confirmExportPick');
        btn.textContent = id==='exportByPart' ? 'Export by Part'
          : id==='exportAsIs' ? 'Export Full List'
          : id==='exportGrouped' ? 'Export Grouped by Yard'
          : 'Export Selected Yard';
      };
    });
    // Manually trigger the text change for the default selection
    document.getElementById('confirmExportPick').textContent = 'Export by Part';
    bootstrap.Modal.getOrCreateInstance(document.getElementById('exportPickListModal')).show();
  }
  function performPickListExportFromModal() {
    const mode = document.querySelector('input[name="pickExportMode"]:checked')?.value || 'asis';
    const ts = fileStamp();
    if (mode === 'bypart') {
      const rows = gatherPickListRowsForPartCentricExport();
      if (!rows.length) return alert('Your pick list is empty.');
      downloadPartCentricCSV(rows, `pick_list_by_part_${ts}.csv`);
      return;
    }
    if (mode === 'bypart') {
      const rows = gatherPickListRowsForPartCentricExport();
      if (!rows.length) return alert('Your pick list is empty.');
      downloadPartCentricCSV(rows, `pick_list_by_part_${ts}.csv`);
      return;
    }
    if (mode === 'asis') {
      const rows = gatherPickListRowsFromDOM();
      if (!rows.length) return alert('Your pick list is empty.');
      downloadCSV(rows, `pick_list_${ts}.csv`, 'Pick List Export');
      return;
    }
    if (mode === 'grouped') {
      const rows = gatherPickListRowsFromStorage();
      if (!rows.length) return alert('Your pick list is empty.');
      downloadCSVGroupedByYard(rows, `pick_list_grouped_${ts}.csv`);
      return;
    }
    if (mode === 'single') {
      const yard = document.getElementById('singleYardSelect').value.trim();
      if (!yard) return alert('Please choose a yard.');
      const rows = gatherPickListRowsFromStorage().filter(r => r.Yard === yard);
      if (!rows.length) return alert(`No rows found for yard: ${yard}`);
      downloadCSV(rows, `pick_list_${yard.replace(/\s+/g,'_')}_${ts}.csv`, `Pick List Export â€“ ${yard}`);
      return;
    }
  }

  // Hook up buttons
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('exportPickListBtn');
    if (btn) btn.addEventListener('click', openExportPickListModal);

    const confirm = document.getElementById('confirmExportPick');
    if (confirm) confirm.addEventListener('click', () => {
      performPickListExportFromModal();
      bootstrap.Modal.getInstance(document.getElementById('exportPickListModal')).hide();
    });
  });

  /* ---------- Alerts tab JS ---------- */
  (function initAlerts() {
    const form = document.getElementById("alertForm");
    const statusMsg = document.getElementById("statusMsg");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusMsg.textContent = "Submittingâ€¦";

      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());

      const email = localStorage.getItem('premiumEmail');
      if (!email) {
        statusMsg.textContent = "âŒ Missing email. Please re-login.";
        showGate();
        return;
      }
      payload.email = email; // auto-insert stored email

      try {
        const res = await fetch("https://profit-alerts.profit-alerts.workers.dev", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const result = await res.json();
        if (result.ok) {
          statusMsg.textContent = "âœ… Alert created!";
          form.reset();
        } else {
          statusMsg.textContent = "âŒ Error creating alert.";
        }
      } catch (err) {
        statusMsg.textContent = "âŒ Network error.";
      }
    });
  })();

  /****************
   * App init     *
   ****************/
  function initApp() {
    try { notes = JSON.parse(localStorage.getItem('jalopyNotes') || '{}'); } catch { notes = {}; }
    applyTheme(localStorage.getItem('theme') || 'light');

    updateSignedInEmailUI();
    listCSVFiles();      // Jalopy
    listTrustyFiles();   // Trusty
    loadPickListData();  // Pick list
    initQrSyncTab();     // QR Sync

    // --- Wire up "What's New" tab and its controls ---
    const tabBtn = document.querySelector('button[data-bs-target="#whatsNewTab"]');
    if (tabBtn) {
      // Generate the report the first time the tab is shown.
      tabBtn.addEventListener('show.bs.tab', generateNewVehiclesReport, { once: true });
    }

    const rerunBtn = document.getElementById('rerunNewVehicleAnalysisBtn');
    if (rerunBtn) {
      rerunBtn.addEventListener('click', async () => {
        if (!confirm("This will clear the 'viewed' status and re-load the latest inventory for ALL yards to run the comparison again. This is for testing purposes. Continue?")) {
          return;
        }
        localStorage.removeItem(PREV_YARD_INV_KEY);
        newVehiclesByYard = {};
        const tasks = [];
        for (const option of document.getElementById('csvSelector').options) { tasks.push(loadAndProcessYard(option.value, option.dataset.loc, 'jalopy')); }
        for (const option of document.getElementById('trustySelector').options) { tasks.push(loadAndProcessYard(option.value, 'trusty', 'trusty')); }
        await Promise.all(tasks);
        generateNewVehiclesReport();
      });
    }
    
    // Initial check for any new vehicles on load
    updateNewVehicleCountBadge();

    // --- Attach debounced search listeners ONCE ---
    document.getElementById('searchInput').addEventListener('input', debounce(function(e) {
      const filtered = enhancedSearch(e.target.value, currentData);
      renderTable(filtered);
      showStatistics(filtered);
    }, 250));

    document.getElementById('trustySearchInput').addEventListener('input', debounce(function(e) {
      const filtered = trustyEnhancedSearch(e.target.value, trustyData);
      renderTrustyTable(filtered);
      showTrustyStatistics(filtered);
    }, 250));

    const pricingSearchInput = document.getElementById('pricingSearch');
    if (pricingSearchInput) {
        // Remove the old, non-debounced listener from wirePricingFilters
        // and add the debounced one here.
        pricingSearchInput.removeEventListener('input', applyPricingFilters);
        pricingSearchInput.addEventListener('input', debounce(applyPricingFilters, 250));
    }
  }

  // Start the serial gate flow
  validateStoredKey();

  </script>
  <script>
  // ==================================================
  // "WHAT'S NEW TODAY" FEATURE
  // ==================================================

  // Stores a map of { yardKey: [vehicleId1, vehicleId2, ...] }
  let newVehiclesByYard = {};

  // Helper to load a single yard's data for analysis without affecting the main UI
  async function loadAndProcessYard(path, locKey, source) {
    return new Promise((resolve, reject) => {
      Papa.parse(path, {
        download: true,
        header: true,
        complete(r) {
          const inventoryData = r.data.filter(row => row.Year && row.Make && row.Model && row.Row);
          processInventoryChanges(locKey, inventoryData, source);
          resolve();
        },
        error(err) {
          console.error(`Failed to load ${path}:`, err);
          reject(err);
        }
      });
    });
  }
  function getVehicleId(vehicle) {
    // Creates a stable, unique ID for a vehicle in a specific row.
    return `${vehicle.Year}|${vehicle.Make}|${vehicle.Model}|${vehicle.Row}`;
  }

  function processInventoryChanges(yardKey, currentYardInventory, source) {
    const allPreviousInventories = JSON.parse(localStorage.getItem(PREV_YARD_INV_KEY) || '{}');
    const previousYardIds = new Set(allPreviousInventories[yardKey] || []);
    const currentYardIds = new Set(currentYardInventory.map(getVehicleId));

    const newVehicleIds = new Set();
    for (const id of currentYardIds) {
      if (!previousYardIds.has(id)) {
        newVehicleIds.add(id);
      }
    }

    // Find the full vehicle objects for the new IDs
    newVehiclesByYard[yardKey] = currentYardInventory.filter(v => newVehicleIds.has(getVehicleId(v)));

    // Update storage for next time
    allPreviousInventories[yardKey] = Array.from(currentYardIds);
    localStorage.setItem(PREV_YARD_INV_KEY, JSON.stringify(allPreviousInventories));

    updateNewVehicleCountBadge();
  }

  function updateNewVehicleCountBadge() {
    const badge = document.getElementById('newVehicleCountBadge');
    const totalNew = Object.values(newVehiclesByYard).reduce((sum, arr) => sum + arr.length, 0);

    if (totalNew > 0) {
      badge.textContent = totalNew;
      badge.style.display = '';
    } else {
      badge.style.display = 'none';
    }
  }

  function generateNewVehiclesReport() {
    const reportContainer = document.getElementById('newVehiclesReport');
    reportContainer.innerHTML = '';
  
    const pickList = getPickList();
    const favorites = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    const favoriteMakeModels = new Set(favorites.map(v => `${v.year}|${v.make}|${v.model}`.toLowerCase()));
  
    const allNewVehicles = Object.entries(newVehiclesByYard);
  
    if (allNewVehicles.every(([, vehicles]) => vehicles.length === 0)) {
      reportContainer.innerHTML = '<p class="text-center">No new vehicles detected since your last visit.</p>';
      return;
    }
  
    // Helper to check if a vehicle year falls within a favorite's year/range
    const isFavoriteMatch = (vehicle, fav) => {
      const vMake = vehicle.Make.toLowerCase();
      const vModel = vehicle.Model.toLowerCase();
      if (vMake !== fav.make.toLowerCase() || vModel !== fav.model.toLowerCase()) {
        return false;
      }

      const vYear = parseInt(vehicle.Year, 10);
      const favYear = fav.year;

      if (favYear.includes('-')) {
        let [start, end] = favYear.split('-').map(y => parseInt(y, 10));
        // Handle 2-digit years
        start += (start < 50 ? 2000 : 1900);
        end += (end < 50 ? 2000 : 1900);
        return vYear >= start && vYear <= end;
      } else {
        let singleYear = parseInt(favYear, 10);
        // Handle 2-digit year
        singleYear += (favYear.length === 2 && singleYear < 50 ? 2000 : (favYear.length === 2 ? 1900 : 0));
        return vYear === singleYear;
      }
    };

    // Separate vehicles into "favorites", "interesting", and "other"
    const favoriteMatches = [];
    const interestingVehicles = [];
    const otherNewVehiclesByYard = {};
  
    allNewVehicles.forEach(([yardKey, vehicles]) => {
      otherNewVehiclesByYard[yardKey] = [];
      vehicles.forEach(v => {
        const yardName = LOCATION_NAMES[yardKey] || 'Trusty';
        const vehicleWithYard = { ...v, yardName };

        if (favorites.some(fav => isFavoriteMatch(v, fav))) {
          favoriteMatches.push(vehicleWithYard);
          return; // Don't also list it as a potential interest or other
        }

        // Then check for potential interest
        const isPotentialInterest = pickList.some(p => p.Make === v.Make && p.Model === v.Model);
        if (isPotentialInterest) {
          interestingVehicles.push({ ...v, yardName });
        } else {
          otherNewVehiclesByYard[yardKey].push(v);
        }
      });
    });

    let finalHtml = '<div class="accordion" id="newVehiclesAccordion">';

    // 0. Build "Favorite Vehicles" table (highest priority)
    if (favoriteMatches.length > 0) {
      const collapseId = 'collapse-favorites';
      finalHtml += `
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading-favorites">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
              <i class="bi bi-heart-fill text-danger me-2"></i> Favorite Vehicle Arrivals
              <span class="badge bg-danger ms-2">${favoriteMatches.length} new</span>
            </button>
          </h2>
          <div id="${collapseId}" class="accordion-collapse collapse show" data-bs-parent="#newVehiclesAccordion">
            <div class="accordion-body p-2">
              <div class="table-responsive"><table class="table table-sm table-striped table-bordered table-danger">
                <thead class="table-dark"><tr><th>Year</th><th>Make</th><th>Model</th><th>Row</th><th>Yard</th><th>Date</th></tr></thead>
                <tbody>${favoriteMatches.map(v => `<tr><td>${v.Year}</td><td>${v.Make}</td><td>${v.Model}</td><td>${v.Row}</td><td>${v.yardName}</td><td>${v.Date}</td></tr>`).join('')}</tbody>
              </table></div>
            </div>
          </div>
        </div>`;
    }
  
    // 1. Build "Potential Interests" table
    if (interestingVehicles.length > 0) {
      const collapseId = 'collapse-interests';
      finalHtml += `
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading-interests">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
              <i class="bi bi-star-fill text-warning me-2"></i> Potential Interests
              <span class="badge bg-warning text-dark ms-2">${interestingVehicles.length} new</span>
            </button>
          </h2>
          <div id="${collapseId}" class="accordion-collapse collapse show" data-bs-parent="#newVehiclesAccordion">
            <div class="accordion-body p-2">
              <p class="text-muted small mt-0 mb-2">These new vehicles match the Make and Model of items in your Pick List.</p>
              <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered table-warning">
                  <thead class="table-dark"><tr><th>Year</th><th>Make</th><th>Model</th><th>Row</th><th>Yard</th><th>Date</th></tr></thead>
                  <tbody>
                    ${interestingVehicles.map(v => `<tr><td>${v.Year}</td><td>${v.Make}</td><td>${v.Model}</td><td>${v.Row}</td><td>${v.yardName}</td><td>${v.Date}</td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>`;
    }
  
    // 2. Build collapsible tables for each yard
    Object.entries(otherNewVehiclesByYard).forEach(([yardKey, vehicles], index) => {
      if (vehicles.length === 0) return;
  
      const yardName = LOCATION_NAMES[yardKey] || 'Trusty';
      const collapseId = `collapse-${yardKey}`;
      // It's the first only if there are no favorites or interests
      const isFirst = index === 0 && favoriteMatches.length === 0 && interestingVehicles.length === 0;
  
      finalHtml += `
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading-${yardKey}">
            <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
              ${yardName} <span class="badge bg-secondary ms-2">${vehicles.length} new</span>
            </button>
          </h2>
          <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" data-bs-parent="#newVehiclesAccordion">
            <div class="accordion-body p-2">
              <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered">
                  <thead class="table-dark"><tr><th>Year</th><th>Make</th><th>Model</th><th>Row</th><th>Date</th></tr></thead>
                  <tbody>
                    ${vehicles.map(v => `<tr><td>${v.Year}</td><td>${v.Make}</td><td>${v.Model}</td><td>${v.Row}</td><td>${v.Date}</td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>`;
    });
    finalHtml += '</div>';
  
    reportContainer.innerHTML = finalHtml;
  }

  // The initNewVehiclesReport function is no longer needed as its logic has been moved into initApp().
  </script>
  
<script>
// ======== TRENDS (Latest sold-data only) ========

const T_YARDS = ['boise','caldwell','garden_city','nampa','twin_falls'];
const RE_TAIL_DATE = /_ebay_sales_(\d{4}-\d{2}-\d{2})\.csv$/;

const $ = id => document.getElementById(id);
const setTrendsSummary = msg => { const el = $('trendsSummary'); if (el) el.textContent = msg || ''; };

// Yard source: "Auto" follows Jalopy; others are explicit
function getCurrentLocKeyFromJalopy(){
  const opt = $('csvSelector')?.selectedOptions?.[0];
  return opt?.dataset?.loc || '';
}
function getTrendsLocKey(){
  const sel = $('trendsYard');
  const v = sel?.value || 'auto';
  return v === 'auto' ? getCurrentLocKeyFromJalopy() : v; // 'all' | 'vehicles_of_interest' | yard token
}

// Load index (expects ./ebay-sales/ebay-sales.json)
async function loadEbayIndex(){
  try {
    const r = await fetch('./ebay-sales/ebay-sales.json', { cache: 'no-store' });
    const data = await r.json();
    const files = Array.isArray(data) ? data : (Array.isArray(data?.files) ? data.files : []);
    return files;
  } catch(e) {
    console.error('[Trends/latest] Could not load ebay-sales.json', e);
    return [];
  }
}

function detectYardTokenFromFile(f) {
  const pre = f.split('_ebay_sales_')[0].toLowerCase();
  if (pre.startsWith('vehicles_of_interest')) return 'vehicles_of_interest';
  for (const y of T_YARDS) if (pre.includes(`_${y}_`)) return y; // strong match
  for (const y of T_YARDS) if (pre.includes(y)) return y;        // loose match
  return 'unknown';
}
function tailDateKey(f) {
  const m = f.match(RE_TAIL_DATE);
  return m ? m[1] : '';
}
function humanYard(token){
  const map = { boise:'Boise', caldwell:'Caldwell', garden_city:'Garden City', nampa:'Nampa', twin_falls:'Twin Falls', vehicles_of_interest:'Vehicles of Interest' };
  return map[token] || token;
}

// Pick newest file(s) for the selection
function pickLatestTargets(filesIndex, locKey) {
  // group files by detected yard
  const byYard = new Map();
  for (const f of filesIndex) {
    if (!RE_TAIL_DATE.test(f)) continue;
    const y = detectYardTokenFromFile(f);
    if (!byYard.has(y)) byYard.set(y, []);
    byYard.get(y).push(f);
  }
  for (const arr of byYard.values()) {
    arr.sort((a,b) => (tailDateKey(b)).localeCompare(tailDateKey(a))); // newest first
  }

  // 'all' => newest for each known yard (skip unknown)
  if (locKey === 'all') {
    const out = [];
    for (const y of T_YARDS) {
      const arr = byYard.get(y);
      if (arr?.length) out.push({ yard:y, file:arr[0] });
    }
    // also include vehicles_of_interest if present as a convenience
    const voi = byYard.get('vehicles_of_interest');
    if (voi?.length) out.push({ yard:'vehicles_of_interest', file:voi[0] });
    return out;
  }

  // specific corpus
  const want = locKey || ''; // '' can happen if Auto before Jalopy chosen
  if (!want) return []; // no yard yet

  if (want === 'vehicles_of_interest') {
    const voi = byYard.get('vehicles_of_interest');
    return voi?.length ? [{ yard:'vehicles_of_interest', file:voi[0] }] : [];
  }

  // specific yard
  const yardFiles = byYard.get(want);
  if (yardFiles?.length) return [{ yard:want, file:yardFiles[0] }];

  // fallback: vehicles_of_interest if yard missing
  const voi = byYard.get('vehicles_of_interest');
  return voi?.length ? [{ yard:'vehicles_of_interest', file:voi[0] }] : [];
}

// CSV utilities
function normalizeSoldRow(r) {
  return {
    year:  r['Year'] ?? r['year'] ?? '',
    make:  r['Make'] ?? r['make'] ?? '',
    model: r['Model'] ?? r['model'] ?? '',
    term:  r['Search Term'] ?? r['search_term'] ?? r['Term'] ?? '',
    title: r['Listing Title'] ?? r['Title'] ?? r['listing_title'] ?? '',
    price: r['Last Sold Price'] ?? r['Sold Price'] ?? r['Price'] ?? r['last_sold_price'] ?? '',
    date:  r['Date Sold'] ?? r['Sold Date'] ?? r['date_sold'] ?? '',
    tts:   r['Time to Sell'] ?? r['Time To Sell'] ?? r['tts'] ?? '',
    total: r['Total Sold'] ?? r['total_sold'] ?? r['Count'] ?? ''
  };
}

function parseCSV(path) {
  return new Promise((resolve, reject) => {
    Papa.parse(path, {
      download: true, header: true,
      complete: res => resolve(res.data || []),
      error: err => reject(err)
    });
  });
}

// ---------- Normalization helpers ----------
function normBasic(s){
  return String(s||'')
    .toLowerCase()
    .normalize('NFKD')                 // strip accents
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/&/g,' and ')
    .replace(/[^a-z0-9]+/g,' ')        // non-alnum -> space
    .replace(/\s+/g,' ')
    .trim();
}

// Keep tokens worth matching: length >= 2 and not in stoplist
const STOP = new Set(['the','a','an','and','or','for','to','of','with','on','at','by','in','from','this','that','these','those']);
function tokenizeQ(s){
  const base = normBasic(s);
  const raw = base.split(' ');
  // Also generate fused tokens to catch things like "f 150" vs "f150"
  const fused = raw.join('');
  const tokens = raw.filter(w => w && w.length >= 2 && !STOP.has(w));
  if (fused.length >= 3) tokens.push(fused);
  return Array.from(new Set(tokens));
}

// Title normalization that also keeps a fused variant (e.g. "F-150" -> "f150")
function prepTitle(s){
  const base = normBasic(s);
  const fused = base.replace(/ /g,'');
  return { base, fused };
}

// ---------- Main predicate: keep row if title contains ANY token from search term ----------
function titleContainsAnySearchWord(searchTerm, listingTitle){
  if (!searchTerm) return true; // if no query provided in the CSV, don't drop it
  const tokens = tokenizeQ(searchTerm);
  if (!tokens.length) return true;

  const { base, fused } = prepTitle(listingTitle || '');
  // require at least one token present in base OR fused
  return tokens.some(t => base.includes(t) || fused.includes(t));
}

// Convenience wrapper for your normalized row object
function keepRowByTitleTerm(row){
  return titleContainsAnySearchWord(row.term, row.title);
}



function debounce(fn, ms=150){
  let t; 
  return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}

function matchesQuery(row, q){
  if (!q) return true;
  const s = q.toLowerCase().trim();
  const hay = [
    row.year || '', row.make || '', row.model || '',
    row.term || ''
  ].join(' ').toLowerCase();
  return hay.includes(s);
}

// ---- Sorting state for Trends (default newest first) ----
let TRENDS_SORT = { col: 'Date Sold', dir: 'desc' }; // dir: 'asc' | 'desc'

// Parse helpers
function parsePriceNum(s){
  if (s == null) return NaN;
  const n = String(s).replace(/[^0-9.\-]/g,'');
  return n ? parseFloat(n) : NaN;
}
function parseTTSNum(s){
  if (s == null) return NaN;
  const m = String(s).match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}
function parseISODate(s){
  const d = new Date(s);
  return isNaN(d.getTime()) ? NaN : d.getTime();
}

function cmpStr(a,b){ return String(a).localeCompare(String(b), undefined, {sensitivity:'base', numeric:true}); }
function cmpNum(a,b){
  const an = (isNaN(a)? -Infinity : a);
  const bn = (isNaN(b)? -Infinity : b);
  return an - bn;
}

function getGroupComparator(col, dir){
  const mul = dir === 'desc' ? -1 : 1;
  switch(col){
    case 'Year':            return (a,b)=> mul * cmpStr(a.meta.year||'', b.meta.year||'');
    case 'Make':            return (a,b)=> mul * cmpStr(a.meta.make||'', b.meta.make||'');
    case 'Model':           return (a,b)=> mul * cmpStr(a.meta.model||'', b.meta.model||'');
    case 'Search Term':     return (a,b)=> mul * cmpStr(a.agg.firstTerm||'',  b.agg.firstTerm||'');
    case 'Listing Title':   return (a,b)=> mul * cmpStr(a.agg.firstTitle||'', b.agg.firstTitle||'');
    case 'Last Sold Price': return (a,b)=> mul * cmpNum(a.agg.avgPrice,  b.agg.avgPrice);
    case 'Date Sold':       return (a,b)=> mul * cmpNum(a.agg.latestDate,b.agg.latestDate);
    case 'Time To Sell':    return (a,b)=> mul * cmpNum(a.agg.avgTTS,    b.agg.avgTTS);
    case 'Total Sold':      return (a,b)=> mul * cmpNum(a.agg.sumTotal,  b.agg.sumTotal);
    default:                return ()=>0;
  }
}


// ===== Paged + Lazy Grouped Renderer for Trends (Latest) =====
const PAGE_GROUPS = 25;               // how many vehicle groups per â€œpageâ€
let TRENDS_LATEST_ALL_ROWS = [];      // full dataset (already in your code)
let TRENDS_FILTERED_ROWS = [];        // rows after search filter
let TRENDS_GROUPS = [];               // [{key, meta:{year,make,model}, items:[...]}, ...]
let TRENDS_VISIBLE_COUNT = 0;         // how many groups currently rendered
let TRENDS_SCROLL_EL = null;

function buildGroups(rows) {
  const map = new Map();
  rows.forEach(r => {
    const key = [r.year||'', r.make||'', r.model||''].map(s => String(s).trim()).join('|');
    if (!map.has(key)) {
      map.set(key, {
        key,
        meta: { year:r.year||'', make:r.make||'', model:r.model||'' },
        items: [],
        agg: { avgPrice:NaN, latestDate:NaN, avgTTS:NaN, sumTotal:0, firstTitle:'', firstTerm:'' }
      });
    }
    map.get(key).items.push(r);
  });

  // compute aggregates for each group
  for (const g of map.values()) {
    const prices = g.items.map(it => parsePriceNum(it.price)).filter(v => !isNaN(v));
    const tts    = g.items.map(it => parseTTSNum(it.tts)).filter(v => !isNaN(v));
    const dates  = g.items.map(it => parseISODate(it.date)).filter(v => !isNaN(v));
    const totals = g.items.map(it => parseFloat(it.total)).filter(v => !isNaN(v));

    g.agg.avgPrice   = prices.length ? prices.reduce((a,b)=>a+b,0)/prices.length : NaN;
    g.agg.latestDate = dates.length  ? Math.max(...dates) : NaN;
    g.agg.avgTTS     = tts.length    ? tts.reduce((a,b)=>a+b,0)/tts.length : NaN;
    g.agg.sumTotal   = totals.length ? totals.reduce((a,b)=>a+b,0) : 0;
    g.agg.firstTitle = g.items[0]?.title || '';
    g.agg.firstTerm  = g.items[0]?.term  || '';
  }

  // sort groups by current sort selection
  const arr = Array.from(map.values());
  const cmp = getGroupComparator(TRENDS_SORT.col, TRENDS_SORT.dir);
  arr.sort(cmp);
  return arr;
}


function appendGroupDOM(tbody, group, idx) {
  const { year, make, model } = group.meta;
  const gid = `grp-${idx}-${Math.random().toString(36).slice(2,8)}`;

  // Group header row
  const headerTr = document.createElement('tr');
  headerTr.className = 'table-secondary group-row';
  headerTr.innerHTML = `
    <td colspan="9" class="fw-semibold" data-gid="${gid}">
      <span class="caret me-2">â–¶</span>
      ${year || 'â€”'} ${make || ''} ${model || ''}
      <span class="text-muted ms-2">(${group.items.length} sale${group.items.length===1?'':'s'})</span>
    </td>
  `;
  tbody.appendChild(headerTr);

  // We'll insert/remove real body rows directly under headerTr
  let expanded = false;
  let children = []; // keep references so we can remove on collapse

  function expand() {
    if (expanded) return;
    const insertAfter = headerTr.nextSibling;

    group.items.forEach(it => {
      const rtr = document.createElement('tr');
      rtr.className = `child-of-${gid}`;
      rtr.innerHTML = `
        <td>${year || ''}</td>
        <td>${make || ''}</td>
        <td>${model || ''}</td>
        <td>${it.term || ''}</td>
        <td>${it.title || ''}</td>
        <td>${it.price || ''}</td>
        <td>${it.date || ''}</td>
        <td>${it.tts || ''}</td>
        <td>${it.total || ''}</td>
      `;
      // insert right after the header (keeps order while paging)
      tbody.insertBefore(rtr, insertAfter);
      children.push(rtr);
    });

    expanded = true;
    const caret = headerTr.querySelector('.caret');
    if (caret) caret.textContent = 'â–¼';
  }

  function collapse() {
    if (!expanded) return;
    children.forEach(tr => tr.remove());
    children = [];
    expanded = false;
    const caret = headerTr.querySelector('.caret');
    if (caret) caret.textContent = 'â–¶';
  }

  // Toggle expand/collapse on click
  headerTr.addEventListener('click', () => {
    expanded ? collapse() : expand();
  }, { passive:true });
}


// Reset and render the first page
function renderTrendsLatestPagedReset(rows) {
  const tbody = document.getElementById('trendsTableBody');
  if (!tbody) return;

  // Build state
  TRENDS_FILTERED_ROWS = rows;
  TRENDS_GROUPS = buildGroups(TRENDS_FILTERED_ROWS);
  TRENDS_VISIBLE_COUNT = 0;

  // Clear DOM and render first chunk
  tbody.innerHTML = '';
  renderNextGroupsChunk();

  // Update summary
  const totalGroups = TRENDS_GROUPS.length;
  const totalRows = TRENDS_FILTERED_ROWS.length;
  setTrendsSummary(
    totalRows
      ? `Showing ${Math.min(TRENDS_VISIBLE_COUNT, totalGroups)} of ${totalGroups} vehicles â€¢ ${totalRows} total sales (scroll to load more).`
      : 'No rows in the latest sold-data file(s).'
  );
}

// Append the next chunk of groups
function renderNextGroupsChunk() {
  const tbody = document.getElementById('trendsTableBody');
  if (!tbody) return;
  if (!TRENDS_GROUPS.length) return;

  const start = TRENDS_VISIBLE_COUNT;
  const end = Math.min(start + PAGE_GROUPS, TRENDS_GROUPS.length);
  for (let i = start; i < end; i++) {
    appendGroupDOM(tbody, TRENDS_GROUPS[i], i+1);
  }
  TRENDS_VISIBLE_COUNT = end;

  // Update summary incrementally
  const totalGroups = TRENDS_GROUPS.length;
  const totalRows = TRENDS_FILTERED_ROWS.length;
  setTrendsSummary(
    totalRows
      ? `Showing ${TRENDS_VISIBLE_COUNT} of ${totalGroups} vehicles â€¢ ${totalRows} total sales${TRENDS_VISIBLE_COUNT<totalGroups?' â€¢ keep scrollingâ€¦':''}`
      : 'No rows in the latest sold-data file(s).'
  );
}

function buildTrendsSortableHeaders(){
  const thead = document.querySelector('#trendsTable thead');
  if (!thead) return;
  const headerRow = thead.querySelector('tr');
  if (!headerRow) return;

  const ths = Array.from(headerRow.querySelectorAll('th'));
  ths.forEach(th => {
    // add caret span once
    if (!th.querySelector('.sort-caret')) {
      const caret = document.createElement('span');
      caret.className = 'sort-caret';
      caret.textContent = '';
      th.appendChild(caret);
    }
    th.addEventListener('click', () => {
      const col = th.textContent.replace(/â–¼|â–²/g,'').trim();
      if (!col) return;

      if (TRENDS_SORT.col === col) {
        TRENDS_SORT.dir = (TRENDS_SORT.dir === 'asc') ? 'desc' : 'asc';
      } else {
        TRENDS_SORT.col = col;
        TRENDS_SORT.dir = ['Date Sold','Last Sold Price','Total Sold'].includes(col) ? 'desc' : 'asc';
      }

      const q = document.getElementById('trendsSearch')?.value || '';
      const base = TRENDS_LATEST_ALL_ROWS.filter(r => matchesQuery(r, q));
      renderTrendsLatestPagedReset(base); // buildGroups() will apply sort
      updateTrendsSortCarets();
    }, { passive:true });
  });

  updateTrendsSortCarets();
}

function updateTrendsSortCarets(){
  const headerRow = document.querySelector('#trendsTable thead tr');
  if (!headerRow) return;
  Array.from(headerRow.children).forEach(th => {
    const label = th.textContent.replace(/â–¼|â–²/g,'').trim();
    const caret = th.querySelector('.sort-caret');
    if (!caret) return;
    if (label === TRENDS_SORT.col) {
      caret.textContent = (TRENDS_SORT.dir === 'asc') ? 'â–²' : 'â–¼';
    } else {
      caret.textContent = '';
    }
  });
}


// Hook Infinite Scroll on the scroll container
function ensureTrendsInfiniteScroll() {
  if (TRENDS_SCROLL_EL) return; // already wired
  TRENDS_SCROLL_EL = document.getElementById('trendsScroll') || window;
  const targetEl = document.getElementById('trendsScroll');

  const onScroll = () => {
    const el = targetEl;
    // Near bottom?
    const nearBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 100;
    if (nearBottom && TRENDS_VISIBLE_COUNT < TRENDS_GROUPS.length) {
      renderNextGroupsChunk();
    }
  };

  // If we have a dedicated scroll div, listen on it; else listen on window
  if (targetEl) {
    targetEl.addEventListener('scroll', onScroll);
  } else {
    window.addEventListener('scroll', onScroll);
  }
}




// Main loader for Trends (latest only)
async function refreshTrends() {
  setTrendsSummary('Loading latest sold dataâ€¦');
  const locKey = getTrendsLocKey(); // 'all' | 'vehicles_of_interest' | yard | '' (auto before jalopy)
  const index = await loadEbayIndex();

  if (!index.length) {
    setTrendsSummary('No files listed in ebay-sales.json.');
    renderTrendsLatestPagedReset([]);
    return;
  }

  const targets = pickLatestTargets(index, locKey);
  if (!targets.length) {
    setTrendsSummary('No latest sold-data file found for the selected yard.');
    renderTrendsLatestPagedReset([]);
    return;
  }

  // Load and combine
  let totalRows = 0, used = [];
  const combined = [];
  for (const { yard, file } of targets) {
    const path = file.includes('/') ? file : `./ebay-sales/${file}`;
    try {
      const raw = await parseCSV(path);
      const normRows = raw.map(normalizeSoldRow).filter(keepRowByTitleTerm);
      normRows.forEach(n => combined.push({ ...n, _yard: yard }));
      used.push(`${yard}:${file}`);
      totalRows += normRows.length;
    } catch (e) {
      console.warn('[Trends/latest] Failed to parse', path, e);
    }
  }

  renderTrendsLatestPagedReset(combined);
  renderTrendsLatestPagedReset(combined);
  TRENDS_LATEST_ALL_ROWS = combined;
  const q = document.getElementById('trendsSearch')?.value || '';
  const filtered = TRENDS_LATEST_ALL_ROWS.filter(r => matchesQuery(r, q));
  renderTrendsLatestPagedReset(filtered);
  renderTrendsHeatmap(filtered);
  ensureTrendsInfiniteScroll();
  buildTrendsSortableHeaders();
  updateTrendsSortCarets();

  setTrendsSummary(
    totalRows
      ? `Loaded ${totalRows} rows from latest file${targets.length>1?'s':''}. (${used.join(' â€¢ ')})`
      : 'No rows found in the latest file(s).'
  );

  // Debug
  console.debug('[Trends/latest] locKey:', locKey, 'targets:', targets);
}

// Wire up: refresh on tab show, button, and yard changes
document.addEventListener('DOMContentLoaded', () => {
  // Refresh when Trends tab becomes visible
  document.querySelector('button[data-bs-target="#trendsTab"]')
    ?.addEventListener('shown.bs.tab', refreshTrends);

  // Optional: a "Refresh" button you might have in Trends controls
  document.getElementById('refreshTrendsBtn')
    ?.addEventListener('click', refreshTrends);

  // If yard selector exists in Trends, refresh on change
  document.getElementById('trendsYard')
    ?.addEventListener('change', () => {
      const active = document.querySelector('#trendsTab.show');
      if (active) refreshTrends();
    });

  // If following Jalopy (Auto) and Jalopy yard changes, refresh only if Trends is visible
  document.getElementById('csvSelector')
    ?.addEventListener('change', () => {
      const isAuto = (document.getElementById('trendsYard')?.value || 'auto') === 'auto';
      const active = document.querySelector('#trendsTab.show');
      if (isAuto && active) refreshTrends();
    });
	
	const trendsSearch = document.getElementById('trendsSearch');
    if (trendsSearch){
      const runFilter = debounce(() => {
        const q = trendsSearch.value || '';
        const filtered = TRENDS_LATEST_ALL_ROWS.filter(r => matchesQuery(r, q));
        renderTrendsLatestPagedReset(filtered);
        renderTrendsHeatmap(filtered);
      }, 250); // Use consistent debounce
      trendsSearch.addEventListener('input', runFilter);
    }
    buildTrendsSortableHeaders();
});
</script>




  <!-- ===== Sticky Notes JS (non-intrusive; waits until unlocked) ===== -->
  <script>
  (() => {
    const STICKY_KEY = 'profitStickyNotes';
    const STICKY_Z   = 'profitStickyZ';
    let stickyZCounter = parseInt(localStorage.getItem(STICKY_Z) || '2100', 10);

    const save = (arr) => localStorage.setItem(STICKY_KEY, JSON.stringify(arr));
    const load = () => { try { return JSON.parse(localStorage.getItem(STICKY_KEY) || '[]'); } catch { return []; } };
    const front = (el) => { stickyZCounter += 1; el.style.zIndex = stickyZCounter; localStorage.setItem(STICKY_Z, String(stickyZCounter)); };

    function createStickyDOM(sticky, persist=true) {
      const el = document.createElement('div');
      el.className = `sticky-note ${sticky.color || 'yellow'}`;
      el.dataset.id = sticky.id;
      el.style.left = (sticky.x ?? 120) + 'px';
      el.style.top  = (sticky.y ?? 120) + 'px';
      el.style.width  = (sticky.w ?? 220) + 'px';
      el.style.height = (sticky.h ?? 160) + 'px';
      el.style.zIndex = sticky.z ?? (stickyZCounter += 1);

      const header = document.createElement('div');
      header.className = 'sticky-header';
      header.innerHTML = `
        <span class="sticky-title"><i class="bi bi-grip-vertical me-1"></i> Note</span>
        <div class="sticky-actions btn-group">
          <button class="btn btn-light btn-sm dropdown-toggle" data-bs-toggle="dropdown" title="Color">
            <span class="sticky-color sticky-${sticky.color || 'yellow'}"></span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" data-color="yellow"><span class="sticky-color sticky-yellow me-2"></span>Yellow</a></li>
            <li><a class="dropdown-item" data-color="blue"><span class="sticky-color sticky-blue me-2"></span>Blue</a></li>
            <li><a class="dropdown-item" data-color="pink"><span class="sticky-color sticky-pink me-2"></span>Pink</a></li>
            <li><a class="dropdown-item" data-color="green"><span class="sticky-color sticky-green me-2"></span>Green</a></li>
          </ul>
          <button class="btn btn-outline-danger btn-sm" title="Delete"><i class="bi bi-trash"></i></button>
        </div>
      `;

      const body = document.createElement('div');
      body.className = 'sticky-body';
      body.contentEditable = 'true';
      body.innerText = sticky.text || '';

      el.appendChild(header);
      el.appendChild(body);
      document.body.appendChild(el);

      // drag
      let dragging = false, startX=0, startY=0, baseX=0, baseY=0;
      header.addEventListener('mousedown', (e) => {
        dragging = true;
        front(el);
        startX = e.clientX; startY = e.clientY;
        baseX = parseInt(el.style.left,10); baseY = parseInt(el.style.top,10);
        e.preventDefault();
      });
      document.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        const dx = e.clientX - startX, dy = e.clientY - startY;
        el.style.left = (baseX + dx) + 'px';
        el.style.top  = (baseY + dy) + 'px';
      });
      document.addEventListener('mouseup', () => {
        if (!dragging) return;
        dragging = false;
        persistPositionSize(el);
      });

      // resize persistence
      const resizeObserver = new ResizeObserver(() => persistPositionSize(el));
      resizeObserver.observe(el);

      // focus brings to front
      body.addEventListener('focus', () => front(el));

      // text save (debounced)
      let t;
      body.addEventListener('input', () => {
        clearTimeout(t);
        t = setTimeout(() => {
          const all = load();
          const idx = all.findIndex(s => s.id === sticky.id);
          if (idx >= 0) {
            all[idx].text = body.innerText;
            save(all);
          }
        }, 250);
      });

      // color change
      header.querySelectorAll('.dropdown-menu .dropdown-item').forEach(a => {
        a.addEventListener('click', () => {
          const color = a.getAttribute('data-color');
          el.classList.remove('yellow','blue','pink','green');
          el.classList.add(color);
          header.querySelector('.sticky-color').className = `sticky-color sticky-${color}`;
          const all = load();
          const idx = all.findIndex(s => s.id === sticky.id);
          if (idx >= 0) { all[idx].color = color; save(all); }
        });
      });

      // delete
      header.querySelector('.btn-outline-danger').addEventListener('click', () => {
        const all = load().filter(s => s.id !== sticky.id);
        save(all);
        el.remove();
      });

      function persistPositionSize(elRef) {
        const rect = elRef.getBoundingClientRect();
        const all = load();
        const idx = all.findIndex(s => s.id === sticky.id);
        if (idx >= 0) {
          all[idx].x = Math.max(0, Math.round(rect.left));
          all[idx].y = Math.max(0, Math.round(rect.top));
          all[idx].w = Math.round(rect.width);
          all[idx].h = Math.round(rect.height);
          all[idx].z = parseInt(elRef.style.zIndex || '2100', 10);
          save(all);
        }
      }

      // initial persist if new
      if (persist) {
        const all = load();
        all.push(sticky);
        save(all);
      }

      return el;
    }

    function addSticky(defaults={}) {
      const id = 's_' + Date.now() + '_' + Math.floor(Math.random()*1000);
      const base = {
        id, text:'', x: 140 + Math.floor(Math.random()*80), y: 120 + Math.floor(Math.random()*80),
        w: 220, h: 160, color: 'yellow', z: ++stickyZCounter
      };
      localStorage.setItem(STICKY_Z, String(stickyZCounter));
      createStickyDOM({ ...base, ...defaults }, true);
    }

    function renderAllStickies() {
      load().forEach(s => createStickyDOM(s, false));
      const fab = document.getElementById('stickyFab'); if (fab) fab.style.display = '';
    }

    // quick actions
    function wireUI() {
      document.getElementById('addStickyBtn')?.addEventListener('click', () => addSticky());
      document.getElementById('fabAddSticky')?.addEventListener('click', () => addSticky());
      document.getElementById('fabClearStickies')?.addEventListener('click', () => {
        if (!confirm('Delete all sticky notes?')) return;
        localStorage.setItem(STICKY_KEY, '[]');
        document.querySelectorAll('.sticky-note').forEach(n => n.remove());
      });
      document.addEventListener('keydown', (e) => {
        if (e.shiftKey && (e.key === 'N' || e.key === 'n')) {
          e.preventDefault(); addSticky();
        }
      });
    }

    // Wait until blur (serial-locked) is removed, then init stickies
    function whenUnlocked(fn) {
      if (!document.body.classList.contains('serial-locked')) { fn(); return; }
      const mo = new MutationObserver(() => {
        if (!document.body.classList.contains('serial-locked')) { mo.disconnect(); fn(); }
      });
      mo.observe(document.body, { attributes:true, attributeFilter:['class'] });
    }

    // Boot
    document.addEventListener('DOMContentLoaded', () => {
      wireUI();
      whenUnlocked(() => renderAllStickies());
    });
  })();
  </script>
  
  <script>
  // ---------- HEATMAP (Make Ã— Year; metric = count of sales) ----------
let TRENDS_HEATMAP_LAST = []; // cache last rows for resize re-render

function renderTrendsHeatmap(rows){
  TRENDS_HEATMAP_LAST = rows || [];
  const noteEl = document.getElementById('trendsHeatmapNote');
  const cv = document.getElementById('trendsHeatmapCanvas');
  if (!cv) return;
  const ctx = cv.getContext('2d');

  // Clear
  ctx.clearRect(0, 0, cv.width, cv.height);

  // Guard
  const valid = (rows||[]).filter(r => r && r.make && r.year);
  if (!valid.length){
    if (noteEl) noteEl.textContent = 'Nothing to show (no rows with Make + Year).';
    return;
  }

  // Aggregate: count by Make Ã— Year
  const yearsSet = new Set();
  const perKey = new Map(); // key = make|year -> count
  const perMakeTotal = new Map();

  valid.forEach(r => {
    const y = parseInt(String(r.year).replace(/[^\d]/g,''),10);
    const make = String(r.make || '').trim();
    if (!make || isNaN(y)) return;
    yearsSet.add(y);
    const key = make+'|'+y;
    perKey.set(key, (perKey.get(key)||0)+1);
    perMakeTotal.set(make, (perMakeTotal.get(make)||0)+1);
  });

  const years = Array.from(yearsSet).sort((a,b)=>a-b);
  if (!years.length){
    if (noteEl) noteEl.textContent = 'Nothing to show (no valid Year values).';
    return;
  }

  // Pick top N makes by total volume
  const TOP_MAKES = 12;
  const makes = Array.from(perMakeTotal.entries())
    .sort((a,b)=>b[1]-a[1])
    .slice(0, TOP_MAKES)
    .map(([m])=>m);

  if (!makes.length){
    if (noteEl) noteEl.textContent = 'Nothing to show (no valid Make values).';
    return;
  }

  // Canvas sizing (fit container width)
  const parent = cv.parentElement || cv;
  const cssW = parent.clientWidth || 800;
  cv.width = cssW;

  // Layout
  const leftPad   = 90;     // y-axis labels (makes)
  const bottomPad = 28;     // x-axis labels (years)
  const rightPad  = 10;
  const topPad    = 8;

  const gridW = cv.width  - leftPad - rightPad;
  const gridH = cv.height - topPad   - bottomPad;

  const cols = years.length;
  const rowsCount = makes.length;
  const cw = Math.max(10, Math.floor(gridW / Math.max(1, cols)));
  const ch = Math.max(14, Math.floor(gridH / Math.max(1, rowsCount)));

  // Recompute grid size to tightly fit
  const usedW = cw * cols;
  const usedH = ch * rowsCount;
  const gx0 = leftPad + Math.floor((gridW - usedW)/2);
  const gy0 = topPad  + Math.floor((gridH - usedH)/2);

  // Find max value for color scale
  let vmax = 0;
  makes.forEach(m => years.forEach(y => {
    const v = perKey.get(m+'|'+y) || 0;
    if (v > vmax) vmax = v;
  }));

  // Color scale (0 -> light, max -> saturated)
  function colorFor(v){
    if (!vmax) return 'rgba(0,0,0,0.04)';
    const t = Math.max(0, Math.min(1, v / vmax));
    // HSL: from 210 (cool) to 10 (warm)
    const hue = 210 - 200 * t;
    const sat = 70;
    const lgt = 92 - 42 * t;
    return `hsl(${hue}, ${sat}%, ${lgt}%)`;
  }

  // Draw cells
  ctx.save();
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.textBaseline = 'middle';

  for (let ri=0; ri<rowsCount; ri++){
    for (let ci=0; ci<cols; ci++){
      const make = makes[ri];
      const year = years[ci];
      const v = perKey.get(make+'|'+year) || 0;
      const x = gx0 + ci*cw;
      const y = gy0 + ri*ch;

      ctx.fillStyle = colorFor(v);
      ctx.fillRect(x+0.5, y+0.5, cw-1, ch-1);

      // Optional tiny value text if big enough cell
      if (cw >= 28 && ch >= 18 && v){
        ctx.fillStyle = (v / vmax > 0.6) ? 'rgba(255,255,255,0.85)' : '#222';
        ctx.textAlign = 'center';
        ctx.fillText(String(v), x + cw/2, y + ch/2);
      }
    }
  }

  // Axis labels
  ctx.fillStyle = '#888';
  ctx.textAlign = 'right';
  for (let ri=0; ri<rowsCount; ri++){
    const make = makes[ri];
    const y = gy0 + ri*ch + ch/2;
    ctx.fillText(make, leftPad-8, y);
  }
  ctx.textAlign = 'center';
  for (let ci=0; ci<cols; ci++){
    const year = years[ci];
    const x = gx0 + ci*cw + cw/2;
    ctx.fillText(String(year), x, topPad + usedH + 14);
  }
  ctx.restore();

  // Note
  if (noteEl){
    noteEl.textContent =
      `Top ${makes.length} makes â€¢ ${years[0]}â€“${years[years.length-1]} â€¢ max cell ${vmax}`;
  }
}

// Re-render heatmap on resize (debounced)
(function(){
  let t;
  window.addEventListener('resize', () => {
    clearTimeout(t);
    t = setTimeout(() => renderTrendsHeatmap(TRENDS_HEATMAP_LAST), 120);
  });
})();

  </script>
  
<script>
/* ===== Pretty Print (Card layout) ===== */

function _plEmail(){ return localStorage.getItem('premiumEmail') || ''; }
function _plStamp(){ return new Date().toLocaleString(); }
function _plLogo(){ return window.CAC_LOGO_URL || ''; }

function groupRowsByYard(rows){
  const map = new Map();
  rows.forEach(r => {
    const y = r.Yard || 'Unknown Yard';
    if (!map.has(y)) map.set(y, []);
    map.get(y).push(r);
  });
  for (const [yard, arr] of map.entries()) {
    arr.sort((a,b) =>
      (a.Make||'').localeCompare(b.Make||'') ||
      (a.Model||'').localeCompare(b.Model||'') ||
      (parseInt(a.Year)||0) - (parseInt(b.Year)||0) ||
      String(a.Row||'').localeCompare(String(b.Row||''))
    );
  }
  return Array.from(map.entries()).map(([yard, items]) => ({ yard, items }))
               .sort((a,b) => a.yard.localeCompare(b.yard));
}

function buildCardHTML(r){
  const year  = r.Year || '';
  const make  = r.Make || '';
  const model = r.Model || '';
  const row   = r.Row || '';
  const yard  = r.Yard || '';
  const notes = (r.Notes || '').slice(0, 160);
  const parts = (r.Parts || '').replace(/; /g, '<br>â€¢ '); // Use Parts string

  return `
    <div class="pl-card">
      <div class="pl-top">
        <span class="pl-row-badge">ROW ${row || 'â€”'}</span>
        <span class="pl-yard-pill">${yard || 'â€”'}</span>
      </div>

      <div class="pl-titleline">
        <span class="pl-year">${year}</span>
        <span class="pl-make">${make}</span>
        <span class="pl-model">${model}</span>
      </div>

      ${notes ? `<div class="pl-notes"><span class="label">Notes:</span>${notes}</div>` : ``}
      ${parts ? `<div class="pl-notes"><span class="label">Parts:</span><br>â€¢ ${parts}</div>` : ``}

      <div class="pl-checks">
        <span><span class="pl-box"></span>Pulled</span>
        <span><span class="pl-box"></span>Condition</span>
        <span>Price $ <span class="pl-line sm"></span></span>
        <span>Bin <span class="pl-line sm"></span></span>
      </div>
    </div>
  `;
}

function buildSectionHTML(yard, items){
  const cards = items.map(buildCardHTML).join('');
  return `
    <section class="pl-section">
      <div class="pl-title">Pick List â€” ${yard}</div>
      <div class="pl-sub">Vehicles: ${items.length}</div>
      <div class="pl-grid">${cards}</div>
    </section>
  `;
}

function buildPickListPrintHTML_CARDS(mode='grouped', yardFilter=''){
  const root = document.getElementById('pickListPrintRoot');
  if (!root) return;

  let rows = (typeof gatherPickListRowsFromStorage === 'function')
    ? gatherPickListRowsFromStorage()
    : [];

  if (!rows.length) {
    root.innerHTML = '<div class="p-3">Pick List is empty.</div>';
    return;
  }

  if (mode === 'single' && yardFilter) {
    rows = rows.filter(r => (r.Yard || '') === yardFilter);
  }

  const sections = (mode === 'asis')
    ? [{ yard: 'As Entered', items: rows }]
    : groupRowsByYard(rows);

  const logo = _plLogo();
  const email = _plEmail();
  const ts = _plStamp();

  root.innerHTML = `
    <div class="pl-header">
      ${logo ? `<img src="${logo}" alt="Cars & Collectibles">` : ``}
      <div class="brand">PROFIT â€” Cars & Collectibles</div>
      <div class="meta">${email ? `User: ${email} â€¢ ` : ``}Generated: ${ts}</div>
    </div>

    <div class="pl-body">
      ${sections.map(s => buildSectionHTML(s.yard, s.items)).join('')}
    </div>

    <div class="pl-footer">
      <span>carsandcollectibles.com</span>
      <span class="right pageno"></span>
    </div>
  `;
}

function triggerPrintPickList_CARDS(defaultMode='grouped'){
  buildPickListPrintHTML_CARDS(defaultMode);
  document.body.classList.add('printing');
  const root = document.getElementById('pickListPrintRoot');
  if (root) root.style.display = 'block';
  window.print();
  setTimeout(() => {
    if (root) root.style.display = 'none';
    document.body.classList.remove('printing');
  }, 0);
}

/* Wire the existing button (replace previous handler if any) */
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('printPickListBtn');
  if (btn) {
    btn.onclick = () => triggerPrintPickList_CARDS('grouped');
  }
});
</script>

  
  
  
  
  
  
  
  <!-- Print container (built dynamically; hidden until print) -->
<div id="pickListPrintRoot" style="display:none"></div>
<script>
// ---------- Jalopy Inventory / Pricing subtabs + smart Pricing table ----------

let jalopyPricingData = [];
let jalopyPricingSort = { col: null, dir: 'asc' }; // col = one of section, part, asIsBool, carPriceNum, vanPriceNum, coreNum
let jalopyPricingSortingInitialized = false;

function initJalopySubtabs() {
  const buttons = Array.from(document.querySelectorAll('.jalopy-subtab-btn'));
  const panels  = Array.from(document.querySelectorAll('.jalopy-subtab'));

  if (!buttons.length || !panels.length) return;

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.getAttribute('data-jalopy-subtab');

      // toggle active button
      buttons.forEach(b => b.classList.toggle('active', b === btn));

      // show/hide panels
      panels.forEach(p => {
        p.style.display = (p.id === targetId) ? '' : 'none';
      });

      // lazy-load pricing on first open
      if (targetId === 'jalopyPricingSubtab') {
        if (!window._jalopyPricingLoaded) {
          window._jalopyPricingLoaded = true;
          loadJalopyPricing();
        }
      }
    });
  });
}

function loadJalopyPricing(callback) {
  const tbody = document.getElementById('jalopyPricingBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const csvPath = 'pricing/jalopy-prices.csv'; // adjust if needed

  Papa.parse(csvPath, {
    download: true,
    header: true,
    complete: function(result) {
      const rawRows = (result.data || []).filter(r => r.section || r.part);

      const normalized = rawRows.map(r => {
        const section = (r.section ?? r.Section ?? '').trim();
        const part    = (r.part ?? r.Part ?? '').trim();

        const rawAsIs = String(r.as_is ?? r.AS_IS ?? r.As_Is ?? '').toLowerCase();
        const asIsBool = (rawAsIs === 'true' || rawAsIs === '1' || rawAsIs === 'yes' || rawAsIs === 'y');

        const carRaw  = r.car_price ?? r.Car_Price ?? r['car price'] ?? '';
        const vanRaw  = r.van_suv_truck_price ?? r.Van_SUV_Truck_Price ?? r['van_suv_truck_price'] ?? '';
        const coreRaw = r.core ?? r.Core ?? '';

        const carNum  = parseFloat(carRaw)  || 0;
        const vanNum  = parseFloat(vanRaw)  || 0;
        const coreNum = parseFloat(coreRaw) || 0;

        return {
          section,
          part,
          asIsBool,
          carPriceRaw:  carRaw,
          vanPriceRaw:  vanRaw,
          coreRaw:      coreRaw,
          carPriceNum:  carNum,
          vanPriceNum:  vanNum,
          coreNum:      coreNum
        };
      });

      jalopyPricingData = normalized;

      // populate Section filter options
      populatePricingSectionFilter(normalized);

      // wire filters/search
      wirePricingFilters();

      // initial render
      applyPricingFilters();
      setupPricingSorting();

      // If a callback was provided (e.g., for the modal), run it now.
      if (typeof callback === 'function') {
        callback();
      }
    },
    error: function(err) {
      console.error('Error loading Jalopy pricing CSV:', err);
    }
  });
}

function populatePricingSectionFilter(rows) {
  const select = document.getElementById('pricingSectionFilter');
  if (!select) return;

  const sections = Array.from(
    new Set(
      rows
        .map(r => r.section)
        .filter(Boolean)
        .sort((a,b) => a.localeCompare(b))
    )
  );

  // keep the first "All sections" option
  select.innerHTML = '<option value="">All sections</option>';
  sections.forEach(sec => {
    const opt = document.createElement('option');
    opt.value = sec;
    opt.textContent = sec;
    select.appendChild(opt);
  });
}

function wirePricingFilters() {
  const sectionFilter = document.getElementById('pricingSectionFilter');
  const asIsFilter    = document.getElementById('pricingAsIsFilter');
  const searchInput   = document.getElementById('pricingSearch');

  if (sectionFilter) {
    sectionFilter.addEventListener('change', applyPricingFilters);
  }
  if (asIsFilter) {
    asIsFilter.addEventListener('change', applyPricingFilters);
  }
  if (searchInput) {
    searchInput.addEventListener('input', applyPricingFilters);
  }
}

function applyPricingFilters() {
  const sectionFilter = document.getElementById('pricingSectionFilter');
  const asIsFilter    = document.getElementById('pricingAsIsFilter');
  const searchInput   = document.getElementById('pricingSearch');

  const sectionVal = (sectionFilter?.value || '').trim();
  const asIsVal    = (asIsFilter?.value || '').trim(); // '', 'true', 'false'
  const searchVal  = (searchInput?.value || '').toLowerCase().trim();

  let rows = jalopyPricingData.slice();

  if (sectionVal) {
    rows = rows.filter(r => r.section === sectionVal);
  }

  if (asIsVal === 'true') {
    rows = rows.filter(r => r.asIsBool);
  } else if (asIsVal === 'false') {
    rows = rows.filter(r => !r.asIsBool);
  }

  if (searchVal) {
    rows = rows.filter(r => {
      const hay = [
        r.section,
        r.part,
        r.carPriceRaw,
        r.vanPriceRaw,
        r.coreRaw
      ].join(' ').toLowerCase();
      return hay.includes(searchVal);
    });
  }

  // apply sort, if any
  rows = sortPricingRows(rows);

  renderJalopyPricingTable(rows);
}

function sortPricingRows(rows) {
  const { col, dir } = jalopyPricingSort;
  if (!col) return rows;

  const mul = dir === 'desc' ? -1 : 1;
  const numericCols = new Set(['carPriceNum','vanPriceNum','coreNum']);

  const sorted = rows.slice().sort((a, b) => {
    const av = a[col];
    const bv = b[col];

    if (numericCols.has(col)) {
      const an = Number(av) || 0;
      const bn = Number(bv) || 0;
      if (an < bn) return -1 * mul;
      if (an > bn) return  1 * mul;
      return 0;
    } else {
      const as = String(av ?? '');
      const bs = String(bv ?? '');
      return as.localeCompare(bs) * mul;
    }
  });

  return sorted;
}

function renderJalopyPricingTable(rows) {
  const tbody = document.getElementById('jalopyPricingBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const fmtMoney = (v) => {
    const n = parseFloat(v);
    if (isNaN(n)) return v || '';
    return '$' + n.toFixed(2);
  };

  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.section}</td>
      <td>${r.part}</td>
      <td>${r.asIsBool ? 'Yes' : 'No'}</td>
      <td>${fmtMoney(r.carPriceRaw)}</td>
      <td>${fmtMoney(r.vanPriceRaw)}</td>
      <td>${fmtMoney(r.coreRaw)}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary add-part-to-pick-btn">
          <i class="bi bi-plus-circle"></i> Add
        </button>
      </td>
    `;
    const btn = tr.querySelector('.add-part-to-pick-btn');
    btn.addEventListener('click', () => openAddPartToPickModal(r));
    tbody.appendChild(tr);
  });
}

function setupPricingSorting() {
  if (jalopyPricingSortingInitialized) return;
  jalopyPricingSortingInitialized = true;

  const headerRow = document.querySelector('#jalopyPricingTable thead tr');
  if (!headerRow) return;

  const ths = Array.from(headerRow.querySelectorAll('th[data-pricing-col]'));
  ths.forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      const col = th.getAttribute('data-pricing-col');
      if (!col) return;

      if (jalopyPricingSort.col === col) {
        // toggle direction
        jalopyPricingSort.dir = (jalopyPricingSort.dir === 'asc') ? 'desc' : 'asc';
      } else {
        jalopyPricingSort.col = col;
        // default: numbers desc, text asc
        jalopyPricingSort.dir = ['carPriceNum','vanPriceNum','coreNum'].includes(col) ? 'desc' : 'asc';
      }

      applyPricingFilters();
      updatePricingSortHeaderStyles();
    });
  });

  updatePricingSortHeaderStyles();
}

function updatePricingSortHeaderStyles() {
  const headerRow = document.querySelector('#jalopyPricingTable thead tr');
  if (!headerRow) return;

  const ths = Array.from(headerRow.querySelectorAll('th[data-pricing-col]'));
  ths.forEach(th => {
    const col = th.getAttribute('data-pricing-col');
    let label = th.textContent.replace(/[â–²â–¼]/g,'').trim();
    if (col === jalopyPricingSort.col) {
      const caret = jalopyPricingSort.dir === 'asc' ? ' â–²' : ' â–¼';
      th.textContent = label + caret;
    } else {
      th.textContent = label;
    }
  });
}

let currentPartForPick = null;
let addPartToPickModalInstance = null;

let addPartsFromPickListModalInstance = null;
let currentVehicleForParts = null;
let modalPricingData = [];

function openAddPartToPickModal(partData) {
  currentPartForPick = partData;
  if (!addPartToPickModalInstance) {
    addPartToPickModalInstance = new bootstrap.Modal(document.getElementById('addPartToPickModal'));
  }

  const nameEl = document.getElementById('partToPickName');
  const listEl = document.getElementById('pickListForPart');
  const emptyEl = document.getElementById('pickListForPartEmpty');
  listEl.innerHTML = '';

  if (nameEl) {
    nameEl.textContent = `${partData.part} (${partData.section})`;
  }

  const pickList = getPickList();

  if (pickList.length === 0) {
    listEl.style.display = 'none';
    emptyEl.style.display = 'block';
  } else {
    listEl.style.display = 'block';
    emptyEl.style.display = 'none';
    pickList.forEach((vehicle, index) => {
      const key = ['Year','Make','Model','Row'].map(k => String(vehicle[k]).trim()).join('|');
      const label = document.createElement('label');
      label.className = 'list-group-item';
      label.innerHTML = `
        <input class="form-check-input me-2" type="checkbox" name="pickVehicle" value="${key}">
        ${vehicle.Year} ${vehicle.Make} ${vehicle.Model} (Row ${vehicle.Row}, ${vehicle.Yard})
      `;
      listEl.appendChild(label);
    });
  }

  addPartToPickModalInstance.show();
}

function confirmAddPartToPick() {
  const selectedVehicleCheckboxes = document.querySelectorAll('input[name="pickVehicle"]:checked');
  if (selectedVehicleCheckboxes.length === 0 || !currentPartForPick) {
    alert('Please select at least one vehicle from your pick list.');
    return;
  }

  let pickList = getPickList();
  let changesMade = false;

  selectedVehicleCheckboxes.forEach(checkbox => {
    const selectedVehicleKey = checkbox.value;
    const vehicleIndex = pickList.findIndex(v => ['Year','Make','Model','Row'].map(k => v[k]).join('|') === selectedVehicleKey);

    if (vehicleIndex > -1) {
      if (!pickList[vehicleIndex].parts) {
        pickList[vehicleIndex].parts = [];
      }
      // Prevent adding duplicate parts
      const partExists = pickList[vehicleIndex].parts.some(p => p.section === currentPartForPick.section && p.part === currentPartForPick.part);
      if (!partExists) {
        pickList[vehicleIndex].parts.push(currentPartForPick);
        changesMade = true;
      }
    }
  });

  savePickList(pickList);
  if (changesMade) {
    loadPickListData();
    updatePickListGrandTotal();
  }
  addPartToPickModalInstance.hide();
}

function openAddPartsFromPickListModal(vehicleData) {
  currentVehicleForParts = vehicleData;
  if (!addPartsFromPickListModalInstance) {
    addPartsFromPickListModalInstance = new bootstrap.Modal(document.getElementById('addPartsFromPickListModal'));
  }

  const nameEl = document.getElementById('vehicleForPartsName');
  if (nameEl) {
    nameEl.textContent = `${vehicleData.Year} ${vehicleData.Make} ${vehicleData.Model} (Row ${vehicleData.Row})`;
  }

  // If pricing data is loaded, render the modal table. Otherwise, it will be rendered when loaded.
  if (jalopyPricingData.length > 0) {
    setupModalForAddingParts();
  } else {
    // If pricing data isn't loaded, load it now for the modal.
    loadJalopyPricing(() => setupModalForAddingParts());
  }

  addPartsFromPickListModalInstance.show();
}

function setupModalForAddingParts() {
    modalPricingData = [...jalopyPricingData]; // Use a copy for modal state
    populateModalPricingSectionFilter(modalPricingData);
    applyModalPricingFilters(); // Use apply to render with default filters
}

function populateModalPricingSectionFilter(rows) {
  const select = document.getElementById('modalPricingSectionFilter');
  if (!select) return;

  const sections = Array.from(new Set(rows.map(r => r.section).filter(Boolean).sort((a,b) => a.localeCompare(b))));
  select.innerHTML = '<option value="">All sections</option>';
  sections.forEach(sec => {
    const opt = document.createElement('option');
    opt.value = sec;
    opt.textContent = sec;
    select.appendChild(opt);
  });
}

function applyModalPricingFilters() {
  const sectionVal = document.getElementById('modalPricingSectionFilter')?.value || '';
  const asIsVal = document.getElementById('modalPricingAsIsFilter')?.value || '';
  const searchVal = (document.getElementById('modalPricingSearch')?.value || '').toLowerCase().trim();

  let rows = modalPricingData.slice();

  if (sectionVal) rows = rows.filter(r => r.section === sectionVal);
  if (asIsVal === 'true') rows = rows.filter(r => r.asIsBool);
  else if (asIsVal === 'false') rows = rows.filter(r => !r.asIsBool);

  if (searchVal) {
    rows = rows.filter(r => [r.section, r.part, r.carPriceRaw, r.vanPriceRaw, r.coreRaw].join(' ').toLowerCase().includes(searchVal));
  }

  renderModalPricingTable(rows);
}

function renderModalPricingTable(rows) {
  const thead = document.querySelector('#modalJalopyPricingTable thead');
  const tbody = document.querySelector('#modalJalopyPricingTable tbody');
  if (!tbody || !thead) return;

  thead.innerHTML = `<tr><th><input type="checkbox" title="Select All"></th><th>Section</th><th>Part</th><th>AS IS</th><th>Car Price</th><th>Van/SUV Price</th><th>Core</th></tr>`;
  tbody.innerHTML = '';

  const fmtMoney = (v) => isNaN(parseFloat(v)) ? (v || '') : '$' + parseFloat(v).toFixed(2);

  rows.forEach((r, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="part-select-checkbox" data-index="${index}"></td>
      <td>${r.section}</td>
      <td>${r.part}</td>
      <td>${r.asIsBool ? 'Yes' : 'No'}</td>
      <td>${fmtMoney(r.carPriceRaw)}</td>
      <td>${fmtMoney(r.vanPriceRaw)}</td>
      <td>${fmtMoney(r.coreRaw)}</td>
    `;
    tbody.appendChild(tr);
  });

  // "Select All" checkbox logic
  const selectAll = thead.querySelector('input[type="checkbox"]');
  selectAll.addEventListener('change', (e) => {
    tbody.querySelectorAll('.part-select-checkbox').forEach(cb => cb.checked = e.target.checked);
  });
}

function confirmAddPartsFromPickList() {
  if (!currentVehicleForParts) return;

  const selectedCheckboxes = document.querySelectorAll('#modalJalopyPricingTable .part-select-checkbox:checked');
  if (selectedCheckboxes.length === 0) {
    alert('No parts selected.');
    return;
  }

  const tbody = document.querySelector('#modalJalopyPricingTable tbody');
  const partsToAdd = Array.from(selectedCheckboxes).map(cb => {
    const index = parseInt(cb.dataset.index, 10);
    // This assumes the currently displayed (and filtered) rows in the modal are a subset of `modalPricingData`
    // A safer approach is to filter `modalPricingData` again to get the displayed rows and find the part.
    // For simplicity, we'll assume the indices match the `rows` passed to `renderModalPricingTable`.
    // A more robust way would be to store the full part object or a unique ID on the checkbox.
    // Let's find the part from the full `jalopyPricingData` list to be safe.
    const partData = jalopyPricingData.find(p => p.section === tbody.rows[index].cells[1].textContent && p.part === tbody.rows[index].cells[2].textContent);
    return partData;
  }).filter(Boolean);

  let pickList = getPickList();
  const vehicleKey = ['Year','Make','Model','Row'].map(k => currentVehicleForParts[k]).join('|');
  const vehicleIndex = pickList.findIndex(v => ['Year','Make','Model','Row'].map(k => v[k]).join('|') === vehicleKey);

  if (vehicleIndex > -1) {
    if (!pickList[vehicleIndex].parts) pickList[vehicleIndex].parts = [];
    partsToAdd.forEach(part => {
      if (!pickList[vehicleIndex].parts.some(p => p.section === part.section && p.part === part.part)) {
        pickList[vehicleIndex].parts.push(part);
      }
    });
    savePickList(pickList);
    loadPickListData(); // Re-render the pick list to show the new parts
    updatePickListGrandTotal(); // Update the grand total
    addPartsFromPickListModalInstance.hide();
  }
}

document.addEventListener('DOMContentLoaded', initJalopySubtabs);
document.getElementById('confirmAddPartToPick')?.addEventListener('click', confirmAddPartToPick);

// Wire up new modal's controls
document.getElementById('modalPricingSectionFilter')?.addEventListener('change', applyModalPricingFilters);
document.getElementById('modalPricingAsIsFilter')?.addEventListener('change', applyModalPricingFilters);
document.getElementById('modalPricingSearch')?.addEventListener('input', debounce(applyModalPricingFilters, 250)); // This one is OK as it's in a one-time setup
document.getElementById('confirmAddPartsFromPickList')?.addEventListener('click', confirmAddPartsFromPickList);
</script>
<script>
  // ---------- QR Sync Tab Logic ----------
  let html5QrCode = null;
  let qrCodeInstance = null;

  function initQrSyncTab() {
    const generateBtn = document.getElementById('generateQrBtn');
    const qrTabBtn = document.querySelector('button[data-bs-target="#qrSyncTab"]');

    if (generateBtn) {
      generateBtn.addEventListener('click', generateAndShowQrCode);
    }

    if (qrTabBtn) {
      qrTabBtn.addEventListener('shown.bs.tab', () => {
        // When tab is shown, generate the QR code and start the scanner
        generateAndShowQrCode();
        startQrScanner();
      });
      qrTabBtn.addEventListener('hidden.bs.tab', stopQrScanner);
    }
  }

  function generateAndShowQrCode() {
    const container = document.getElementById('qrCodeContainer');
    if (!container) return;

    const dataCode = getDataCode();
    container.innerHTML = ''; // Clear previous QR code

    if (qrCodeInstance) {
      qrCodeInstance.clear();
      qrCodeInstance.makeCode(dataCode);
    } else {
      qrCodeInstance = new QRCode(container, {
        text: dataCode,
        width: 256,
        height: 256,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.M // Medium correction for density
      });
    }
  }

  function startQrScanner() {
    const statusEl = document.getElementById('qrScanStatus');
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode("qrScannerContainer");
    }

    const onScanSuccess = (decodedText, decodedResult) => {
      stopQrScanner();
      statusEl.textContent = `âœ… Scan successful! Importing data...`;
      applyDataCode(decodedText); // Use existing function to apply data
    };

    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess)
      .then(() => statusEl.textContent = "Scanner started. Point camera at a QR code.")
      .catch(err => statusEl.textContent = `âŒ Error starting scanner: ${err}`);
  }

  function stopQrScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
      html5QrCode.stop().then(() => {
        document.getElementById('qrScanStatus').textContent = 'Scanner stopped.';
      }).catch(err => console.warn("QR scanner stop error:", err));
    }
    // Also reset the QR code instance to ensure it's recreated on next view
    if (qrCodeInstance) {
      document.getElementById('qrCodeContainer').innerHTML = '';
      qrCodeInstance = null;
    }
  }
</script>

</body>
</html>