<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PROFIT - Parts Resale Optimization &amp; Field Inventory Tool</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body.dark-mode { background-color: #121212; color: #f1f1f1; }
    body.dark-mode .table { color: #f1f1f1; }
    body.dark-mode .table-dark { background-color: #2c2c2c; }
    /* orange hover on rows */
    #inventoryTable tbody tr:hover td,
    #myInventoryTable tbody tr:hover td {
      background-color: orange !important;
      color: #000;
    }
    th { cursor: pointer; }
    .display-1:hover { color: orange; cursor: pointer; }
    .btn.disabled-look { opacity: 0.5; cursor: not-allowed; }
    /* Dark-mode styling for modals */
    .dark-mode .modal-content,
    .dark-mode .modal-content .modal-header,
    .dark-mode .modal-content .modal-body,
    .dark-mode .modal-content .modal-footer {
      background-color: #2c2c2c;
      color: #f1f1f1;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <div class="display-1">PROFIT</div>
        <div class="h5">Parts Resale Optimization &amp; Field Inventory Tool</div>
      </div>
      <div>
        <button class="btn btn-outline-primary me-2" id="unlockBtn">Unlock Premium Features</button>
        <button class="btn btn-outline-secondary me-2 disabled-look" id="settingsBtn">⚙️ Settings</button>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tableTab" type="button">Inventory Table</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#statsTab" type="button">Statistics</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#myInventoryTab" type="button">My Inventory</button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content pt-3">
      <!-- Inventory Table Tab -->
      <div class="tab-pane fade show active" id="tableTab">
        <div class="mb-3">
          <label for="csvSelector" class="form-label">Select Inventory CSV</label>
          <select class="form-select" id="csvSelector"></select>
        </div>
        <div class="mb-3">
          <input type="text" id="searchInput" class="form-control" placeholder="Filter rows...">
        </div>
        <div class="mb-3">
          <button class="btn btn-success disabled-look" id="exportBtn">Export Table to CSV</button>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-bordered" id="inventoryTable">
            <thead class="table-dark"><tr id="tableHeader"></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Statistics Tab -->
      <div class="tab-pane fade" id="statsTab">
        <div id="statistics"></div>
        <canvas id="ageChart" style="max-width:100%; margin-top:1em;"></canvas>
      </div>

      <!-- My Inventory Tab -->
      <div class="tab-pane fade" id="myInventoryTab">
        <div class="mb-3">
          <button class="btn btn-outline-primary disabled-look" id="addInventoryRow">Add Row</button>
          <button class="btn btn-outline-success disabled-look" id="exportMyInventory">Export My Inventory to CSV</button>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-bordered" id="myInventoryTable">
            <thead class="table-dark">
              <tr>
                <th>Part</th>
                <th>List Price</th>
                <th>My Cost</th>
                <th>Shipping Cost</th>
                <th>Listing</th>
                <th>Quantity</th>
                <th>Profit</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="myInventoryBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Serial Key Modal -->
  <div class="modal fade" id="serialModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Enter Serial Key</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="serialInput" class="form-control" placeholder="Serial Key">
        <div id="serialFeedback" class="text-danger mt-2" style="display:none;">Invalid serial key.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="submitSerial">Submit</button>
      </div>
    </div></div>
  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="homeYardSelect" class="form-label">Home Yard</label>
          <select id="homeYardSelect" class="form-select">
            <option value="">-- select yard --</option>
            <option>Boise</option><option>Caldwell</option><option>Garden City</option><option>Nampa</option><option>Twin Falls</option>
          </select>
        </div>
        <button class="btn btn-outline-secondary w-100 mb-2" id="modalToggleDark">Toggle Dark Mode</button>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" id="saveSettings">Save Settings</button>
      </div>
    </div></div>
  </div>

  <!-- Notes Modal -->
  <div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <textarea id="noteInput" class="form-control" rows="4" placeholder="Enter your note here..."></textarea>
        <div id="noteLimitInfo" class="text-muted mt-2" style="display:none;">
          Notes are limited to 20 characters. Upgrade to premium for unlimited characters.
        </div>
        <div id="noteLengthFeedback" class="text-danger mt-2" style="display:none;">Max 20 characters for non-premium users.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-danger" id="clearNote">Clear Note</button>
        <button class="btn btn-primary" id="saveNote">Save Note</button>
      </div>
    </div></div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Premium feature state
    let isPremium = false, premiumName = '';
    let serialData = [];
    const unlockBtn = document.getElementById('unlockBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const modalToggleDark = document.getElementById('modalToggleDark');
    const exportBtn = document.getElementById('exportBtn');
    const addInventoryRowBtn = document.getElementById('addInventoryRow');
    const exportMyInvBtn = document.getElementById('exportMyInventory');
    const serialModal = new bootstrap.Modal(document.getElementById('serialModal'));
    const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));

    // Load & check serial keys
    fetch('json/serial-keys.json')
      .then(r => r.json())
      .then(data => { serialData = data; checkKey(); })
      .catch(console.error);

    function checkKey() {
      const key = localStorage.getItem('premiumKey');
      const entry = serialData.find(e => e.key === key);
      if (entry) {
        isPremium = true; premiumName = entry.name; enablePremium();
      }
    }

    unlockBtn.onclick = () => {
      document.getElementById('serialFeedback').style.display = 'none';
      document.getElementById('serialInput').value = '';
      serialModal.show();
    };
    document.getElementById('submitSerial').onclick = () => {
      const key = document.getElementById('serialInput').value.trim();
      const entry = serialData.find(e => e.key === key);
      if (entry) {
        localStorage.setItem('premiumKey', key);
        isPremium = true; premiumName = entry.name;
        serialModal.hide(); enablePremium(); alert(`Welcome, ${premiumName}!`);
      } else {
        document.getElementById('serialFeedback').style.display = 'block';
      }
    };

    function enablePremium() {
      settingsBtn.classList.remove('disabled-look');
      exportBtn.classList.remove('disabled-look');
      addInventoryRowBtn.classList.remove('disabled-look');
      exportMyInvBtn.classList.remove('disabled-look');
      unlockBtn.disabled = true;
      unlockBtn.textContent = `Premium: ${premiumName}`;
      applyHomeYardDefault();
      loadMyInventory(); // load saved data
    }

    // Dark mode toggle in modal
    modalToggleDark.onclick = () => {
      if (!isPremium) { alert('Dark mode is only available for premium users.'); return; }
      document.body.classList.toggle('dark-mode');
    };

    settingsBtn.onclick = () => {
      if (!isPremium) { alert('Settings are only available for premium users.'); return; }
      const sel = document.getElementById('homeYardSelect');
      sel.value = localStorage.getItem('homeYard') || '';
      settingsModal.show();
    };
    document.getElementById('saveSettings').onclick = () => {
      localStorage.setItem('homeYard', document.getElementById('homeYardSelect').value);
      settingsModal.hide();
      applyHomeYardDefault();
    };

    // Export CSV
    exportBtn.onclick = () => {
      if (!isPremium) { alert('Exporting is only available to premium users.'); return; }
      exportTableToCSV();
    };
    exportMyInvBtn.onclick = () => {
      if (!isPremium) { alert('Exporting is only available to premium users.'); return; }
      exportMyInventoryCSV();
    };

    // My Inventory logic
    function saveMyInventory() {
      const rows = Array.from(document.querySelectorAll('#myInventoryBody tr'))
        .map(tr => {
          const cells = tr.querySelectorAll('td, input, textarea');
          if (!cells[0].querySelector) return null; // skip blank
          const part = cells[0].querySelector('input').value.trim();
          if (!part) return null; // skip empty row
          return {
            part,
            listPrice: parseFloat(cells[1].querySelector('input').value) || 0,
            myCost: parseFloat(cells[2].querySelector('input').value) || 0,
            shipCost: parseFloat(cells[3].querySelector('input').value) || 0,
            listing: cells[4].querySelector('input').value.trim(),
            quantity: parseInt(cells[5].querySelector('input').value) || 0,
            profit: parseFloat(cells[6].textContent) || 0,
            notes: cells[7].querySelector('textarea').value.trim()
          };
        })
        .filter(r => r);
      localStorage.setItem('myInventoryData', JSON.stringify(rows));
    }

    function loadMyInventory() {
      const data = JSON.parse(localStorage.getItem('myInventoryData')||'[]');
      const tbody = document.getElementById('myInventoryBody');
      tbody.innerHTML = '';
      data.forEach(item => addMyInvRow(item));
      addMyInvRow(); // blank row
    }

    function addMyInvRow(item={}) {
      const tbody = document.getElementById('myInventoryBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="form-control part-input" value="${item.part||''}"/></td>
        <td><input type="number" step="0.01" class="form-control list-price" value="${item.listPrice||''}"/></td>
        <td><input type="number" step="0.01" class="form-control my-cost" value="${item.myCost||''}"/></td>
        <td><input type="number" step="0.01" class="form-control ship-cost" value="${item.shipCost||''}"/></td>
        <td><input class="form-control listing-input" value="${item.listing||''}"/></td>
        <td><input type="number" class="form-control quantity-input" value="${item.quantity||''}"/></td>
        <td class="profit-cell">0.00</td>
        <td><textarea class="form-control notes-input">${item.notes||''}</textarea></td>
      `;
      tbody.append(tr);
      ['list-price','my-cost','ship-cost','quantity-input','part-input'].forEach(cls=>{
        tr.querySelector(`.${cls}`).addEventListener('input',()=>{
          calcProfit(tr);
          saveMyInventory();
          // auto-add if last row filled
          const last = tbody.lastElementChild;
          if (last.querySelector('.part-input').value.trim()) {
            addMyInvRow();
          }
        });
      });
      tr.querySelector('.listing-input').addEventListener('input',saveMyInventory);
      tr.querySelector('.notes-input').addEventListener('input',saveMyInventory);
      calcProfit(tr);
    }

    function calcProfit(tr) {
      const lp = parseFloat(tr.querySelector('.list-price').value) || 0;
      const mc = parseFloat(tr.querySelector('.my-cost').value) || 0;
      const sc = parseFloat(tr.querySelector('.ship-cost').value) || 0;
      const q  = parseInt(tr.querySelector('.quantity-input').value) || 0;
      const profit = ((lp - mc - sc) * q).toFixed(2);
      tr.querySelector('.profit-cell').textContent = profit;
    }

    function exportMyInventoryCSV() {
      const data = JSON.parse(localStorage.getItem('myInventoryData')||'[]');
      if (!data.length) { alert('No data to export'); return; }
      const headers = ['Part','List Price','My Cost','Shipping Cost','Listing','Quantity','Profit','Notes'];
      const rows = data.map(r=>[
        r.part,r.listPrice,r.myCost,r.shipCost,r.listing,r.quantity,r.profit,r.notes
      ]);
      const csv = [headers, ...rows].map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'my_inventory.csv';
      document.body.append(a); a.click(); a.remove();
    }

    // Initialize dashboard...
    let notes = JSON.parse(localStorage.getItem('jalopyNotes')||'{}'),
        selectedRowKey=null, currentData=[], sortDirection={}, ageChart=null;
    async function listCSVFiles(){ /* ... existing logic ... */ }
    function applyHomeYardDefault(){ /* ... existing logic ... */ }
    function loadCSV(path){ /* ... existing logic ... */ }
    function renderTable(data){ /* ... existing logic ... */ }
    function sortTableByColumn(c){ /* ... existing logic ... */ }
    document.getElementById('saveNote').onclick = ()=>{ /* ... */ };
    document.getElementById('clearNote').onclick = ()=>{ /* ... */ };
    function exportTableToCSV(){ /* ... existing logic ... */ }
    function showStatistics(data){ /* ... existing logic ... */ }
    // Kick off
    listCSVFiles();
  </script>
</body>
</html>
