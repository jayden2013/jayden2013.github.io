<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PROFIT - Parts Resale Optimization & Field Inventory Tool</title>

  <!-- Bootstrap & libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

  <style>
    /* ---------- Theme / base ---------- */
    body.dark-mode { background-color:#121212; color:#f1f1f1; }
    body.dark-mode .table { color:#f1f1f1; }
    body.dark-mode .table-dark { background-color:#2c2c2c; }
    body.dark-mode .small, body.dark-mode .small a { color:#f0f0f0 !important; }

    th { cursor:pointer; }
    .display-1:hover { color:orange; cursor:pointer; }
    .btn.disabled-look { opacity:.5; cursor:not-allowed; }

    /* Hover highlight */
    #inventoryTable tbody tr:hover td,
    #trustyTable tbody tr:hover td { background-color:orange !important; color:#000; }

    /* Dark-mode styling for modals */
    .dark-mode .modal-content,
    .dark-mode .modal-content .modal-header,
    .dark-mode .modal-content .modal-body,
    .dark-mode .modal-content .modal-footer {
      background-color:#2c2c2c; color:#f1f1f1;
    }

    /* Nav active text orange */
    .nav-tabs .nav-link.active, .nav-pills .nav-link.active { color:orange !important; }

    /* ---------- App lock / blur ---------- */
    .serial-locked #appRoot { filter: blur(6px); pointer-events: none; user-select: none; }
    .serial-locked .modal { pointer-events: auto; }
    .force-show-modal .modal { display:block !important; opacity:1 !important; }
    .force-show-modal .modal-backdrop { display:block !important; opacity:.45 !important; }

    /* Login modal look */
    #serialGate .modal-content { border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,.35); }
    #serialGateBrand { font-weight: 800; letter-spacing: .5px; }

    .btn-premium { background-color:gold !important; border-color:goldenrod !important; color:#000 !important; }

    /* Small polish */
    .tab-card {
      background:#fff; border-radius:16px; border:1px solid rgba(0,0,0,.06);
      box-shadow:0 8px 24px rgba(0,0,0,.06); padding:16px;
    }
    .dark-mode .tab-card { background:#1b1b1b; border-color:#2a2a2a; box-shadow:none; }
    .table thead th { position: sticky; top: 0; z-index: 2; }
    .table-hover tbody tr { transition: transform .08s ease, box-shadow .12s ease; }
    .table-hover tbody tr:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,.06); }

    /* ---------- Sticky Notes ---------- */
    .sticky-note {
      position: fixed; /* viewport-level so they float over tabs */
      top: 120px; left: 120px;
      width: 220px; min-width: 160px; min-height: 120px;
      background: #fffbe6;
      border: 1px solid #e5d47b;
      border-radius: 10px;
      box-shadow: 0 10px 26px rgba(0,0,0,.15);
      display: flex; flex-direction: column;
      resize: both; overflow: hidden;
      z-index: 2000;
    }
    .sticky-note .sticky-header {
      display:flex; align-items:center; justify-content:space-between;
      gap:.5rem;
      padding: .35rem .5rem;
      background: rgba(0,0,0,.04);
      border-bottom: 1px solid rgba(0,0,0,.06);
      cursor: move;
      user-select:none;
    }
    .sticky-note .sticky-title {
      font-size: .9rem; font-weight:600; color:#444; margin:0;
    }
    .sticky-note .sticky-actions .btn {
      --bs-btn-padding-y: .1rem;
      --bs-btn-padding-x: .3rem;
      --bs-btn-font-size: .8rem;
    }
    .sticky-note .sticky-body {
      padding: .5rem .6rem .8rem .6rem;
      flex:1; overflow:auto;
    }
    .sticky-note .sticky-body[contenteditable="true"]:focus {
      outline: none;
    }
    .sticky-color {
      width: 14px; height: 14px; border-radius: 3px; display:inline-block; border:1px solid rgba(0,0,0,.2);
    }
    /* color themes */
    .sticky-note.yellow { background:#fffbe6; border-color:#e5d47b; }
    .sticky-note.blue   { background:#eaf3ff; border-color:#93b7f0; }
    .sticky-note.pink   { background:#ffeaf2; border-color:#f59bb5; }
    .sticky-note.green  { background:#e9ffe8; border-color:#98d79b; }

    /* dark mode tweaks */
    .dark-mode .sticky-note {
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border-color: rgba(255,255,255,.15);
    }
    .dark-mode .sticky-note .sticky-header { background: rgba(255,255,255,.06); border-bottom-color: rgba(255,255,255,.08); }
    .dark-mode .sticky-note .sticky-title { color:#e8e8e8; }

    /* FAB group (Add Sticky) */
    #stickyFab {
      position: fixed; right: 16px; bottom: 16px; z-index: 2100;
      display: none; gap: .5rem; flex-direction: column;
    }
  </style>
</head>

<body class="serial-locked"><!-- start locked -->

  <!-- ====== GATE / LOGIN MODAL ====== -->
  <div class="modal fade" id="serialGate" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3 p-md-4">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title" id="serialGateBrand">PROFIT Access</h5>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">Enter your serial key and email to unlock all features.</p>
          <div class="mb-2">
            <label class="form-label">Serial Key</label>
            <input id="serialInput" class="form-control form-control-lg" placeholder="e.g. ABC-123-XYZ">
          </div>
          <div class="mb-2">
            <label class="form-label">Email</label>
            <input id="emailInput" type="email" class="form-control form-control-lg" placeholder="you@example.com">
          </div>
          <div id="serialFeedback" class="text-danger small mt-1" style="display:none;">Invalid serial key or missing email.</div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button class="btn btn-primary w-100" id="submitSerial">Unlock</button>
        </div>
        <div class="text-center text-muted small mt-2">
          Need help? Contact <a href="https://carsandcollectibles.com" target="_blank">Cars &amp; Collectibles LLC</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== APP ROOT (blurred while locked) ====== -->
  <div id="appRoot">
    <div class="container py-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4 tab-card">
        <div>
          <div class="display-1 mb-1">PROFIT</div>
          <div class="h5">Parts Resale Optimization &amp; Field Inventory Tool</div>
          <div class="small">Cars and Collectibles LLC â€¢ <a href="https://carsandcollectibles.com" target="_blank">carsandcollectibles.com</a></div>
          <div class="small text-muted" id="signedInEmail" style="display:none;">Signed in as: <span id="signedInEmailValue"></span></div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" id="settingsBtn"><i class="bi bi-gear"></i> Settings</button>
          <button class="btn btn-outline-primary" id="addStickyBtn" title="Add Sticky (Shift+N)">
            <i class="bi bi-sticky"></i> Add Sticky
          </button>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#jalopyTab" type="button">Jalopy Jungle</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#trustyTab" type="button">Trusty</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pickListTab" type="button">Pick List</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#alertsTab" type="button">Alerts</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pricesTab" type="button">Prices</button>
        </li>
		<li class="nav-item">
			<button class="nav-link" data-bs-toggle="tab" data-bs-target="#trendsTab" type="button">Trends</button>
		</li>

      </ul>

      <!-- Tab Content -->
      <div class="tab-content pt-3">
        <!-- Jalopy -->
        <div class="tab-pane fade show active" id="jalopyTab">
          <div class="tab-card">
            <div class="mb-3">
              <select class="form-select" id="csvSelector"></select>
            </div>
            <div class="mb-3">
              <input type="text" id="searchInput" class="form-control" placeholder="Filter rows...">
            </div>
            <div class="mb-3">
              <button class="btn btn-success" id="exportBtn"><i class="bi bi-download"></i> Export Table to CSV</button>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover" id="inventoryTable">
                <thead class="table-dark"><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
              </table>
            </div>

            <div id="statistics" class="mt-3 small"></div>
            <canvas id="ageChart" style="max-width:100%; margin-top:1em;"></canvas>
          </div>
        </div>

        <!-- Trusty -->
        <div class="tab-pane fade" id="trustyTab">
          <div class="tab-card">
            <div class="mb-3">
              <select class="form-select" id="trustySelector"></select>
            </div>
            <div class="mb-3">
              <input type="text" id="trustySearchInput" class="form-control" placeholder="Filter rows...">
            </div>
            <div class="mb-3">
              <button class="btn btn-success" id="trustyExportBtn"><i class="bi bi-download"></i> Export Table to CSV</button>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover" id="trustyTable">
                <thead class="table-dark"><tr id="trustyTableHeader"></tr></thead>
                <tbody id="trustyTableBody"></tbody>
              </table>
            </div>

            <div id="trustyStatistics" class="mt-3 small"></div>
            <canvas id="trustyAgeChart" style="max-width:100%; margin-top:1em;"></canvas>
          </div>
        </div>

        <!-- Pick List -->
        <div class="tab-pane fade" id="pickListTab">
          <div class="tab-card">
            <div class="mb-3">
              <button class="btn btn-success" id="exportPickListBtn"><i class="bi bi-box-arrow-down"></i> Export Table to CSV</button>
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover" id="pickListTable">
                <thead class="table-dark">
                  <tr>
                    <th>Year</th>
                    <th>Make</th>
                    <th>Model</th>
                    <th>Row</th>
                    <th>Yard</th>
                    <th>Notes</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody id="pickListBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Alerts -->
        <div class="tab-pane fade" id="alertsTab">
          <div class="tab-card">
            <h5 class="mb-1">Vehicle Alert Signup</h5>
            <p class="text-muted mb-3">Receive notifications when vehicles matching your criteria are added at Jalopy Jungle or Trusty.</p>

            <form id="alertForm" class="row g-3">
              <!-- Email field removed: will be auto-inserted from serial sign-in -->
              <div class="col-md-6">
                <label class="form-label">Make(s)</label>
                <input type="text" name="makes" class="form-control" placeholder="e.g., Ford"/>
              </div>

              <div class="col-md-6">
                <label class="form-label">Model(s)</label>
                <input type="text" name="models" class="form-control" placeholder="e.g., Thunderbird"/>
              </div>

              <div class="col-md-6">
                <label class="form-label">Year Range</label>
                <input type="text" name="years" class="form-control" placeholder="e.g., 1994-1997"/>
              </div>

              <div class="col-md-6">
                <label class="form-label">Preferred Yard</label>
                <select name="yards" class="form-select">
                  <option value="">Any</option>
                  <option>Jalopy Jungle (Boise)</option>
                  <option>Jalopy Jungle (Nampa)</option>
                  <option>Jalopy Jungle (Caldwell)</option>
                  <option>Jalopy Jungle (Garden City)</option>
                  <option>Jalopy Jungle (Twin Falls)</option>
                  <option>Trusty Pick-A-Part</option>
                </select>
              </div>

              <div class="col-12">
                <button type="submit" class="btn btn-success w-100">Submit Alert</button>
              </div>
            </form>

            <p id="statusMsg" class="text-center mt-2 small text-muted"></p>
          </div>
        </div>

        <!-- Prices (placeholder) -->
        <div class="tab-pane fade" id="pricesTab">
          <div class="tab-card">
            <div class="text-muted">Coming soon: Prices</div>
          </div>
        </div>
		
		<!-- Trends -->
<div class="tab-pane fade" id="trendsTab">
  <div class="tab-card">
    <div class="d-flex flex-wrap gap-2 align-items-end mb-3">
      <div>
        <label class="form-label mb-1">Time Window</label>
        <select id="trendsWindow" class="form-select form-select-sm" style="width:140px">
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
      </div>
      <div>
        <label class="form-label mb-1">Min Sales</label>
        <input id="trendsMinCount" type="number" class="form-control form-control-sm" value="3" min="1" style="width:100px"/>
      </div>
      <div class="ms-auto">
        <button id="refreshTrendsBtn" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-arrow-repeat"></i> Refresh Trends
        </button>
      </div>
	  <div>
  <label class="form-label mb-1">Yard</label>
  <select id="trendsYard" class="form-select form-select-sm" style="width:200px">
    <option value="auto" selected>Auto (follow Jalopy)</option>
    <option value="all">All yards</option>
    <option value="vehicles_of_interest">Vehicles of Interest</option>
    <option value="boise">Boise</option>
    <option value="caldwell">Caldwell</option>
    <option value="garden_city">Garden City</option>
    <option value="nampa">Nampa</option>
    <option value="twin_falls">Twin Falls</option>
  </select>
</div>
      <div>
        <label class="form-label mb-1">Search</label>
        <input id="trendsSearch" class="form-control form-control-sm"
               placeholder="year, make, model, or search term">
      </div>


    </div>

    <div class="table-responsive" id="trendsScroll" style="max-height:60vh; overflow:auto;">
<!-- inside #trendsTab -->
<table class="table table-striped table-bordered table-hover" id="trendsTable">
  <thead class="table-dark">
    <tr>
      <th>Year</th>
	  <th>Make</th>
	  <th>Model</th>
      <th>Search Term</th>
      <th>Listing Title</th>
      <th>Last Sold Price</th>
      <th>Date Sold</th>
      <th>Time To Sell</th>
      <th>Total Sold</th>
    </tr>
  </thead>
  <tbody id="trendsTableBody"></tbody>
</table>

<div class="small text-muted mt-2" id="trendsSummary"></div>

    </div>

    <div class="small text-muted mt-2" id="trendsSummary"></div>
  </div>
</div>

		
      </div>
    </div>

    <!-- Export Pick List Modal -->
    <div class="modal fade" id="exportPickListModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Export Pick List</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="pickExportMode" id="exportAsIs" value="asis" checked>
              <label class="form-check-label" for="exportAsIs">
                Export the table as it is (current order)
              </label>
            </div>

            <div class="form-check mb-3">
              <input class="form-check-input" type="radio" name="pickExportMode" id="exportGrouped" value="grouped">
              <label class="form-check-label" for="exportGrouped">
                Export with vehicles grouped by Yard
              </label>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="radio" name="pickExportMode" id="exportSingleYard" value="single">
              <label class="form-check-label" for="exportSingleYard">
                Export only a single Yard
              </label>
            </div>

            <div class="mt-2">
              <select id="singleYardSelect" class="form-select" disabled>
                <option value="">Select Yardâ€¦</option>
              </select>
            </div>

            <div class="small text-muted mt-3">
              CSV columns: Year, Make, Model, Row, Yard, Notes
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-success" id="confirmExportPick">Export</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="homeYardSelect" class="form-label">Home Yard</label>
              <select id="homeYardSelect" class="form-select">
                <option value="">-- select yard --</option>
                <option>Boise</option>
                <option>Caldwell</option>
                <option>Garden City</option>
                <option>Nampa</option>
                <option>Twin Falls</option>
              </select>
            </div>

            <button class="btn btn-outline-secondary w-100 mb-2" id="modalToggleDark">Toggle Dark Mode</button>

            <!-- Favorites -->
            <hr>
            <div class="mb-3">
              <h6>ðŸŽ¯ Favorite Vehicles</h6>
              <div class="d-flex gap-2">
                <input id="favYearInput" type="number" class="form-control" placeholder="Year"/>
                <input id="favMakeInput" type="text" class="form-control" placeholder="Make"/>
                <input id="favModelInput" type="text" class="form-control" placeholder="Model"/>
                <button class="btn btn-sm btn-primary" id="addFavVehicleBtn">Add</button>
              </div>
              <ul id="favVehiclesList" class="list-group list-group-flush mt-2"></ul>
            </div>

            <!-- Data code sync -->
            <hr>
            <button class="btn btn-outline-primary w-100 mb-2" id="exportDataBtn">ðŸ“‹ Copy Data Code</button>
            <textarea id="dataCodeOutput" class="form-control mb-2" rows="3" readonly placeholder="Your data code will appear hereâ€¦"></textarea>
            <label for="dataCodeInput" class="form-label">Paste Data Code to Sync:</label>
            <textarea id="dataCodeInput" class="form-control mb-2" rows="3" placeholder="Paste someoneâ€™s data code hereâ€¦"></textarea>
            <button class="btn btn-primary w-100" id="importDataBtn">ðŸ”„ Import Data Code</button>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-primary" id="saveSettings">Save Settings</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Note</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea id="noteInput" class="form-control" rows="4" placeholder="Enter your note here..."></textarea>
            <div id="noteLimitInfo" class="text-muted mt-2" style="display:none;">Notes are limited to 20 characters. Upgrade to premium for unlimited characters.</div>
            <div id="noteLengthFeedback" class="text-danger mt-2" style="display:none;">Max 20 characters for non-premium users.</div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-danger" id="clearNote">Clear Note</button>
            <button class="btn btn-primary" id="saveNote">Save Note</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sold Data Modal -->
    <div class="modal fade" id="soldModal" tabindex="-1" aria-labelledby="soldModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="soldModalLabel">Sold Data</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="soldDataContainer">
              <table class="table table-striped table-bordered">
                <thead class="table-dark">
                  <tr>
                    <th>Search Term</th>
                    <th>Listing Title</th>
                    <th>Last Sold Price</th>
                    <th>Date Sold</th>
                    <th>Time To Sell</th>
                    <th>Total Sold</th>
                  </tr>
                </thead>
                <tbody id="soldDataBody"></tbody>
              </table>
            </div>
            <div id="soldDataEmpty" class="text-center text-muted" style="display:none;">
              No sold data found for this vehicle.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast container for favorite-vehicle alerts -->
    <div id="favToastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>
  </div><!-- /#appRoot -->

  <!-- Sticky FAB -->
  <div id="stickyFab" aria-hidden="true">
    <button class="btn btn-primary rounded-circle" id="fabAddSticky" title="Add Sticky (Shift+N)">
      <i class="bi bi-plus-lg"></i>
    </button>
    <button class="btn btn-outline-danger rounded-circle" id="fabClearStickies" title="Clear All Stickies">
      <i class="bi bi-trash"></i>
    </button>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /***********************
   * Premium / Serial Gate
   ***********************/
  let isPremium = false, premiumName = '';
  let serialData = []; // from json/serial-keys.json

  function getGateInstance() {
    return bootstrap.Modal.getOrCreateInstance(
      document.getElementById('serialGate'),
      { backdrop:'static', keyboard:false }
    );
  }
  function showGate() {
    document.body.classList.add('serial-locked');
    try {
      const inst = getGateInstance();
      inst.show();
      document.getElementById('serialGate')
        .addEventListener('shown.bs.modal', () => {
          const input = document.getElementById('serialInput');
          if (input) input.focus();
          // prefill saved values if any
          const savedKey = localStorage.getItem('premiumKey') || '';
          const savedEmail = localStorage.getItem('premiumEmail') || '';
          if (savedKey) document.getElementById('serialInput').value = savedKey;
          if (savedEmail) document.getElementById('emailInput').value = savedEmail;
        }, { once:true });
      setTimeout(() => {
        const gateEl = document.getElementById('serialGate');
        if (!gateEl.classList.contains('show')) {
          document.body.classList.add('force-show-modal');
        }
      }, 100);
    } catch {
      document.body.classList.add('force-show-modal');
    }
  }
  function unlockApp(name) {
    isPremium = true; premiumName = name || '';
    document.body.classList.remove('serial-locked','force-show-modal');
    const inst = bootstrap.Modal.getInstance(document.getElementById('serialGate'));
    if (inst) inst.hide();
    updateSignedInEmailUI();
    initApp();
  }
  async function validateStoredKey() {
    try {
      const r = await fetch('json/serial-keys.json');
      serialData = await r.json();
    } catch (e) {
      console.warn('Could not load serial-keys.json:', e);
      serialData = [];
    }
    const savedKey = localStorage.getItem('premiumKey');
    const savedEmail = localStorage.getItem('premiumEmail');
    const entry = serialData.find(e => e.key === savedKey);
    if (entry && savedEmail) { unlockApp(entry.name); } else { showGate(); }

    const submitBtn = document.getElementById('submitSerial');
    const keyInput   = document.getElementById('serialInput');
    const emailInput = document.getElementById('emailInput');
    submitBtn.onclick = () => {
      const key = keyInput.value.trim();
      const email = emailInput.value.trim();
      const match = serialData.find(e => e.key === key);
      if (match && email) {
        localStorage.setItem('premiumKey', key);
        localStorage.setItem('premiumEmail', email);
        document.getElementById('serialFeedback').style.display = 'none';
        unlockApp(match.name);
      } else {
        document.getElementById('serialFeedback').style.display = 'block';
      }
    };
    // Enter to submit
    [keyInput, emailInput].forEach(el => {
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); submitBtn.click(); }
      });
    });
  }

  function updateSignedInEmailUI() {
    const email = localStorage.getItem('premiumEmail') || '';
    const wrap = document.getElementById('signedInEmail');
    const val  = document.getElementById('signedInEmailValue');
    if (email && wrap && val) {
      val.textContent = email;
      wrap.style.display = '';
    } else if (wrap) {
      wrap.style.display = 'none';
    }
  }

  /***********************
   * App state & helpers
   ***********************/
  const PREV_INV_KEY = 'prevInventorySnapshot';
  const FAV_KEY = 'favoriteVehicles';
  const PREV_KEY = 'prevFavoriteSnapshot';

  const LOCATION_KEYS  = ['boise','caldwell','garden_city','nampa','twin_falls'];
  const LOCATION_NAMES = { boise:'Boise', caldwell:'Caldwell', garden_city:'Garden City', nampa:'Nampa', twin_falls:'Twin Falls' };

  let notes = {};
  let selectedRowKey = null;
  let currentData = [];     // Jalopy current
  let sortDirection = {};
  let ageChart = null;

  let trustyData = [];      // Trusty current
  let trustySortDirection = {};
  let trustyAgeChart = null;

  /* Utility to parse inventory filenames with both time separators:
     inventory_boise_2025-06-08_07-17-49.csv
     inventory_trusty_2025-08-25-07-20-23.csv */
  function parseStamp(filename, expectTrusty=false) {
    const base = String(filename).trim();
    const re = expectTrusty
      ? /^inventory_(.+?)_(\d{4}-\d{2}-\d{2})[_-](\d{2})[-_](\d{2})[-_](\d{2})\.csv$/i
      : /^inventory_(.+?)_(\d{4}-\d{2}-\d{2})[_-](\d{2})[-_](\d{2})[-_](\d{2})\.csv$/i;
    const m = base.match(re);
    if (!m) return null;
    const loc = m[1].toLowerCase();
    const dtKey = `${m[2].replaceAll('-','')}${m[3]}${m[4]}${m[5]}`;
    const dtDisplay = `${m[2]} ${m[3]}:${m[4]}:${m[5]}`;
    return { loc, dtKey, dtDisplay, filename: base };
  }

  function showFavToast(htmlContent) {
    const container = document.getElementById('favToastContainer');
    const toastEl = document.createElement('div');
    toastEl.className = 'toast'; toastEl.role = 'alert';
    toastEl.ariaLive = 'assertive'; toastEl.ariaAtomic = 'true';
    toastEl.innerHTML = `
      <div class="toast-header">
        <strong class="me-auto">ðŸš¨ New Favorite!</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body">${htmlContent}</div>`;
    container.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
    toast.show();
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
  }

  function checkNewFavoriteVehicles(data = window.currentData) {
    const favs = JSON.parse(localStorage.getItem(FAV_KEY) || '[]')
      .map(v => `${v.year.trim()} / ${v.make.trim()} / ${v.model.trim()}`);
    if (!favs.length) return;

    const todayLabels = Array.from(new Set(
      data.map(r => `${String(r.Year).trim()} / ${String(r.Make).trim()} / ${String(r.Model).trim()}`)
    ));
    const prevLabels = JSON.parse(localStorage.getItem(PREV_INV_KEY) || '[]');
    const newLabels  = todayLabels.filter(lbl => !prevLabels.includes(lbl));
    const hits = newLabels.filter(lbl => favs.includes(lbl));
    if (hits.length) showFavToast(hits.map(l => `â€¢ ${l}`).join('<br>'));
    localStorage.setItem(PREV_INV_KEY, JSON.stringify(todayLabels));
  }

  function applyHomeYardDefault() {
    const home = (localStorage.getItem('homeYard') || '').trim().toLowerCase().replace(/\s+/g,'_');
    if (!home) return;
    const selector = document.getElementById('csvSelector');
    const opt = selector.querySelector(`option[data-loc="${home}"]`);
    if (opt) { selector.value = opt.value; loadCSV(opt.value); }
  }

  /********* Jalopy listing *********/
  async function listCSVFiles() {
    const selector = document.getElementById('csvSelector');
    selector.innerHTML = '';
    try {
      const res = await fetch('./inventory-csvs/index.json', { cache:'no-store' });
      const files = await res.json();
      const latest = {};
      files.forEach(f => {
        const p = parseStamp(f, false);
        if (!p) return;
        if (!latest[p.loc] || p.dtKey > latest[p.loc].dtKey) latest[p.loc] = p;
      });

      LOCATION_KEYS.forEach(locKey => {
        const entry = latest[locKey];
        if (!entry) return;
        const opt = document.createElement('option');
        opt.value = 'inventory-csvs/' + entry.filename;
        opt.dataset.loc = locKey;
        opt.textContent = `${LOCATION_NAMES[locKey]} (${entry.dtDisplay})`;
        selector.appendChild(opt);
      });

      selector.onchange = (e) => {
        const locKey = e.target.selectedOptions[0].dataset.loc;
        localStorage.setItem('homeYard', locKey);
        loadCSV(e.target.value);
      };

      let savedHome = (localStorage.getItem('homeYard') || '').trim().toLowerCase().replace(/\s+/g,'_');
      const toSelect = selector.querySelector(`option[data-loc="${savedHome}"]`) || selector.options[0];
      if (toSelect) { selector.value = toSelect.value; loadCSV(toSelect.value); }
    } catch (err) {
      console.error('Error listing inventory CSVs (Jalopy):', err);
    }
  }

  function loadCSV(path) {
    document.getElementById('searchInput').value = '';
    Papa.parse(path, {
      download:true, header:true,
      complete(r) {
        currentData = r.data.filter(row => row.Year && row.Make && row.Model && row.Row);
        checkNewFavoriteVehicles(currentData);
        renderTable(currentData);
        showStatistics(currentData);
      }
    });
  }

  function renderTable(data) {
    const hdr = document.getElementById('tableHeader');
    const bd  = document.getElementById('tableBody');
    hdr.innerHTML = ''; bd.innerHTML = '';
    if (!data.length) return;

    const cols = Object.keys(data[0]).concat('Note','Pick');
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      th.onclick = () => sortTableByColumn(c);
      hdr.appendChild(th);
    });

    const storedPick = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const pickKeys = new Set(storedPick.map(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|')));

    data.forEach(row => {
      const tr  = document.createElement('tr');
      const key = Object.values(row).join('|');
      tr.dataset.key = key;

      Object.values(row).forEach(v => {
        const td = document.createElement('td');
        td.textContent = v; tr.appendChild(td);
      });

      // Note cell
      const nt = document.createElement('td');
      nt.textContent = (notes[key] || '');
      nt.style.cursor = 'pointer';
      nt.addEventListener('click', e => {
        e.stopPropagation();
        selectedRowKey = key;
        const ni = document.getElementById('noteInput');
        ni.value = notes[key] || '';
        document.getElementById('noteLengthFeedback').style.display = 'none';
        document.getElementById('noteLimitInfo').style.display = 'none';
        new bootstrap.Modal(document.getElementById('noteModal')).show();
      });
      tr.appendChild(nt);

      tr.addEventListener('click', () => openSoldModal(row));

      // Pick
      const pickTd = document.createElement('td');
      const btn = document.createElement('button');
      btn.classList.add('pick-btn','btn','btn-sm');

      if (pickKeys.has(['Year','Make','Model','Row'].map(k => row[k]).join('|'))) {
        btn.textContent = 'âœ“ Picked'; btn.classList.add('btn-success'); tr.classList.add('table-success');
      } else {
        btn.textContent = 'âž• Pick'; btn.classList.add('btn-outline-primary');
      }

      btn.addEventListener('click', e => {
        e.stopPropagation();
        const isPicked = btn.classList.contains('btn-success');
        const selector = document.getElementById('csvSelector');
        const locKey = selector?.selectedOptions?.[0]?.dataset?.loc || '';
        const yardName = `Jalopy Jungle ` + LOCATION_NAMES[locKey] || (locKey ? locKey : '');

        if (!isPicked) {
          addToPickList({ ...row, Yard: yardName });
          btn.textContent = 'âœ“ Picked';
          btn.classList.replace('btn-outline-primary','btn-success');
          tr.classList.add('table-success');
        } else {
          removeFromPickList(['Year','Make','Model','Row'].map(k => row[k]).join('|'));
          btn.textContent = 'âž• Pick';
          btn.classList.replace('btn-success','btn-outline-primary');
          tr.classList.remove('table-success');
        }
      });

      pickTd.appendChild(btn);
      tr.appendChild(pickTd);
      bd.appendChild(tr);
    });

    document.getElementById('searchInput').oninput = function() {
      const q = this.value.toLowerCase();
      const filtered = currentData.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(q)));
      renderTable(filtered);
      showStatistics(filtered);
    };
  }

  function sortTableByColumn(col) {
    const dir = sortDirection[col] === 'asc' ? 'desc' : 'asc';
    sortDirection[col] = dir;
    currentData.sort((a,b) => a[col] < b[col] ? (dir==='asc'?-1:1) : a[col] > b[col] ? (dir==='asc'?1:-1) : 0);
    renderTable(currentData); showStatistics(currentData);
  }

  document.getElementById('saveNote').onclick = () => {
    const ni = document.getElementById('noteInput'), val = ni.value;
    document.getElementById('noteLengthFeedback').style.display = 'none';
    if (selectedRowKey) {
      notes[selectedRowKey] = val;
      localStorage.setItem('jalopyNotes', JSON.stringify(notes));
      renderTable(currentData);
      renderTrustyTable(trustyData);
    }
    bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
  };
  document.getElementById('clearNote').onclick = () => {
    if (selectedRowKey) {
      delete notes[selectedRowKey];
      localStorage.setItem('jalopyNotes', JSON.stringify(notes));
      renderTable(currentData);
      renderTrustyTable(trustyData);
      document.getElementById('noteInput').value = '';
      document.getElementById('noteLengthFeedback').style.display = 'none';
    }
  };

  /* ========== CSV helpers (with branding) ========== */
  function csvEscape(val) {
    const s = String(val ?? '');
    const needsQuotes = /[",\n]/.test(s);
    const escaped = s.replace(/"/g, '""');
    return needsQuotes ? `"${escaped}"` : escaped;
  }
  function fileStamp() {
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
  }
  function brandingBannerLines(contextLabel='Export') {
    const d = new Date();
    const ts = d.toISOString().slice(0,19).replace('T',' ');
    return [
      ['PROFIT â€“ Cars and Collectibles LLC'].map(csvEscape).join(','),
      ['Website: https://carsandcollectibles.com'].map(csvEscape).join(','),
      [`${contextLabel} generated: ${ts}`].map(csvEscape).join(','),
      '' // blank spacer line
    ];
  }

  function exportTableToCSVGeneric(hdrSel, bodySel, filename, excludeHeaders = ['Pick']) {
    // headers (drop excluded)
    const rawHeaders = Array.from(document.querySelectorAll(hdrSel + ' th'))
      .map(th => th.textContent.trim());
    const excludeSet = new Set(excludeHeaders.map(h => h.trim().toLowerCase()));
    const keepIdx = rawHeaders
      .map((h, i) => ({ h, i }))
      .filter(({ h }) => !excludeSet.has(h.toLowerCase()))
      .map(({ i }) => i);
    const headers = keepIdx.map(i => rawHeaders[i]);

    // rows
    const rows = Array.from(document.querySelectorAll(bodySel + ' tr')).map(tr => {
      const cells = Array.from(tr.cells).map(td => td.textContent);
      return keepIdx.map(i => cells[i] ?? '');
    });

    // build CSV with branding
    const top = brandingBannerLines('Inventory Export');
    const lines = [
      ...top,
      headers.map(csvEscape).join(','),
      ...rows.map(r => r.map(csvEscape).join(','))
    ];
    const csv = lines.join('\n');

    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.append(a);
    a.click();
    a.remove();
  }
  document.getElementById('exportBtn').onclick = () =>
    exportTableToCSVGeneric('#tableHeader', '#tableBody', 'inventory_with_notes.csv');

  function showStatistics(data) {
    const s = document.getElementById('statistics');
    const valid = data.map(r => {
      const y = parseInt(r.Year), rn = parseInt(r.Row);
      return (!isNaN(y) && !isNaN(rn)) ? { row:rn, age:new Date().getFullYear()-y } : null;
    }).filter(Boolean);

    if (!valid.length) {
      s.innerHTML = `<strong>Average Age:</strong> N/A<br/>
                     <strong># Models:</strong> 0<br/>
                     <strong># Makes:</strong> 0<br/>
                     <strong>Newest Age:</strong> N/A<br/>
                     <strong>Oldest Age:</strong> N/A`;
      if (ageChart){ ageChart.destroy(); ageChart=null; }
      return;
    }

    valid.sort((a,b)=>a.row-b.row);
    const cum=[]; valid.forEach((it,i)=>{
      const slice=valid.slice(0,i+1).map(x=>x.age);
      cum.push(+(slice.reduce((s,v)=>s+v,0)/slice.length).toFixed(1));
    });
    const ages = valid.map(x=>x.age);
    const models=new Set(data.map(r=>`${r.Make}|${r.Model}`));
    const makes=new Set(data.map(r=>r.Make));

    s.innerHTML = `<strong>Average Age:</strong> ${cum.at(-1)}<br/>
                   <strong># Models:</strong> ${models.size}<br/>
                   <strong># Makes:</strong> ${makes.size}<br/>
                   <strong>Newest Age:</strong> ${Math.min(...ages)}<br/>
                   <strong>Oldest Age:</strong> ${Math.max(...ages)}`;

    const ctx = document.getElementById('ageChart').getContext('2d');
    if (ageChart) ageChart.destroy();
    ageChart = new Chart(ctx,{
      type:'bar',
      data:{ labels: valid.map(x=>x.row), datasets:[{
        label:'Cumulative Avg Age', data:cum, backgroundColor:'rgba(52,152,219,0.7)', borderColor:'rgba(41,128,185,1)', borderWidth:1
      }]},
      options:{ responsive:true, scales:{
        x:{ title:{ display:true, text:'Row' }},
        y:{ title:{ display:true, text:'Age' }, beginAtZero:true }
      }, plugins:{ legend:{ display:false } } }
    });
  }

  /********* Trusty listing *********/
  async function listTrustyFiles() {
    const selector = document.getElementById('trustySelector');
    selector.innerHTML = '';
    try {
      const res = await fetch('./inventory-csvs/trusty/index.json', { cache:'no-store' });
      const files = await res.json();
      const latest = {};
      files.forEach(f => {
        const p = parseStamp(f, true);
        if (!p) return;
        if (!latest[p.loc] || p.dtKey > latest[p.loc].dtKey) latest[p.loc] = p;
      });

      Object.keys(latest).sort().forEach(locKey => {
        const entry = latest[locKey];
        const opt = document.createElement('option');
        opt.value = 'inventory-csvs/trusty/' + entry.filename;
        opt.dataset.loc = locKey;
        opt.textContent = `Trusty (${entry.dtDisplay})`;
        selector.appendChild(opt);
      });

      selector.onchange = (e) => {
        loadTrustyCSV(e.target.value);
      };

      if (selector.options.length) {
        selector.value = selector.options[0].value;
        loadTrustyCSV(selector.value);
      }
    } catch (err) {
      console.error('Error listing inventory CSVs (Trusty):', err);
    }
  }

  function loadTrustyCSV(path) {
    document.getElementById('trustySearchInput').value = '';
    Papa.parse(path, {
      download:true, header:true,
      complete(r) {
        trustyData = r.data.filter(row => row.Year && row.Make && row.Model && row.Row);
        renderTrustyTable(trustyData);
        showTrustyStatistics(trustyData);
      }
    });
  }

  function renderTrustyTable(data) {
    const hdr = document.getElementById('trustyTableHeader');
    const bd  = document.getElementById('trustyTableBody');
    hdr.innerHTML = ''; bd.innerHTML = '';
    if (!data.length) return;

    const cols = Object.keys(data[0]).concat('Note','Pick');
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      th.onclick = () => sortTrustyByColumn(c);
      hdr.appendChild(th);
    });

    const storedPick = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const pickKeys = new Set(storedPick.map(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|')));

    data.forEach(row => {
      const tr  = document.createElement('tr');
      const key = Object.values(row).join('|');
      tr.dataset.key = key;

      Object.values(row).forEach(v => {
        const td = document.createElement('td');
        td.textContent = v; tr.appendChild(td);
      });

      // Note cell
      const nt = document.createElement('td');
      nt.textContent = (notes[key] || '');
      nt.style.cursor = 'pointer';
      nt.addEventListener('click', e => {
        e.stopPropagation();
        selectedRowKey = key;
        const ni = document.getElementById('noteInput');
        ni.value = notes[key] || '';
        document.getElementById('noteLengthFeedback').style.display = 'none';
        document.getElementById('noteLimitInfo').style.display = 'none';
        new bootstrap.Modal(document.getElementById('noteModal')).show();
      });
      tr.appendChild(nt);

      tr.addEventListener('click', () => openSoldModal(row));

      // Pick
      const pickTd = document.createElement('td');
      const btn = document.createElement('button');
      btn.classList.add('pick-btn','btn','btn-sm');

      if (pickKeys.has(['Year','Make','Model','Row'].map(k => row[k]).join('|'))) {
        btn.textContent = 'âœ“ Picked'; btn.classList.add('btn-success'); tr.classList.add('table-success');
      } else {
        btn.textContent = 'âž• Pick'; btn.classList.add('btn-outline-primary');
      }

      btn.addEventListener('click', e => {
        e.stopPropagation();
        const isPicked = btn.classList.contains('btn-success');
        const yardName = `Trusty`;

        if (!isPicked) {
          addToPickList({ ...row, Yard: yardName });
          btn.textContent = 'âœ“ Picked';
          btn.classList.replace('btn-outline-primary','btn-success');
          tr.classList.add('table-success');
        } else {
          removeFromPickList(['Year','Make','Model','Row'].map(k => row[k]).join('|'));
          btn.textContent = 'âž• Pick';
          btn.classList.replace('btn-success','btn-outline-primary');
          tr.classList.remove('table-success');
        }
      });

      pickTd.appendChild(btn);
      tr.appendChild(pickTd);
      bd.appendChild(tr);
    });

    document.getElementById('trustySearchInput').oninput = function() {
      const q = this.value.toLowerCase();
      const filtered = trustyData.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(q)));
      renderTrustyTable(filtered);
      showTrustyStatistics(filtered);
    };
  }

  function sortTrustyByColumn(col) {
    const dir = trustySortDirection[col] === 'asc' ? 'desc' : 'asc';
    trustySortDirection[col] = dir;
    trustyData.sort((a,b) => a[col] < b[col] ? (dir==='asc'?-1:1) : a[col] > b[col] ? (dir==='asc'?1:-1) : 0);
    renderTrustyTable(trustyData); showTrustyStatistics(trustyData);
  }

  function showTrustyStatistics(data) {
    const s = document.getElementById('trustyStatistics');
    const valid = data.map(r => {
      const y = parseInt(r.Year), rn = parseInt(r.Row);
      return (!isNaN(y) && !isNaN(rn)) ? { row:rn, age:new Date().getFullYear()-y } : null;
    }).filter(Boolean);

    if (!valid.length) {
      s.innerHTML = `<strong>Average Age:</strong> N/A<br/>
                     <strong># Models:</strong> 0<br/>
                     <strong># Makes:</strong> 0<br/>
                     <strong>Newest Age:</strong> N/A<br/>
                     <strong>Oldest Age:</strong> N/A`;
      if (trustyAgeChart){ trustyAgeChart.destroy(); trustyAgeChart=null; }
      return;
    }

    valid.sort((a,b)=>a.row-b.row);
    const cum=[]; valid.forEach((it,i)=>{
      const slice=valid.slice(0,i+1).map(x=>x.age);
      cum.push(+(slice.reduce((s,v)=>s+v,0)/slice.length).toFixed(1));
    });
    const ages = valid.map(x=>x.age);
    const models=new Set(data.map(r=>`${r.Make}|${r.Model}`));
    const makes=new Set(data.map(r=>r.Make));

    s.innerHTML = `<strong>Average Age:</strong> ${cum.at(-1)}<br/>
                   <strong># Models:</strong> ${models.size}<br/>
                   <strong># Makes:</strong> ${makes.size}<br/>
                   <strong>Newest Age:</strong> ${Math.min(...ages)}<br/>
                   <strong>Oldest Age:</strong> ${Math.max(...ages)}`;

    const ctx = document.getElementById('trustyAgeChart').getContext('2d');
    if (trustyAgeChart) trustyAgeChart.destroy();
    trustyAgeChart = new Chart(ctx,{
      type:'bar',
      data:{ labels: valid.map(x=>x.row), datasets:[{
        label:'Cumulative Avg Age', data:cum, backgroundColor:'rgba(52,152,219,0.7)', borderColor:'rgba(41,128,185,1)', borderWidth:1
      }]},
      options:{ responsive:true, scales:{
        x:{ title:{ display:true, text:'Row' }},
        y:{ title:{ display:true, text:'Age' }, beginAtZero:true }
      }, plugins:{ legend:{ display:false } } }
    });
  }

  /**************
   * Pick List  *
   **************/
  function addToPickList(row, persist=true) {
    const tbody = document.getElementById('pickListBody');
    const tr = document.createElement('tr');

    const key = ['Year','Make','Model','Row'].map(k => String(row[k]).trim()).join('|');
    tr.dataset.key = key;

    ['Year','Make','Model','Row','Yard'].forEach(k => {
      const td = document.createElement('td');
      td.textContent = row[k] || '';
      tr.appendChild(td);
    });

    const noteTd = document.createElement('td');
    const originalKeyForNotes = [row.Year,row.Make,row.Model,row.Row].join('|');
    noteTd.textContent = (JSON.parse(localStorage.getItem('jalopyNotes') || '{}')[originalKeyForNotes] || '');
    tr.appendChild(noteTd);

    const rmTd = document.createElement('td');
    const rmBtn = document.createElement('button');
    rmBtn.className = 'btn btn-sm btn-outline-danger';
    rmBtn.textContent = 'âœ• Remove';
    rmBtn.addEventListener('click', e => {
      e.stopPropagation();
      tbody.removeChild(tr);

      // reset pick buttons in visible tables
      [document.getElementById('tableBody'), document.getElementById('trustyTableBody')].forEach(tbodyEl => {
        if (!tbodyEl) return;
        const origRow = tbodyEl.querySelector(`tr[data-key="${originalKeyForNotes}"]`);
        if (origRow) {
          const pickBtn = origRow.querySelector('button.pick-btn');
          if (pickBtn) {
            pickBtn.textContent = 'âž• Pick';
            pickBtn.classList.replace('btn-success','btn-outline-primary');
            origRow.classList.remove('table-success');
          }
        }
      });

      let pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
      pickList = pickList.filter(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|') !== key);
      localStorage.setItem('myPickList', JSON.stringify(pickList));
    });
    rmTd.appendChild(rmBtn);
    tr.appendChild(rmTd);

    tbody.appendChild(tr);

    if (persist) {
      let pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
      if (!pickList.some(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|') === key)) {
        pickList.push(row);
        localStorage.setItem('myPickList', JSON.stringify(pickList));
      }
    }
  }
  function removeFromPickList(key) {
    const tbody = document.getElementById('pickListBody');
    const rowEl = tbody.querySelector(`tr[data-key="${key}"]`);
    if (rowEl) tbody.removeChild(rowEl);
    let pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
    pickList = pickList.filter(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|') !== key);
    localStorage.setItem('myPickList', JSON.stringify(pickList));
  }
  function loadPickListData() {
    const pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const tbody    = document.getElementById('pickListBody');
    tbody.innerHTML = '';
    pickList.forEach(row => addToPickList(row, false));
  }

  /****************
   * Sold modal   *
   ****************/
  function openSoldModal(row) {
    const locKey = document.getElementById('csvSelector')?.selectedOptions?.[0]?.dataset?.loc;

    fetch('./ebay-sales/ebay-sales.json')
      .then(r => r.json())
      .then(files => {
        const prefix = `inventory_${locKey}_`;
        const soldFiles = files.filter(f => f.startsWith(prefix) && f.includes('_ebay_sales_'));
        if (!soldFiles.length) throw 'no-sold-files';

        let latestFile = soldFiles[0];
        let latestDate = latestFile.match(/_ebay_sales_(\d{4}-\d{2}-\d{2})\.csv$/)[1];
        soldFiles.forEach(f => {
          const m = f.match(/_ebay_sales_(\d{4}-\d{2}-\d{2})\.csv$/);
          if (m && m[1] > latestDate) { latestDate = m[1]; latestFile = f; }
        });
        return latestFile;
      })
      .then(latestFile => {
        const path = `./ebay-sales/${latestFile}`;
        return new Promise((resolve, reject) => {
          Papa.parse(path, { download:true, header:true,
            complete: res => resolve(res.data),
            error: err => reject(err)
          });
        });
      })
      .then(data => {
        const filtered = data.filter(r =>
          r.Year === row.Year && r.Make === row.Make && r.Model === row.Model
        );
        renderSoldTable(filtered);
      })
      .catch(err => {
        console.warn('Sold-data load:', err);
        renderSoldTable([]);
      })
      .finally(() => {
        new bootstrap.Modal(document.getElementById('soldModal')).show();
      });
  }

  function renderSoldTable(data) {
    const tbody = document.getElementById('soldDataBody');
    tbody.innerHTML = '';
    if (!data || !data.length) {
      document.getElementById('soldDataEmpty').style.display = '';
      return;
    }
    document.getElementById('soldDataEmpty').style.display = 'none';
    data.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r['Search Term']||''}</td>
        <td>${r['Listing Title']||''}</td>
        <td>${r['Last Sold Price']||''}</td>
        <td>${r['Date Sold']||''}</td>
        <td>${r['Time to Sell']||''}</td>
        <td>${r['Total Sold']||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  /****************
   * Settings     *
   ****************/
  const settingsBtn = document.getElementById('settingsBtn');
  const modalToggleDark = document.getElementById('modalToggleDark');

  settingsBtn.onclick = () => {
    const sel = document.getElementById('homeYardSelect');
    sel.value = localStorage.getItem('homeYard') || '';
    new bootstrap.Modal(document.getElementById('settingsModal')).show();
  };
  document.getElementById('saveSettings').onclick = () => {
    const yard = document.getElementById('homeYardSelect').value;
    localStorage.setItem('homeYard', yard.trim().toLowerCase().replace(/\s+/g,'_'));
    bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
    applyHomeYardDefault();
  };
  modalToggleDark.onclick = () => {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDark);
  };

  // Favorites UI
  document.getElementById('settingsModal').addEventListener('shown.bs.modal', renderFavoriteVehicles);
  document.getElementById('addFavVehicleBtn').onclick = () => {
    const year  = document.getElementById('favYearInput').value.trim();
    const make  = document.getElementById('favMakeInput').value.trim();
    const model = document.getElementById('favModelInput').value.trim();
    if (!year || !make || !model) return alert('Please fill in all three fields.');
    const list = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    list.push({ year, make, model });
    localStorage.setItem(FAV_KEY, JSON.stringify(list));
    document.getElementById('favYearInput').value = '';
    document.getElementById('favMakeInput').value = '';
    document.getElementById('favModelInput').value = '';
    renderFavoriteVehicles();
  };
  function renderFavoriteVehicles() {
    const ul = document.getElementById('favVehiclesList');
    ul.innerHTML = '';
    const list = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    list.forEach((v, idx) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
      li.innerHTML = `<span>${v.year} / ${v.make} / ${v.model}</span>
                      <button class="btn btn-sm btn-outline-danger">âœ•</button>`;
      li.querySelector('button').onclick = () => {
        list.splice(idx, 1);
        localStorage.setItem(FAV_KEY, JSON.stringify(list));
        renderFavoriteVehicles();
      };
      ul.appendChild(li);
    });
  }

  // Data Code (sync favorites + picklist + prefs)
  function getDataCode() {
    const pickList   = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const favorites  = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    const homeYard   = localStorage.getItem('homeYard') || '';
    theDark = localStorage.getItem('darkMode') || 'false';
    const combined = JSON.stringify({ pickList, favorites, homeYard, darkMode: theDark });
    return LZString.compressToBase64(combined);
  }
  function applyDataCode(code) {
    try {
      const json = LZString.decompressFromBase64(code);
      const obj  = JSON.parse(json);
      localStorage.setItem('myPickList', JSON.stringify(obj.pickList || []));
      localStorage.setItem(FAV_KEY, JSON.stringify(obj.favorites || []));
      localStorage.setItem('homeYard', (obj.homeYard || '').trim().toLowerCase().replace(/\s+/g,'_'));
      localStorage.setItem('darkMode', obj.darkMode || 'false');
      loadPickListData();
      renderFavoriteVehicles();
      if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
      alert('Data synced successfully!');
    } catch(e) {
      alert('Invalid Data Code.');
    }
  }
  document.getElementById('exportDataBtn').onclick = () => {
    const code = getDataCode();
    const out  = document.getElementById('dataCodeOutput');
    out.value  = code;
    out.select(); document.execCommand('copy');
    alert('Data Code copied to clipboard!');
  };
  document.getElementById('importDataBtn').onclick = () => {
    const code = document.getElementById('dataCodeInput').value.trim();
    if (code) applyDataCode(code);
  };

  /* ---------- Pick List CSV (with branding) ---------- */
  function gatherPickListRowsFromDOM() {
    const tbody = document.getElementById('pickListBody');
    const rows = [];
    const notesMap = JSON.parse(localStorage.getItem('jalopyNotes') || '{}');
    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
      const tds = tr.querySelectorAll('td');
      if (tds.length < 6) return;
      const Year  = tds[0].textContent.trim();
      const Make  = tds[1].textContent.trim();
      const Model = tds[2].textContent.trim();
      const Row   = tds[3].textContent.trim();
      const Yard  = tds[4].textContent.trim();
      const key   = [Year, Make, Model, Row].join('|');
      const Notes = (notesMap[key] || '').replace(/\r?\n/g,' ');
      rows.push({ Year, Make, Model, Row, Yard, Notes });
    });
    return rows;
  }
  function gatherPickListRowsFromStorage() {
    const pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const notesMap = JSON.parse(localStorage.getItem('jalopyNotes') || '{}');
    return pickList.map(r => {
      const key = [r.Year, r.Make, r.Model, r.Row].join('|');
      return {
        Year:  r.Year || '',
        Make:  r.Make || '',
        Model: r.Model || '',
        Row:   r.Row || '',
        Yard:  r.Yard || '',
        Notes: (notesMap[key] || '').replace(/\r?\n/g,' ')
      };
    });
  }
  function downloadCSV(rows, filename, contextLabel='Pick List Export') {
    const headers = ['Year','Make','Model','Row','Yard','Notes'];
    const lines = [
      ...brandingBannerLines(contextLabel),
      headers.map(csvEscape).join(',')
    ];
    rows.forEach(r => {
      lines.push([r.Year, r.Make, r.Model, r.Row, r.Yard, r.Notes].map(csvEscape).join(','));
    });
    const csv = lines.join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }
  function downloadCSVGroupedByYard(rows, filename) {
    const sorted = [...rows].sort((a,b) =>
      (a.Yard||'').localeCompare(b.Yard||'') ||
      (a.Make||'').localeCompare(b.Make||'') ||
      (a.Model||'').localeCompare(b.Model||'') ||
      (parseInt(a.Year)||0) - (parseInt(b.Year)||0) ||
      (String(a.Row||'')).localeCompare(String(b.Row||''))
    );
    const headers = ['Year','Make','Model','Row','Yard','Notes'];
    const lines = [
      ...brandingBannerLines('Pick List Export (Grouped by Yard)'),
      headers.map(csvEscape).join(',')
    ];
    let currentYard = null;
    sorted.forEach(r => {
      if (r.Yard !== currentYard) {
        currentYard = r.Yard;
        lines.push('');
        lines.push([`YARD: ${currentYard}`,'','','','',''].map(csvEscape).join(','));
      }
      lines.push([r.Year, r.Make, r.Model, r.Row, r.Yard, r.Notes].map(csvEscape).join(','));
    });
    const csv = lines.join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Export modal wiring
  function openExportPickListModal() {
    const rows = gatherPickListRowsFromStorage();
    const yards = Array.from(new Set(rows.map(r => r.Yard).filter(Boolean))).sort();
    const select = document.getElementById('singleYardSelect');
    select.innerHTML = '<option value="">Select Yardâ€¦</option>';
    yards.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y;
      select.appendChild(opt);
    });
    document.getElementById('exportAsIs').checked = true;
    select.disabled = true;
    ['exportAsIs','exportGrouped','exportSingleYard'].forEach(id => {
      document.getElementById(id).onchange = () => {
        select.disabled = !document.getElementById('exportSingleYard').checked;
        const btn = document.getElementById('confirmExportPick');
        btn.textContent = id==='exportAsIs' ? 'Export Full List'
          : id==='exportGrouped' ? 'Export Grouped by Yard'
          : 'Export Selected Yard';
      };
    });
    bootstrap.Modal.getOrCreateInstance(document.getElementById('exportPickListModal')).show();
  }
  function performPickListExportFromModal() {
    const mode = document.querySelector('input[name="pickExportMode"]:checked')?.value || 'asis';
    const ts = fileStamp();
    if (mode === 'asis') {
      const rows = gatherPickListRowsFromDOM();
      if (!rows.length) return alert('Your pick list is empty.');
      downloadCSV(rows, `pick_list_${ts}.csv`, 'Pick List Export');
      return;
    }
    if (mode === 'grouped') {
      const rows = gatherPickListRowsFromStorage();
      if (!rows.length) return alert('Your pick list is empty.');
      downloadCSVGroupedByYard(rows, `pick_list_grouped_${ts}.csv`);
      return;
    }
    if (mode === 'single') {
      const yard = document.getElementById('singleYardSelect').value.trim();
      if (!yard) return alert('Please choose a yard.');
      const rows = gatherPickListRowsFromStorage().filter(r => r.Yard === yard);
      if (!rows.length) return alert(`No rows found for yard: ${yard}`);
      downloadCSV(rows, `pick_list_${yard.replace(/\s+/g,'_')}_${ts}.csv`, `Pick List Export â€“ ${yard}`);
      return;
    }
  }

  // Hook up buttons
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('exportPickListBtn');
    if (btn) btn.addEventListener('click', openExportPickListModal);

    const confirm = document.getElementById('confirmExportPick');
    if (confirm) confirm.addEventListener('click', () => {
      performPickListExportFromModal();
      bootstrap.Modal.getInstance(document.getElementById('exportPickListModal')).hide();
    });
  });

  /* ---------- Alerts tab JS ---------- */
  (function initAlerts() {
    const form = document.getElementById("alertForm");
    const statusMsg = document.getElementById("statusMsg");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusMsg.textContent = "Submittingâ€¦";

      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());

      const email = localStorage.getItem('premiumEmail');
      if (!email) {
        statusMsg.textContent = "âŒ Missing email. Please re-login.";
        showGate();
        return;
      }
      payload.email = email; // auto-insert stored email

      try {
        const res = await fetch("https://profit-alerts.profit-alerts.workers.dev", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const result = await res.json();
        if (result.ok) {
          statusMsg.textContent = "âœ… Alert created!";
          form.reset();
        } else {
          statusMsg.textContent = "âŒ Error creating alert.";
        }
      } catch (err) {
        statusMsg.textContent = "âŒ Network error.";
      }
    });
  })();

  /****************
   * App init     *
   ****************/
  function initApp() {
    try { notes = JSON.parse(localStorage.getItem('jalopyNotes') || '{}'); } catch { notes = {}; }
    if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');

    updateSignedInEmailUI();
    listCSVFiles();      // Jalopy
    listTrustyFiles();   // Trusty
    loadPickListData();  // Pick list
  }

  // Start the serial gate flow
  validateStoredKey();

  </script>
  
<script>
// ======== TRENDS (Latest sold-data only) ========

const T_YARDS = ['boise','caldwell','garden_city','nampa','twin_falls'];
const RE_TAIL_DATE = /_ebay_sales_(\d{4}-\d{2}-\d{2})\.csv$/;

const $ = id => document.getElementById(id);
const setTrendsSummary = msg => { const el = $('trendsSummary'); if (el) el.textContent = msg || ''; };

// Yard source: "Auto" follows Jalopy; others are explicit
function getCurrentLocKeyFromJalopy(){
  const opt = $('csvSelector')?.selectedOptions?.[0];
  return opt?.dataset?.loc || '';
}
function getTrendsLocKey(){
  const sel = $('trendsYard');
  const v = sel?.value || 'auto';
  return v === 'auto' ? getCurrentLocKeyFromJalopy() : v; // 'all' | 'vehicles_of_interest' | yard token
}

// Load index (expects ./ebay-sales/ebay-sales.json)
async function loadEbayIndex(){
  try {
    const r = await fetch('./ebay-sales/ebay-sales.json', { cache: 'no-store' });
    const data = await r.json();
    const files = Array.isArray(data) ? data : (Array.isArray(data?.files) ? data.files : []);
    return files;
  } catch(e) {
    console.error('[Trends/latest] Could not load ebay-sales.json', e);
    return [];
  }
}

function detectYardTokenFromFile(f) {
  const pre = f.split('_ebay_sales_')[0].toLowerCase();
  if (pre.startsWith('vehicles_of_interest')) return 'vehicles_of_interest';
  for (const y of T_YARDS) if (pre.includes(`_${y}_`)) return y; // strong match
  for (const y of T_YARDS) if (pre.includes(y)) return y;        // loose match
  return 'unknown';
}
function tailDateKey(f) {
  const m = f.match(RE_TAIL_DATE);
  return m ? m[1] : '';
}
function humanYard(token){
  const map = { boise:'Boise', caldwell:'Caldwell', garden_city:'Garden City', nampa:'Nampa', twin_falls:'Twin Falls', vehicles_of_interest:'Vehicles of Interest' };
  return map[token] || token;
}

// Pick newest file(s) for the selection
function pickLatestTargets(filesIndex, locKey) {
  // group files by detected yard
  const byYard = new Map();
  for (const f of filesIndex) {
    if (!RE_TAIL_DATE.test(f)) continue;
    const y = detectYardTokenFromFile(f);
    if (!byYard.has(y)) byYard.set(y, []);
    byYard.get(y).push(f);
  }
  for (const arr of byYard.values()) {
    arr.sort((a,b) => (tailDateKey(b)).localeCompare(tailDateKey(a))); // newest first
  }

  // 'all' => newest for each known yard (skip unknown)
  if (locKey === 'all') {
    const out = [];
    for (const y of T_YARDS) {
      const arr = byYard.get(y);
      if (arr?.length) out.push({ yard:y, file:arr[0] });
    }
    // also include vehicles_of_interest if present as a convenience
    const voi = byYard.get('vehicles_of_interest');
    if (voi?.length) out.push({ yard:'vehicles_of_interest', file:voi[0] });
    return out;
  }

  // specific corpus
  const want = locKey || ''; // '' can happen if Auto before Jalopy chosen
  if (!want) return []; // no yard yet

  if (want === 'vehicles_of_interest') {
    const voi = byYard.get('vehicles_of_interest');
    return voi?.length ? [{ yard:'vehicles_of_interest', file:voi[0] }] : [];
  }

  // specific yard
  const yardFiles = byYard.get(want);
  if (yardFiles?.length) return [{ yard:want, file:yardFiles[0] }];

  // fallback: vehicles_of_interest if yard missing
  const voi = byYard.get('vehicles_of_interest');
  return voi?.length ? [{ yard:'vehicles_of_interest', file:voi[0] }] : [];
}

// CSV utilities
function normalizeSoldRow(r) {
  return {
    year:  r['Year'] ?? r['year'] ?? '',
    make:  r['Make'] ?? r['make'] ?? '',
    model: r['Model'] ?? r['model'] ?? '',
    term:  r['Search Term'] ?? r['search_term'] ?? r['Term'] ?? '',
    title: r['Listing Title'] ?? r['Title'] ?? r['listing_title'] ?? '',
    price: r['Last Sold Price'] ?? r['Sold Price'] ?? r['Price'] ?? r['last_sold_price'] ?? '',
    date:  r['Date Sold'] ?? r['Sold Date'] ?? r['date_sold'] ?? '',
    tts:   r['Time to Sell'] ?? r['Time To Sell'] ?? r['tts'] ?? '',
    total: r['Total Sold'] ?? r['total_sold'] ?? r['Count'] ?? ''
  };
}

function parseCSV(path) {
  return new Promise((resolve, reject) => {
    Papa.parse(path, {
      download: true, header: true,
      complete: res => resolve(res.data || []),
      error: err => reject(err)
    });
  });
}

// ---------- Normalization helpers ----------
function normBasic(s){
  return String(s||'')
    .toLowerCase()
    .normalize('NFKD')                 // strip accents
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/&/g,' and ')
    .replace(/[^a-z0-9]+/g,' ')        // non-alnum -> space
    .replace(/\s+/g,' ')
    .trim();
}

// Keep tokens worth matching: length >= 2 and not in stoplist
const STOP = new Set(['the','a','an','and','or','for','to','of','with','on','at','by','in','from','this','that','these','those']);
function tokenizeQ(s){
  const base = normBasic(s);
  const raw = base.split(' ');
  // Also generate fused tokens to catch things like "f 150" vs "f150"
  const fused = raw.join('');
  const tokens = raw.filter(w => w && w.length >= 2 && !STOP.has(w));
  if (fused.length >= 3) tokens.push(fused);
  return Array.from(new Set(tokens));
}

// Title normalization that also keeps a fused variant (e.g. "F-150" -> "f150")
function prepTitle(s){
  const base = normBasic(s);
  const fused = base.replace(/ /g,'');
  return { base, fused };
}

// ---------- Main predicate: keep row if title contains ANY token from search term ----------
function titleContainsAnySearchWord(searchTerm, listingTitle){
  if (!searchTerm) return true; // if no query provided in the CSV, don't drop it
  const tokens = tokenizeQ(searchTerm);
  if (!tokens.length) return true;

  const { base, fused } = prepTitle(listingTitle || '');
  // require at least one token present in base OR fused
  return tokens.some(t => base.includes(t) || fused.includes(t));
}

// Convenience wrapper for your normalized row object
function keepRowByTitleTerm(row){
  return titleContainsAnySearchWord(row.term, row.title);
}



function debounce(fn, ms=150){
  let t; 
  return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}

function matchesQuery(row, q){
  if (!q) return true;
  const s = q.toLowerCase().trim();
  const hay = [
    row.year || '', row.make || '', row.model || '',
    row.term || ''
  ].join(' ').toLowerCase();
  return hay.includes(s);
}

// ===== Paged + Lazy Grouped Renderer for Trends (Latest) =====
const PAGE_GROUPS = 25;               // how many vehicle groups per â€œpageâ€
let TRENDS_LATEST_ALL_ROWS = [];      // full dataset (already in your code)
let TRENDS_FILTERED_ROWS = [];        // rows after search filter
let TRENDS_GROUPS = [];               // [{key, meta:{year,make,model}, items:[...]}, ...]
let TRENDS_VISIBLE_COUNT = 0;         // how many groups currently rendered
let TRENDS_SCROLL_EL = null;

function buildGroups(rows) {
  const map = new Map();
  rows.forEach(r => {
    const key = [r.year||'', r.make||'', r.model||''].map(s => String(s).trim()).join('|');
    if (!map.has(key)) map.set(key, { key, meta: { year:r.year||'', make:r.make||'', model:r.model||'' }, items: [] });
    map.get(key).items.push(r);
  });
  // Sort groups by Make/Model/Year for stable order (tweak as you like)
  const groups = Array.from(map.values()).sort((a,b) =>
    (a.meta.make||'').localeCompare(b.meta.make||'') ||
    (a.meta.model||'').localeCompare(b.meta.model||'') ||
    String(b.meta.year||'').localeCompare(String(a.meta.year||''))
  );
  return groups;
}

// Render a single group header + (collapsed) container. Child rows are added on first expand.
function appendGroupDOM(tbody, group, idx) {
  const { year, make, model } = group.meta;
  const gid = `grp-${idx}-${Math.random().toString(36).slice(2,8)}`;

  // Group header row
  const headerTr = document.createElement('tr');
  headerTr.className = 'table-secondary group-row';
  headerTr.setAttribute('role', 'button');
  headerTr.setAttribute('data-bs-toggle', 'collapse');
  headerTr.setAttribute('data-bs-target', `#${gid}`);
  headerTr.innerHTML = `
    <td colspan="9" class="fw-semibold">
      <span class="caret me-2">â–¶</span>
      ${year || 'â€”'} ${make || ''} ${model || ''}
      <span class="text-muted ms-2">(${group.items.length} sale${group.items.length===1?'':'s'})</span>
    </td>
  `;
  tbody.appendChild(headerTr);

  // Collapsible container (start collapsed for perf)
  const detailsTr = document.createElement('tr');
  detailsTr.className = 'collapse-row';
  detailsTr.innerHTML = `
    <td colspan="9" class="p-0">
      <div class="collapse" id="${gid}">
        <table class="table table-sm mb-0">
          <tbody></tbody>
        </table>
      </div>
    </td>
  `;
  tbody.appendChild(detailsTr);

  const collapseEl = detailsTr.querySelector('.collapse');
  const innerTbody = detailsTr.querySelector('tbody');
  let renderedChildren = false;

  // On toggle, lazily render children if needed; rotate caret
  collapseEl.addEventListener('shown.bs.collapse', () => {
    if (!renderedChildren) {
      group.items.forEach(it => {
        const rtr = document.createElement('tr');
        rtr.innerHTML = `
          <td class="d-none">${year || ''}</td>
          <td class="d-none">${make || ''}</td>
          <td class="d-none">${model || ''}</td>
          <td>${it.term || ''}</td>
          <td>${it.title || ''}</td>
          <td>${it.price || ''}</td>
          <td>${it.date || ''}</td>
          <td>${it.tts || ''}</td>
          <td>${it.total || ''}</td>
        `;
        innerTbody.appendChild(rtr);
      });
      renderedChildren = true;
    }
    const caret = headerTr.querySelector('.caret');
    if (caret) caret.textContent = 'â–¼';
  });
  collapseEl.addEventListener('hidden.bs.collapse', () => {
    const caret = headerTr.querySelector('.caret');
    if (caret) caret.textContent = 'â–¶';
  });
}

// Reset and render the first page
function renderTrendsLatestPagedReset(rows) {
  const tbody = document.getElementById('trendsTableBody');
  if (!tbody) return;

  // Build state
  TRENDS_FILTERED_ROWS = rows;
  TRENDS_GROUPS = buildGroups(TRENDS_FILTERED_ROWS);
  TRENDS_VISIBLE_COUNT = 0;

  // Clear DOM and render first chunk
  tbody.innerHTML = '';
  renderNextGroupsChunk();

  // Update summary
  const totalGroups = TRENDS_GROUPS.length;
  const totalRows = TRENDS_FILTERED_ROWS.length;
  setTrendsSummary(
    totalRows
      ? `Showing ${Math.min(TRENDS_VISIBLE_COUNT, totalGroups)} of ${totalGroups} vehicles â€¢ ${totalRows} total sales (scroll to load more).`
      : 'No rows in the latest sold-data file(s).'
  );
}

// Append the next chunk of groups
function renderNextGroupsChunk() {
  const tbody = document.getElementById('trendsTableBody');
  if (!tbody) return;
  if (!TRENDS_GROUPS.length) return;

  const start = TRENDS_VISIBLE_COUNT;
  const end = Math.min(start + PAGE_GROUPS, TRENDS_GROUPS.length);
  for (let i = start; i < end; i++) {
    appendGroupDOM(tbody, TRENDS_GROUPS[i], i+1);
  }
  TRENDS_VISIBLE_COUNT = end;

  // Update summary incrementally
  const totalGroups = TRENDS_GROUPS.length;
  const totalRows = TRENDS_FILTERED_ROWS.length;
  setTrendsSummary(
    totalRows
      ? `Showing ${TRENDS_VISIBLE_COUNT} of ${totalGroups} vehicles â€¢ ${totalRows} total sales${TRENDS_VISIBLE_COUNT<totalGroups?' â€¢ keep scrollingâ€¦':''}`
      : 'No rows in the latest sold-data file(s).'
  );
}

// Hook Infinite Scroll on the scroll container
function ensureTrendsInfiniteScroll() {
  if (TRENDS_SCROLL_EL) return; // already wired
  TRENDS_SCROLL_EL = document.getElementById('trendsScroll') || window;
  const targetEl = document.getElementById('trendsScroll');

  const onScroll = () => {
    const el = targetEl;
    // Near bottom?
    const nearBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 100;
    if (nearBottom && TRENDS_VISIBLE_COUNT < TRENDS_GROUPS.length) {
      renderNextGroupsChunk();
    }
  };

  // If we have a dedicated scroll div, listen on it; else listen on window
  if (targetEl) {
    targetEl.addEventListener('scroll', onScroll);
  } else {
    window.addEventListener('scroll', onScroll);
  }
}




// Main loader for Trends (latest only)
async function refreshTrends() {
  setTrendsSummary('Loading latest sold dataâ€¦');
  const locKey = getTrendsLocKey(); // 'all' | 'vehicles_of_interest' | yard | '' (auto before jalopy)
  const index = await loadEbayIndex();

  if (!index.length) {
    setTrendsSummary('No files listed in ebay-sales.json.');
    renderTrendsLatestPagedReset([]);
    return;
  }

  const targets = pickLatestTargets(index, locKey);
  if (!targets.length) {
    setTrendsSummary('No latest sold-data file found for the selected yard.');
    renderTrendsLatestPagedReset([]);
    return;
  }

  // Load and combine
  let totalRows = 0, used = [];
  const combined = [];
  for (const { yard, file } of targets) {
    const path = file.includes('/') ? file : `./ebay-sales/${file}`;
    try {
      const raw = await parseCSV(path);
      const normRows = raw.map(normalizeSoldRow).filter(keepRowByTitleTerm);
      normRows.forEach(n => combined.push({ ...n, _yard: yard }));
      used.push(`${yard}:${file}`);
      totalRows += normRows.length;
    } catch (e) {
      console.warn('[Trends/latest] Failed to parse', path, e);
    }
  }

  renderTrendsLatestPagedReset(combined);
  renderTrendsLatestPagedReset(combined);
  TRENDS_LATEST_ALL_ROWS = combined;
  const q = document.getElementById('trendsSearch')?.value || '';
  const filtered = TRENDS_LATEST_ALL_ROWS.filter(r => matchesQuery(r, q));
  renderTrendsLatestPagedReset(filtered);
  ensureTrendsInfiniteScroll();

  setTrendsSummary(
    totalRows
      ? `Loaded ${totalRows} rows from latest file${targets.length>1?'s':''}. (${used.join(' â€¢ ')})`
      : 'No rows found in the latest file(s).'
  );

  // Debug
  console.debug('[Trends/latest] locKey:', locKey, 'targets:', targets);
}

// Wire up: refresh on tab show, button, and yard changes
document.addEventListener('DOMContentLoaded', () => {
  // Refresh when Trends tab becomes visible
  document.querySelector('button[data-bs-target="#trendsTab"]')
    ?.addEventListener('shown.bs.tab', refreshTrends);

  // Optional: a "Refresh" button you might have in Trends controls
  document.getElementById('refreshTrendsBtn')
    ?.addEventListener('click', refreshTrends);

  // If yard selector exists in Trends, refresh on change
  document.getElementById('trendsYard')
    ?.addEventListener('change', () => {
      const active = document.querySelector('#trendsTab.show');
      if (active) refreshTrends();
    });

  // If following Jalopy (Auto) and Jalopy yard changes, refresh only if Trends is visible
  document.getElementById('csvSelector')
    ?.addEventListener('change', () => {
      const isAuto = (document.getElementById('trendsYard')?.value || 'auto') === 'auto';
      const active = document.querySelector('#trendsTab.show');
      if (isAuto && active) refreshTrends();
    });
	
	const trendsSearch = document.getElementById('trendsSearch');
if (trendsSearch){
  const runFilter = debounce(() => {
    const q = trendsSearch.value || '';
    const filtered = TRENDS_LATEST_ALL_ROWS.filter(r => matchesQuery(r, q));
    renderTrendsLatestPagedReset(filtered); // re-render grouped view with filtered rows
  }, 180);
  trendsSearch.addEventListener('input', runFilter);
}

});
</script>




  <!-- ===== Sticky Notes JS (non-intrusive; waits until unlocked) ===== -->
  <script>
  (() => {
    const STICKY_KEY = 'profitStickyNotes';
    const STICKY_Z   = 'profitStickyZ';
    let stickyZCounter = parseInt(localStorage.getItem(STICKY_Z) || '2100', 10);

    const save = (arr) => localStorage.setItem(STICKY_KEY, JSON.stringify(arr));
    const load = () => { try { return JSON.parse(localStorage.getItem(STICKY_KEY) || '[]'); } catch { return []; } };
    const front = (el) => { stickyZCounter += 1; el.style.zIndex = stickyZCounter; localStorage.setItem(STICKY_Z, String(stickyZCounter)); };

    function createStickyDOM(sticky, persist=true) {
      const el = document.createElement('div');
      el.className = `sticky-note ${sticky.color || 'yellow'}`;
      el.dataset.id = sticky.id;
      el.style.left = (sticky.x ?? 120) + 'px';
      el.style.top  = (sticky.y ?? 120) + 'px';
      el.style.width  = (sticky.w ?? 220) + 'px';
      el.style.height = (sticky.h ?? 160) + 'px';
      el.style.zIndex = sticky.z ?? (stickyZCounter += 1);

      const header = document.createElement('div');
      header.className = 'sticky-header';
      header.innerHTML = `
        <span class="sticky-title"><i class="bi bi-grip-vertical me-1"></i> Note</span>
        <div class="sticky-actions btn-group">
          <button class="btn btn-light btn-sm dropdown-toggle" data-bs-toggle="dropdown" title="Color">
            <span class="sticky-color sticky-${sticky.color || 'yellow'}"></span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" data-color="yellow"><span class="sticky-color sticky-yellow me-2"></span>Yellow</a></li>
            <li><a class="dropdown-item" data-color="blue"><span class="sticky-color sticky-blue me-2"></span>Blue</a></li>
            <li><a class="dropdown-item" data-color="pink"><span class="sticky-color sticky-pink me-2"></span>Pink</a></li>
            <li><a class="dropdown-item" data-color="green"><span class="sticky-color sticky-green me-2"></span>Green</a></li>
          </ul>
          <button class="btn btn-outline-danger btn-sm" title="Delete"><i class="bi bi-trash"></i></button>
        </div>
      `;

      const body = document.createElement('div');
      body.className = 'sticky-body';
      body.contentEditable = 'true';
      body.innerText = sticky.text || '';

      el.appendChild(header);
      el.appendChild(body);
      document.body.appendChild(el);

      // drag
      let dragging = false, startX=0, startY=0, baseX=0, baseY=0;
      header.addEventListener('mousedown', (e) => {
        dragging = true;
        front(el);
        startX = e.clientX; startY = e.clientY;
        baseX = parseInt(el.style.left,10); baseY = parseInt(el.style.top,10);
        e.preventDefault();
      });
      document.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        const dx = e.clientX - startX, dy = e.clientY - startY;
        el.style.left = (baseX + dx) + 'px';
        el.style.top  = (baseY + dy) + 'px';
      });
      document.addEventListener('mouseup', () => {
        if (!dragging) return;
        dragging = false;
        persistPositionSize(el);
      });

      // resize persistence
      const resizeObserver = new ResizeObserver(() => persistPositionSize(el));
      resizeObserver.observe(el);

      // focus brings to front
      body.addEventListener('focus', () => front(el));

      // text save (debounced)
      let t;
      body.addEventListener('input', () => {
        clearTimeout(t);
        t = setTimeout(() => {
          const all = load();
          const idx = all.findIndex(s => s.id === sticky.id);
          if (idx >= 0) {
            all[idx].text = body.innerText;
            save(all);
          }
        }, 250);
      });

      // color change
      header.querySelectorAll('.dropdown-menu .dropdown-item').forEach(a => {
        a.addEventListener('click', () => {
          const color = a.getAttribute('data-color');
          el.classList.remove('yellow','blue','pink','green');
          el.classList.add(color);
          header.querySelector('.sticky-color').className = `sticky-color sticky-${color}`;
          const all = load();
          const idx = all.findIndex(s => s.id === sticky.id);
          if (idx >= 0) { all[idx].color = color; save(all); }
        });
      });

      // delete
      header.querySelector('.btn-outline-danger').addEventListener('click', () => {
        const all = load().filter(s => s.id !== sticky.id);
        save(all);
        el.remove();
      });

      function persistPositionSize(elRef) {
        const rect = elRef.getBoundingClientRect();
        const all = load();
        const idx = all.findIndex(s => s.id === sticky.id);
        if (idx >= 0) {
          all[idx].x = Math.max(0, Math.round(rect.left));
          all[idx].y = Math.max(0, Math.round(rect.top));
          all[idx].w = Math.round(rect.width);
          all[idx].h = Math.round(rect.height);
          all[idx].z = parseInt(elRef.style.zIndex || '2100', 10);
          save(all);
        }
      }

      // initial persist if new
      if (persist) {
        const all = load();
        all.push(sticky);
        save(all);
      }

      return el;
    }

    function addSticky(defaults={}) {
      const id = 's_' + Date.now() + '_' + Math.floor(Math.random()*1000);
      const base = {
        id, text:'', x: 140 + Math.floor(Math.random()*80), y: 120 + Math.floor(Math.random()*80),
        w: 220, h: 160, color: 'yellow', z: ++stickyZCounter
      };
      localStorage.setItem(STICKY_Z, String(stickyZCounter));
      createStickyDOM({ ...base, ...defaults }, true);
    }

    function renderAllStickies() {
      load().forEach(s => createStickyDOM(s, false));
      const fab = document.getElementById('stickyFab'); if (fab) fab.style.display = '';
    }

    // quick actions
    function wireUI() {
      document.getElementById('addStickyBtn')?.addEventListener('click', () => addSticky());
      document.getElementById('fabAddSticky')?.addEventListener('click', () => addSticky());
      document.getElementById('fabClearStickies')?.addEventListener('click', () => {
        if (!confirm('Delete all sticky notes?')) return;
        localStorage.setItem(STICKY_KEY, '[]');
        document.querySelectorAll('.sticky-note').forEach(n => n.remove());
      });
      document.addEventListener('keydown', (e) => {
        if (e.shiftKey && (e.key === 'N' || e.key === 'n')) {
          e.preventDefault(); addSticky();
        }
      });
    }

    // Wait until blur (serial-locked) is removed, then init stickies
    function whenUnlocked(fn) {
      if (!document.body.classList.contains('serial-locked')) { fn(); return; }
      const mo = new MutationObserver(() => {
        if (!document.body.classList.contains('serial-locked')) { mo.disconnect(); fn(); }
      });
      mo.observe(document.body, { attributes:true, attributeFilter:['class'] });
    }

    // Boot
    document.addEventListener('DOMContentLoaded', () => {
      wireUI();
      whenUnlocked(() => renderAllStickies());
    });
  })();
  </script>
</body>
</html>
