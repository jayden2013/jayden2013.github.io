<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jalopy Jungle Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      transition: background 0.3s, color 0.3s;
      margin: 0;
      padding: 0;
    }
    .dark-mode {
      background: #121212;
      color: #f0f0f0;
    }
    nav {
      display: flex;
      justify-content: space-between;
      padding: 1em;
      background: #333;
      color: white;
    }
    .container {
      padding: 1em;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      content: "";
      position: absolute;
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .tabs {
      margin: 1em 0;
    }
    .tab-button {
      margin-right: 0.5em;
      padding: 0.5em 1em;
      border: none;
      background: #eee;
      cursor: pointer;
    }
    .tab-button.active {
      background: #ccc;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .dark-mode tr:hover {
      background-color: #333333;
    }
    select {
      margin: 0.5em 0;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0; top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
    }
    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 1em;
      width: 90%;
      max-width: 400px;
    }
    .dark-mode .modal-content {
      background: #1e1e1e;
      color: white;
    }
    .close {
      float: right;
      font-size: 1.5em;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav>
    <div><strong>Jalopy Jungle Dashboard</strong></div>
    <label class="switch">
      <input type="checkbox" id="darkModeToggle">
      <span class="slider"></span>
    </label>
  </nav>

  <div class="container">
    <div class="tabs">
      <button class="tab-button active" onclick="showTab('inventory')">Inventory Table</button>
      <button class="tab-button" onclick="showTab('stats')">Statistics</button>
    </div>

    <div id="inventory" class="tab-content active">
      <label>Select Inventory File:
        <select id="csvSelector"></select>
      </label>
      <table id="inventoryTable">
        <thead>
          <tr><th>Year</th><th>Make</th><th>Model</th><th>Notes</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="stats" class="tab-content">
      <p>Average Vehicle Age: <span id="avgAge">-</span></p>
      <p>Unique Models: <span id="modelCount">-</span></p>
    </div>
  </div>

  <!-- Modal -->
  <div id="rowModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 id="modalTitle"></h3>
      <textarea id="noteInput" rows="4" style="width:100%"></textarea>
      <button onclick="saveNote()">Save Note</button>
      <button onclick="alert('Sold data view not implemented')">View Sold Data</button>
    </div>
  </div>

  <script>
    const toggle = document.getElementById('darkModeToggle');
    const modal = document.getElementById('rowModal');
    const noteInput = document.getElementById('noteInput');
    const modalTitle = document.getElementById('modalTitle');
    let currentRowKey = "";

    toggle.addEventListener('change', () => {
      document.body.classList.toggle('dark-mode', toggle.checked);
      localStorage.setItem('darkMode', toggle.checked);
    });

    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
    }

    function closeModal() {
      modal.style.display = 'none';
    }

    function saveNote() {
      localStorage.setItem(`note-${currentRowKey}`, noteInput.value);
      modal.style.display = 'none';
      loadCSV(document.getElementById('csvSelector').value);
    }

    window.onclick = (e) => { if (e.target === modal) closeModal(); };

    window.onload = () => {
      const dark = JSON.parse(localStorage.getItem('darkMode'));
      toggle.checked = dark;
      if (dark) document.body.classList.add('dark-mode');
      fetch("inventory-csvs/index.json")
        .then(res => res.json())
        .then(list => {
          const selector = document.getElementById('csvSelector');
          list.forEach(file => {
            const opt = document.createElement('option');
            opt.value = file;
            opt.textContent = file;
            selector.appendChild(opt);
          });
          loadCSV(list[0]);
          selector.onchange = () => loadCSV(selector.value);
        });
    };

    function loadCSV(file) {
      fetch(`inventory-csvs/${file}`)
        .then(res => res.text())
        .then(text => {
          const rows = text.trim().split("\n").slice(1).map(row => row.split(","));
          const tbody = document.querySelector("#inventoryTable tbody");
          tbody.innerHTML = "";
          const models = new Set();
          let yearSum = 0;

          rows.forEach(parts => {
            const [year, make, model] = parts;
            const key = `${year}-${make}-${model}`;
            const note = localStorage.getItem(`note-${key}`) || "";
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${year}</td><td>${make}</td><td>${model}</td><td>${note}</td>`;
            tr.onclick = () => {
              currentRowKey = key;
              modalTitle.textContent = `${year} ${make} ${model}`;
              noteInput.value = note;
              modal.style.display = "block";
            };
            tbody.appendChild(tr);
            models.add(model);
            yearSum += parseInt(year);
          });

          const avg = rows.length ? (new Date().getFullYear() - (yearSum / rows.length)).toFixed(1) : "-";
          document.getElementById('avgAge').textContent = avg;
          document.getElementById('modelCount').textContent = models.size;
        });
    }
  </script>
</body>
</html>
