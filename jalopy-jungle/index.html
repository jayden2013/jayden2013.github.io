<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PROFIT - Parts Resale Optimization & Field Inventory Tool</title>

  <!-- Bootstrap & libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

  <style>
    /* ---------- Theme / base ---------- */
    body.dark-mode { background-color:#121212; color:#f1f1f1; }
    body.dark-mode .table { color:#f1f1f1; }
    body.dark-mode .table-dark { background-color:#2c2c2c; }
    body.dark-mode .small, body.dark-mode .small a { color:#f0f0f0 !important; }

    th { cursor:pointer; }
    .display-1:hover { color:orange; cursor:pointer; }
    .btn.disabled-look { opacity:.5; cursor:not-allowed; }

    /* Hover highlight */
    #inventoryTable tbody tr:hover td,
    #trustyTable tbody tr:hover td { background-color:orange !important; color:#000; }

    /* Dark-mode styling for modals */
    .dark-mode .modal-content,
    .dark-mode .modal-content .modal-header,
    .dark-mode .modal-content .modal-body,
    .dark-mode .modal-content .modal-footer {
      background-color:#2c2c2c; color:#f1f1f1;
    }

    /* Nav active text orange */
    .nav-tabs .nav-link.active, .nav-pills .nav-link.active { color:orange !important; }

    /* ---------- App lock / blur ---------- */
    .serial-locked #appRoot { filter: blur(6px); pointer-events: none; user-select: none; }
    .serial-locked .modal { pointer-events: auto; }
    .force-show-modal .modal { display:block !important; opacity:1 !important; }
    .force-show-modal .modal-backdrop { display:block !important; opacity:.45 !important; }

    /* Login modal look */
    #serialGate .modal-content { border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,.35); }
    #serialGateBrand { font-weight: 800; letter-spacing: .5px; }

    .btn-premium { background-color:gold !important; border-color:goldenrod !important; color:#000 !important; }
  </style>
</head>

<body class="serial-locked"><!-- start locked -->

  <!-- ====== GATE / LOGIN MODAL ====== -->
  <div class="modal fade" id="serialGate" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3 p-md-4">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title" id="serialGateBrand">PROFIT Access</h5>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">Enter your serial key to unlock all features.</p>
          <div class="mb-2">
            <label class="form-label">Serial Key</label>
            <input id="serialInput" class="form-control form-control-lg" placeholder="e.g. ABC-123-XYZ">
          </div>
          <div id="serialFeedback" class="text-danger small mt-1" style="display:none;">Invalid serial key.</div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button class="btn btn-primary w-100" id="submitSerial">Unlock</button>
        </div>
        <div class="text-center text-muted small mt-2">
          Need help? Contact <a href="https://carsandcollectibles.com" target="_blank">Cars &amp; Collectibles LLC</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== APP ROOT (blurred while locked) ====== -->
  <div id="appRoot">
    <div class="container py-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <div class="display-1">PROFIT</div>
          <div class="h5">Parts Resale Optimization &amp; Field Inventory Tool</div>
          <div class="small">Cars and Collectibles LLC</div>
          <div class="small"><a href="https://carsandcollectibles.com" target="_blank">carsandcollectibles.com</a></div>
        </div>
        <div>
          <!-- Settings available after unlock -->
          <button class="btn btn-outline-secondary me-2" id="settingsBtn">‚öôÔ∏è Settings</button>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#jalopyTab" type="button">Jalopy Jungle</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#trustyTab" type="button">Trusty</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pickListTab" type="button">Pick List</button>
        </li>
		<li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pricesTab" type="button">Prices</button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content pt-3">
        <!-- Jalopy -->
        <div class="tab-pane fade show active" id="jalopyTab">
          <div class="mb-3">
            <select class="form-select" id="csvSelector"></select>
          </div>
          <div class="mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="Filter rows...">
          </div>
          <div class="mb-3">
            <button class="btn btn-success" id="exportBtn">Export Table to CSV</button>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-bordered" id="inventoryTable">
              <thead class="table-dark"><tr id="tableHeader"></tr></thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>

          <div id="statistics" class="mt-3 small"></div>
          <canvas id="ageChart" style="max-width:100%; margin-top:1em;"></canvas>
        </div>

        <!-- Trusty -->
        <div class="tab-pane fade" id="trustyTab">
          <div class="mb-3">
            <select class="form-select" id="trustySelector"></select>
          </div>
          <div class="mb-3">
            <input type="text" id="trustySearchInput" class="form-control" placeholder="Filter rows...">
          </div>
          <div class="mb-3">
            <button class="btn btn-success" id="trustyExportBtn">Export Table to CSV</button>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-bordered" id="trustyTable">
              <thead class="table-dark"><tr id="trustyTableHeader"></tr></thead>
              <tbody id="trustyTableBody"></tbody>
            </table>
          </div>

          <div id="trustyStatistics" class="mt-3 small"></div>
          <canvas id="trustyAgeChart" style="max-width:100%; margin-top:1em;"></canvas>
        </div>

        <!-- Prices (placeholder) -->
        <div class="tab-pane fade" id="pricesTab">
          <div class="text-muted">Coming soon: Prices</div>
        </div>

        <!-- Pick List: standalone tab -->
        <div class="tab-pane fade" id="pickListTab">
		<div class="mb-3">
			<button class="btn btn-success" id="exportPickListBtn">Export Table to CSV</button>
		</div>

          <div class="table-responsive">
            <table class="table table-striped table-bordered" id="pickListTable">
              <thead class="table-dark">
                <tr>
                  <th>Year</th>
                  <th>Make</th>
                  <th>Model</th>
                  <th>Row</th>
                  <th>Yard</th>
                  <th>Notes</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <tbody id="pickListBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
	
	<!-- Export Pick List Modal -->
<div class="modal fade" id="exportPickListModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Export Pick List</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="pickExportMode" id="exportAsIs" value="asis" checked>
          <label class="form-check-label" for="exportAsIs">
            Export the table as it is (current order)
          </label>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="radio" name="pickExportMode" id="exportGrouped" value="grouped">
          <label class="form-check-label" for="exportGrouped">
            Export with vehicles grouped by Yard
          </label>
        </div>

        <div class="form-check">
          <input class="form-check-input" type="radio" name="pickExportMode" id="exportSingleYard" value="single">
          <label class="form-check-label" for="exportSingleYard">
            Export only a single Yard
          </label>
        </div>

        <div class="mt-2">
          <select id="singleYardSelect" class="form-select" disabled>
            <option value="">Select Yard‚Ä¶</option>
          </select>
        </div>

        <div class="small text-muted mt-3">
          CSV columns: Year, Make, Model, Row, Yard, Notes
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" id="confirmExportPick">Export</button>
      </div>
    </div>
  </div>
</div>


    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="homeYardSelect" class="form-label">Home Yard</label>
              <select id="homeYardSelect" class="form-select">
                <option value="">-- select yard --</option>
                <option>Boise</option>
                <option>Caldwell</option>
                <option>Garden City</option>
                <option>Nampa</option>
                <option>Twin Falls</option>
              </select>
            </div>

            <button class="btn btn-outline-secondary w-100 mb-2" id="modalToggleDark">Toggle Dark Mode</button>

            <!-- Favorites -->
            <hr>
            <div class="mb-3">
              <h6>üéØ Favorite Vehicles</h6>
              <div class="d-flex gap-2">
                <input id="favYearInput" type="number" class="form-control" placeholder="Year"/>
                <input id="favMakeInput" type="text" class="form-control" placeholder="Make"/>
                <input id="favModelInput" type="text" class="form-control" placeholder="Model"/>
                <button class="btn btn-sm btn-primary" id="addFavVehicleBtn">Add</button>
              </div>
              <ul id="favVehiclesList" class="list-group list-group-flush mt-2"></ul>
            </div>

            <!-- Data code sync -->
            <hr>
            <button class="btn btn-outline-primary w-100 mb-2" id="exportDataBtn">üìã Copy Data Code</button>
            <textarea id="dataCodeOutput" class="form-control mb-2" rows="3" readonly placeholder="Your data code will appear here‚Ä¶"></textarea>
            <label for="dataCodeInput" class="form-label">Paste Data Code to Sync:</label>
            <textarea id="dataCodeInput" class="form-control mb-2" rows="3" placeholder="Paste someone‚Äôs data code here‚Ä¶"></textarea>
            <button class="btn btn-primary w-100" id="importDataBtn">üîÑ Import Data Code</button>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-primary" id="saveSettings">Save Settings</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Note</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea id="noteInput" class="form-control" rows="4" placeholder="Enter your note here..."></textarea>
            <div id="noteLimitInfo" class="text-muted mt-2" style="display:none;">Notes are limited to 20 characters. Upgrade to premium for unlimited characters.</div>
            <div id="noteLengthFeedback" class="text-danger mt-2" style="display:none;">Max 20 characters for non-premium users.</div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-danger" id="clearNote">Clear Note</button>
            <button class="btn btn-primary" id="saveNote">Save Note</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sold Data Modal -->
    <div class="modal fade" id="soldModal" tabindex="-1" aria-labelledby="soldModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="soldModalLabel">Sold Data</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="soldDataContainer">
              <table class="table table-striped table-bordered">
                <thead class="table-dark">
                  <tr>
                    <th>Search Term</th>
                    <th>Listing Title</th>
                    <th>Last Sold Price</th>
                    <th>Date Sold</th>
                    <th>Time To Sell</th>
                    <th>Total Sold</th>
                  </tr>
                </thead>
                <tbody id="soldDataBody"></tbody>
              </table>
            </div>
            <div id="soldDataEmpty" class="text-center text-muted" style="display:none;">
              No sold data found for this vehicle.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast container for favorite-vehicle alerts -->
    <div id="favToastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>
  </div><!-- /#appRoot -->

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /***********************
   * Premium / Serial Gate
   ***********************/
  let isPremium = false, premiumName = '';
  let serialData = []; // from json/serial-keys.json

  function getGateInstance() {
    return bootstrap.Modal.getOrCreateInstance(
      document.getElementById('serialGate'),
      { backdrop:'static', keyboard:false }
    );
  }
  function showGate() {
    document.body.classList.add('serial-locked');
    try {
      const inst = getGateInstance();
      inst.show();
      document.getElementById('serialGate')
        .addEventListener('shown.bs.modal', () => {
          const input = document.getElementById('serialInput');
          if (input) input.focus();
        }, { once:true });
      setTimeout(() => {
        const gateEl = document.getElementById('serialGate');
        if (!gateEl.classList.contains('show')) {
          document.body.classList.add('force-show-modal');
        }
      }, 100);
    } catch {
      document.body.classList.add('force-show-modal');
    }
  }
  function unlockApp(name) {
    isPremium = true; premiumName = name || '';
    document.body.classList.remove('serial-locked','force-show-modal');
    const inst = bootstrap.Modal.getInstance(document.getElementById('serialGate'));
    if (inst) inst.hide();
    initApp();
  }
  async function validateStoredKey() {
    try {
      const r = await fetch('json/serial-keys.json');
      serialData = await r.json();
    } catch (e) {
      console.warn('Could not load serial-keys.json:', e);
      serialData = [];
    }
    const saved = localStorage.getItem('premiumKey');
    const entry = serialData.find(e => e.key === saved);
    if (entry) { unlockApp(entry.name); } else { showGate(); }

    const submitBtn = document.getElementById('submitSerial');
    const inputEl   = document.getElementById('serialInput');
    submitBtn.onclick = () => {
      const key = inputEl.value.trim();
      const match = serialData.find(e => e.key === key);
      if (match) {
        localStorage.setItem('premiumKey', key);
        document.getElementById('serialFeedback').style.display = 'none';
        unlockApp(match.name);
      } else {
        document.getElementById('serialFeedback').style.display = 'block';
      }
    };
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); submitBtn.click(); }
    });
  }

  /***********************
   * App state & helpers
   ***********************/
  const PREV_INV_KEY = 'prevInventorySnapshot';
  const FAV_KEY = 'favoriteVehicles';
  const PREV_KEY = 'prevFavoriteSnapshot';

  const LOCATION_KEYS  = ['boise','caldwell','garden_city','nampa','twin_falls'];
  const LOCATION_NAMES = { boise:'Boise', caldwell:'Caldwell', garden_city:'Garden City', nampa:'Nampa', twin_falls:'Twin Falls' };

  let notes = {};
  let selectedRowKey = null;
  let currentData = [];     // Jalopy current
  let sortDirection = {};
  let ageChart = null;

  let trustyData = [];      // Trusty current
  let trustySortDirection = {};
  let trustyAgeChart = null;

  /* Utility to parse inventory filenames with both time separators:
     inventory_boise_2025-06-08_07-17-49.csv
     inventory_trusty_2025-08-25-07-20-23.csv */
  function parseStamp(filename, expectTrusty=false) {
    const base = String(filename).trim();
    const re = expectTrusty
      ? /^inventory_(.+?)_(\d{4}-\d{2}-\d{2})[_-](\d{2})[-_](\d{2})[-_](\d{2})\.csv$/i
      : /^inventory_(.+?)_(\d{4}-\d{2}-\d{2})[_-](\d{2})[-_](\d{2})[-_](\d{2})\.csv$/i;
    const m = base.match(re);
    if (!m) return null;
    const loc = m[1].toLowerCase();
    const dtKey = `${m[2].replaceAll('-','')}${m[3]}${m[4]}${m[5]}`;
    const dtDisplay = `${m[2]} ${m[3]}:${m[4]}:${m[5]}`;
    return { loc, dtKey, dtDisplay, filename: base };
  }

  function showFavToast(htmlContent) {
    const container = document.getElementById('favToastContainer');
    const toastEl = document.createElement('div');
    toastEl.className = 'toast'; toastEl.role = 'alert';
    toastEl.ariaLive = 'assertive'; toastEl.ariaAtomic = 'true';
    toastEl.innerHTML = `
      <div class="toast-header">
        <strong class="me-auto">üö® New Favorite!</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body">${htmlContent}</div>`;
    container.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
    toast.show();
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
  }

  function checkNewFavoriteVehicles(data = window.currentData) {
    const favs = JSON.parse(localStorage.getItem(FAV_KEY) || '[]')
      .map(v => `${v.year.trim()} / ${v.make.trim()} / ${v.model.trim()}`);
    if (!favs.length) return;

    const todayLabels = Array.from(new Set(
      data.map(r => `${String(r.Year).trim()} / ${String(r.Make).trim()} / ${String(r.Model).trim()}`)
    ));
    const prevLabels = JSON.parse(localStorage.getItem(PREV_INV_KEY) || '[]');
    const newLabels  = todayLabels.filter(lbl => !prevLabels.includes(lbl));
    const hits = newLabels.filter(lbl => favs.includes(lbl));
    if (hits.length) showFavToast(hits.map(l => `‚Ä¢ ${l}`).join('<br>'));
    localStorage.setItem(PREV_INV_KEY, JSON.stringify(todayLabels));
  }

  function applyHomeYardDefault() {
    const home = (localStorage.getItem('homeYard') || '').trim().toLowerCase().replace(/\s+/g,'_');
    if (!home) return;
    const selector = document.getElementById('csvSelector');
    const opt = selector.querySelector(`option[data-loc="${home}"]`);
    if (opt) { selector.value = opt.value; loadCSV(opt.value); }
  }

  /********* Jalopy listing *********/
  async function listCSVFiles() {
    const selector = document.getElementById('csvSelector');
    selector.innerHTML = '';
    try {
      const res = await fetch('./inventory-csvs/index.json', { cache:'no-store' });
      const files = await res.json();
      const latest = {};
      files.forEach(f => {
        const p = parseStamp(f, false);
        if (!p) return;
        if (!latest[p.loc] || p.dtKey > latest[p.loc].dtKey) latest[p.loc] = p;
      });

      LOCATION_KEYS.forEach(locKey => {
        const entry = latest[locKey];
        if (!entry) return;
        const opt = document.createElement('option');
        opt.value = 'inventory-csvs/' + entry.filename;
        opt.dataset.loc = locKey;
        opt.textContent = `${LOCATION_NAMES[locKey]} (${entry.dtDisplay})`;
        selector.appendChild(opt);
      });

      selector.onchange = (e) => {
        const locKey = e.target.selectedOptions[0].dataset.loc;
        localStorage.setItem('homeYard', locKey);
        loadCSV(e.target.value);
      };

      let savedHome = (localStorage.getItem('homeYard') || '').trim().toLowerCase().replace(/\s+/g,'_');
      const toSelect = selector.querySelector(`option[data-loc="${savedHome}"]`) || selector.options[0];
      if (toSelect) { selector.value = toSelect.value; loadCSV(toSelect.value); }
    } catch (err) {
      console.error('Error listing inventory CSVs (Jalopy):', err);
    }
  }

  function loadCSV(path) {
    document.getElementById('searchInput').value = '';
    Papa.parse(path, {
      download:true, header:true,
      complete(r) {
        currentData = r.data.filter(row => row.Year && row.Make && row.Model && row.Row);
        checkNewFavoriteVehicles(currentData);
        renderTable(currentData);
        showStatistics(currentData);
      }
    });
  }

  function renderTable(data) {
    const hdr = document.getElementById('tableHeader');
    const bd  = document.getElementById('tableBody');
    hdr.innerHTML = ''; bd.innerHTML = '';
    if (!data.length) return;

    const cols = Object.keys(data[0]).concat('Note','Pick');
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      th.onclick = () => sortTableByColumn(c);
      hdr.appendChild(th);
    });

    const storedPick = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const pickKeys = new Set(storedPick.map(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|')));

    data.forEach(row => {
      const tr  = document.createElement('tr');
      const key = Object.values(row).join('|');
      tr.dataset.key = key;

      Object.values(row).forEach(v => {
        const td = document.createElement('td');
        td.textContent = v; tr.appendChild(td);
      });

      // Note cell
      const nt = document.createElement('td');
      nt.textContent = (notes[key] || '');
      nt.style.cursor = 'pointer';
      nt.addEventListener('click', e => {
        e.stopPropagation();
        selectedRowKey = key;
        const ni = document.getElementById('noteInput');
        ni.value = notes[key] || '';
        document.getElementById('noteLengthFeedback').style.display = 'none';
        document.getElementById('noteLimitInfo').style.display = 'none'; // whole app is paid now
        new bootstrap.Modal(document.getElementById('noteModal')).show();
      });
      tr.appendChild(nt);

      tr.addEventListener('click', () => openSoldModal(row));

      // Pick
      const pickTd = document.createElement('td');
      const btn = document.createElement('button');
      btn.classList.add('pick-btn','btn','btn-sm');

      if (pickKeys.has(['Year','Make','Model','Row'].map(k => row[k]).join('|'))) {
        btn.textContent = '‚úì Picked'; btn.classList.add('btn-success'); tr.classList.add('table-success');
      } else {
        btn.textContent = '‚ûï Pick'; btn.classList.add('btn-outline-primary');
      }

      btn.addEventListener('click', e => {
        e.stopPropagation();
        const isPicked = btn.classList.contains('btn-success');
        const selector = document.getElementById('csvSelector');
        const locKey = selector?.selectedOptions?.[0]?.dataset?.loc || '';
        const yardName = `Jalopy Jungle ` + LOCATION_NAMES[locKey] || (locKey ? locKey : '');

        if (!isPicked) {
          addToPickList({ ...row, Yard: yardName });
          btn.textContent = '‚úì Picked';
          btn.classList.replace('btn-outline-primary','btn-success');
          tr.classList.add('table-success');
        } else {
          removeFromPickList(['Year','Make','Model','Row'].map(k => row[k]).join('|'));
          btn.textContent = '‚ûï Pick';
          btn.classList.replace('btn-success','btn-outline-primary');
          tr.classList.remove('table-success');
        }
      });

      pickTd.appendChild(btn);
      tr.appendChild(pickTd);
      bd.appendChild(tr);
    });

    document.getElementById('searchInput').oninput = function() {
      const q = this.value.toLowerCase();
      const filtered = currentData.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(q)));
      renderTable(filtered);
      showStatistics(filtered);
    };
  }

  function sortTableByColumn(col) {
    const dir = sortDirection[col] === 'asc' ? 'desc' : 'asc';
    sortDirection[col] = dir;
    currentData.sort((a,b) => a[col] < b[col] ? (dir==='asc'?-1:1) : a[col] > b[col] ? (dir==='asc'?1:-1) : 0);
    renderTable(currentData); showStatistics(currentData);
  }

  document.getElementById('saveNote').onclick = () => {
    const ni = document.getElementById('noteInput'), val = ni.value;
    document.getElementById('noteLengthFeedback').style.display = 'none';
    if (selectedRowKey) {
      notes[selectedRowKey] = val;
      localStorage.setItem('jalopyNotes', JSON.stringify(notes));
      renderTable(currentData);
      renderTrustyTable(trustyData); // keep notes mirrored in Trusty view too
    }
    bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
  };
  document.getElementById('clearNote').onclick = () => {
    if (selectedRowKey) {
      delete notes[selectedRowKey];
      localStorage.setItem('jalopyNotes', JSON.stringify(notes));
      renderTable(currentData);
      renderTrustyTable(trustyData);
      document.getElementById('noteInput').value = '';
      document.getElementById('noteLengthFeedback').style.display = 'none';
    }
  };

function exportTableToCSVGeneric(hdrSel, bodySel, filename, excludeHeaders = ['Pick']) {
  // read headers and figure out which columns to include (exclude 'Pick')
  const rawHeaders = Array.from(document.querySelectorAll(hdrSel + ' th'))
    .map(th => th.textContent.trim());
  const excludeSet = new Set(excludeHeaders.map(h => h.trim().toLowerCase()));
  const keepIdx = rawHeaders
    .map((h, i) => ({ h, i }))
    .filter(({ h }) => !excludeSet.has(h.toLowerCase()))
    .map(({ i }) => i);
  const headers = keepIdx.map(i => rawHeaders[i]);

  // read rows but keep only columns we want
  const rows = Array.from(document.querySelectorAll(bodySel + ' tr')).map(tr => {
    const cells = Array.from(tr.cells).map(td => td.textContent);
    return keepIdx.map(i => cells[i] ?? '');
  });

  // csv escape + download
  const csvEscape = (val) => {
    const s = String(val ?? '');
    const needsQuotes = /[",\n]/.test(s);
    const escaped = s.replace(/"/g, '""');
    return needsQuotes ? `"${escaped}"` : escaped;
  };

  const csv = [
    headers.map(csvEscape).join(','),
    ...rows.map(r => r.map(csvEscape).join(','))
  ].join('\n');

  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.append(a);
  a.click();
  a.remove();
}
  document.getElementById('exportBtn').onclick = () => exportTableToCSVGeneric('#tableHeader', '#tableBody', 'inventory_with_notes.csv');

  function showStatistics(data) {
    const s = document.getElementById('statistics');
    const valid = data.map(r => {
      const y = parseInt(r.Year), rn = parseInt(r.Row);
      return (!isNaN(y) && !isNaN(rn)) ? { row:rn, age:new Date().getFullYear()-y } : null;
    }).filter(Boolean);

    if (!valid.length) {
      s.innerHTML = `<strong>Average Age:</strong> N/A<br/>
                     <strong># Models:</strong> 0<br/>
                     <strong># Makes:</strong> 0<br/>
                     <strong>Newest Age:</strong> N/A<br/>
                     <strong>Oldest Age:</strong> N/A`;
      if (ageChart){ ageChart.destroy(); ageChart=null; }
      return;
    }

    valid.sort((a,b)=>a.row-b.row);
    const cum=[]; valid.forEach((it,i)=>{
      const slice=valid.slice(0,i+1).map(x=>x.age);
      cum.push(+(slice.reduce((s,v)=>s+v,0)/slice.length).toFixed(1));
    });
    const ages = valid.map(x=>x.age);
    const models=new Set(data.map(r=>`${r.Make}|${r.Model}`));
    const makes=new Set(data.map(r=>r.Make));

    s.innerHTML = `<strong>Average Age:</strong> ${cum.at(-1)}<br/>
                   <strong># Models:</strong> ${models.size}<br/>
                   <strong># Makes:</strong> ${makes.size}<br/>
                   <strong>Newest Age:</strong> ${Math.min(...ages)}<br/>
                   <strong>Oldest Age:</strong> ${Math.max(...ages)}`;

    const ctx = document.getElementById('ageChart').getContext('2d');
    if (ageChart) ageChart.destroy();
    ageChart = new Chart(ctx,{
      type:'bar',
      data:{ labels: valid.map(x=>x.row), datasets:[{
        label:'Cumulative Avg Age', data:cum, backgroundColor:'rgba(52,152,219,0.7)', borderColor:'rgba(41,128,185,1)', borderWidth:1
      }]},
      options:{ responsive:true, scales:{
        x:{ title:{ display:true, text:'Row' }},
        y:{ title:{ display:true, text:'Age' }, beginAtZero:true }
      }, plugins:{ legend:{ display:false } } }
    });
  }

  /********* Trusty listing *********/
  async function listTrustyFiles() {
    const selector = document.getElementById('trustySelector');
    selector.innerHTML = '';
    try {
      const res = await fetch('./inventory-csvs/trusty/index.json', { cache:'no-store' });
      const files = await res.json();
      // Build latest per yard under "trusty"
      const latest = {};
      files.forEach(f => {
        const p = parseStamp(f, true);
        if (!p) return;
        if (!latest[p.loc] || p.dtKey > latest[p.loc].dtKey) latest[p.loc] = p;
      });

      Object.keys(latest).sort().forEach(locKey => {
        const entry = latest[locKey];
        const opt = document.createElement('option');
        opt.value = 'inventory-csvs/trusty/' + entry.filename;
        opt.dataset.loc = locKey;
        opt.textContent = `Trusty (${entry.dtDisplay})`;
        selector.appendChild(opt);
      });

      selector.onchange = (e) => {
        loadTrustyCSV(e.target.value);
      };

      if (selector.options.length) {
        selector.value = selector.options[0].value;
        loadTrustyCSV(selector.value);
      }
    } catch (err) {
      console.error('Error listing inventory CSVs (Trusty):', err);
    }
  }

  function loadTrustyCSV(path) {
    document.getElementById('trustySearchInput').value = '';
    Papa.parse(path, {
      download:true, header:true,
      complete(r) {
        trustyData = r.data.filter(row => row.Year && row.Make && row.Model && row.Row);
        renderTrustyTable(trustyData);
        showTrustyStatistics(trustyData);
      }
    });
  }

  function renderTrustyTable(data) {
    const hdr = document.getElementById('trustyTableHeader');
    const bd  = document.getElementById('trustyTableBody');
    hdr.innerHTML = ''; bd.innerHTML = '';
    if (!data.length) return;

    const cols = Object.keys(data[0]).concat('Note','Pick');
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      th.onclick = () => sortTrustyByColumn(c);
      hdr.appendChild(th);
    });

    const storedPick = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const pickKeys = new Set(storedPick.map(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|')));

    data.forEach(row => {
      const tr  = document.createElement('tr');
      const key = Object.values(row).join('|');
      tr.dataset.key = key;

      Object.values(row).forEach(v => {
        const td = document.createElement('td');
        td.textContent = v; tr.appendChild(td);
      });

      // Note cell
      const nt = document.createElement('td');
      nt.textContent = (notes[key] || '');
      nt.style.cursor = 'pointer';
      nt.addEventListener('click', e => {
        e.stopPropagation();
        selectedRowKey = key;
        const ni = document.getElementById('noteInput');
        ni.value = notes[key] || '';
        document.getElementById('noteLengthFeedback').style.display = 'none';
        document.getElementById('noteLimitInfo').style.display = 'none';
        new bootstrap.Modal(document.getElementById('noteModal')).show();
      });
      tr.appendChild(nt);

      // Clicking a Trusty row still opens the sold modal (uses Jalopy yard key if needed)
      tr.addEventListener('click', () => openSoldModal(row));

      // Pick
      const pickTd = document.createElement('td');
      const btn = document.createElement('button');
      btn.classList.add('pick-btn','btn','btn-sm');

      if (pickKeys.has(['Year','Make','Model','Row'].map(k => row[k]).join('|'))) {
        btn.textContent = '‚úì Picked'; btn.classList.add('btn-success'); tr.classList.add('table-success');
      } else {
        btn.textContent = '‚ûï Pick'; btn.classList.add('btn-outline-primary');
      }

      btn.addEventListener('click', e => {
        e.stopPropagation();
        const isPicked = btn.classList.contains('btn-success');

        // Build yard name from Trusty selector
        const sel = document.getElementById('trustySelector');
        const locKey = sel?.selectedOptions?.[0]?.dataset?.loc || '';
        const yardName = `Trusty`;

        if (!isPicked) {
          addToPickList({ ...row, Yard: yardName });
          btn.textContent = '‚úì Picked';
          btn.classList.replace('btn-outline-primary','btn-success');
          tr.classList.add('table-success');
        } else {
          removeFromPickList(['Year','Make','Model','Row'].map(k => row[k]).join('|'));
          btn.textContent = '‚ûï Pick';
          btn.classList.replace('btn-success','btn-outline-primary');
          tr.classList.remove('table-success');
        }
      });

      pickTd.appendChild(btn);
      tr.appendChild(pickTd);
      bd.appendChild(tr);
    });

    document.getElementById('trustySearchInput').oninput = function() {
      const q = this.value.toLowerCase();
      const filtered = trustyData.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(q)));
      renderTrustyTable(filtered);
      showTrustyStatistics(filtered);
    };
  }

  function sortTrustyByColumn(col) {
    const dir = trustySortDirection[col] === 'asc' ? 'desc' : 'asc';
    trustySortDirection[col] = dir;
    trustyData.sort((a,b) => a[col] < b[col] ? (dir==='asc'?-1:1) : a[col] > b[col] ? (dir==='asc'?1:-1) : 0);
    renderTrustyTable(trustyData); showTrustyStatistics(trustyData);
  }

  document.getElementById('trustyExportBtn').onclick = () =>
    exportTableToCSVGeneric('#trustyTableHeader', '#trustyTableBody', 'trusty_inventory_with_notes.csv');

  function showTrustyStatistics(data) {
    const s = document.getElementById('trustyStatistics');
    const valid = data.map(r => {
      const y = parseInt(r.Year), rn = parseInt(r.Row);
      return (!isNaN(y) && !isNaN(rn)) ? { row:rn, age:new Date().getFullYear()-y } : null;
    }).filter(Boolean);

    if (!valid.length) {
      s.innerHTML = `<strong>Average Age:</strong> N/A<br/>
                     <strong># Models:</strong> 0<br/>
                     <strong># Makes:</strong> 0<br/>
                     <strong>Newest Age:</strong> N/A<br/>
                     <strong>Oldest Age:</strong> N/A`;
      if (trustyAgeChart){ trustyAgeChart.destroy(); trustyAgeChart=null; }
      return;
    }

    valid.sort((a,b)=>a.row-b.row);
    const cum=[]; valid.forEach((it,i)=>{
      const slice=valid.slice(0,i+1).map(x=>x.age);
      cum.push(+(slice.reduce((s,v)=>s+v,0)/slice.length).toFixed(1));
    });
    const ages = valid.map(x=>x.age);
    const models=new Set(data.map(r=>`${r.Make}|${r.Model}`));
    const makes=new Set(data.map(r=>r.Make));

    s.innerHTML = `<strong>Average Age:</strong> ${cum.at(-1)}<br/>
                   <strong># Models:</strong> ${models.size}<br/>
                   <strong># Makes:</strong> ${makes.size}<br/>
                   <strong>Newest Age:</strong> ${Math.min(...ages)}<br/>
                   <strong>Oldest Age:</strong> ${Math.max(...ages)}`;

    const ctx = document.getElementById('trustyAgeChart').getContext('2d');
    if (trustyAgeChart) trustyAgeChart.destroy();
    trustyAgeChart = new Chart(ctx,{
      type:'bar',
      data:{ labels: valid.map(x=>x.row), datasets:[{
        label:'Cumulative Avg Age', data:cum, backgroundColor:'rgba(52,152,219,0.7)', borderColor:'rgba(41,128,185,1)', borderWidth:1
      }]},
      options:{ responsive:true, scales:{
        x:{ title:{ display:true, text:'Row' }},
        y:{ title:{ display:true, text:'Age' }, beginAtZero:true }
      }, plugins:{ legend:{ display:false } } }
    });
  }

  /**************
   * Pick List  *
   **************/
  function addToPickList(row, persist=true) {
    // row expected to include {Year, Make, Model, Row, Yard?}
    const tbody = document.getElementById('pickListBody');
    const tr = document.createElement('tr');

    const key = ['Year','Make','Model','Row'].map(k => String(row[k]).trim()).join('|');
    tr.dataset.key = key;

    ['Year','Make','Model','Row','Yard'].forEach(k => {
      const td = document.createElement('td');
      td.textContent = row[k] || '';
      tr.appendChild(td);
    });

    const noteTd = document.createElement('td');
    const originalKeyForNotes = [row.Year,row.Make,row.Model,row.Row].join('|');
    noteTd.textContent = (JSON.parse(localStorage.getItem('jalopyNotes') || '{}')[originalKeyForNotes] || '');
    tr.appendChild(noteTd);

    const rmTd = document.createElement('td');
    const rmBtn = document.createElement('button');
    rmBtn.className = 'btn btn-sm btn-outline-danger';
    rmBtn.textContent = '‚úï Remove';
    rmBtn.addEventListener('click', e => {
      e.stopPropagation();
      tbody.removeChild(tr);

      // reset pick buttons in visible tables (jalopy/trusty)
      [document.getElementById('tableBody'), document.getElementById('trustyTableBody')].forEach(tbodyEl => {
        if (!tbodyEl) return;
        const origRow = tbodyEl.querySelector(`tr[data-key="${originalKeyForNotes}"]`);
        if (origRow) {
          const pickBtn = origRow.querySelector('button.pick-btn');
          if (pickBtn) {
            pickBtn.textContent = '‚ûï Pick';
            pickBtn.classList.replace('btn-success','btn-outline-primary');
            origRow.classList.remove('table-success');
          }
        }
      });

      let pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
      pickList = pickList.filter(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|') !== key);
      localStorage.setItem('myPickList', JSON.stringify(pickList));
    });
    rmTd.appendChild(rmBtn);
    tr.appendChild(rmTd);

    tbody.appendChild(tr);

    if (persist) {
      let pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
      if (!pickList.some(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|') === key)) {
        pickList.push(row);
        localStorage.setItem('myPickList', JSON.stringify(pickList));
      }
    }
  }
  function removeFromPickList(key) {
    const tbody = document.getElementById('pickListBody');
    const rowEl = tbody.querySelector(`tr[data-key="${key}"]`);
    if (rowEl) tbody.removeChild(rowEl);
    let pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
    pickList = pickList.filter(r => ['Year','Make','Model','Row'].map(k => r[k]).join('|') !== key);
    localStorage.setItem('myPickList', JSON.stringify(pickList));
  }
  function loadPickListData() {
    const pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const tbody    = document.getElementById('pickListBody');
    tbody.innerHTML = '';
    pickList.forEach(row => addToPickList(row, false));
  }

  /****************
   * Sold modal   *
   ****************/
  function openSoldModal(row) {
    // Uses currently selected Jalopy yard for ebay-sales lookup
    const locKey = document.getElementById('csvSelector')?.selectedOptions?.[0]?.dataset?.loc;

    fetch('./ebay-sales/ebay-sales.json')
      .then(r => r.json())
      .then(files => {
        const prefix = `inventory_${locKey}_`;
        const soldFiles = files.filter(f => f.startsWith(prefix) && f.includes('_ebay_sales_'));
        if (!soldFiles.length) throw 'no-sold-files';

        let latestFile = soldFiles[0];
        let latestDate = latestFile.match(/_ebay_sales_(\d{4}-\d{2}-\d{2})\.csv$/)[1];
        soldFiles.forEach(f => {
          const m = f.match(/_ebay_sales_(\d{4}-\d{2}-\d{2})\.csv$/);
          if (m && m[1] > latestDate) { latestDate = m[1]; latestFile = f; }
        });
        return latestFile;
      })
      .then(latestFile => {
        const path = `./ebay-sales/${latestFile}`;
        return new Promise((resolve, reject) => {
          Papa.parse(path, { download:true, header:true,
            complete: res => resolve(res.data),
            error: err => reject(err)
          });
        });
      })
      .then(data => {
        const filtered = data.filter(r =>
          r.Year === row.Year && r.Make === row.Make && r.Model === row.Model
        );
        renderSoldTable(filtered);
      })
      .catch(err => {
        console.warn('Sold-data load:', err);
        renderSoldTable([]);
      })
      .finally(() => {
        new bootstrap.Modal(document.getElementById('soldModal')).show();
      });
  }

  function renderSoldTable(data) {
    const tbody = document.getElementById('soldDataBody');
    tbody.innerHTML = '';
    if (!data || !data.length) {
      document.getElementById('soldDataEmpty').style.display = '';
      return;
    }
    document.getElementById('soldDataEmpty').style.display = 'none';
    data.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r['Search Term']||''}</td>
        <td>${r['Listing Title']||''}</td>
        <td>${r['Last Sold Price']||''}</td>
        <td>${r['Date Sold']||''}</td>
        <td>${r['Time to Sell']||''}</td>
        <td>${r['Total Sold']||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  /****************
   * Settings     *
   ****************/
  const settingsBtn = document.getElementById('settingsBtn');
  const modalToggleDark = document.getElementById('modalToggleDark');

  settingsBtn.onclick = () => {
    const sel = document.getElementById('homeYardSelect');
    sel.value = localStorage.getItem('homeYard') || '';
    new bootstrap.Modal(document.getElementById('settingsModal')).show();
  };
  document.getElementById('saveSettings').onclick = () => {
    const yard = document.getElementById('homeYardSelect').value;
    localStorage.setItem('homeYard', yard.trim().toLowerCase().replace(/\s+/g,'_'));
    bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
    applyHomeYardDefault();
  };
  modalToggleDark.onclick = () => {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDark);
  };

  // Favorites UI
  document.getElementById('settingsModal').addEventListener('shown.bs.modal', renderFavoriteVehicles);
  document.getElementById('addFavVehicleBtn').onclick = () => {
    const year  = document.getElementById('favYearInput').value.trim();
    const make  = document.getElementById('favMakeInput').value.trim();
    const model = document.getElementById('favModelInput').value.trim();
    if (!year || !make || !model) return alert('Please fill in all three fields.');
    const list = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    list.push({ year, make, model });
    localStorage.setItem(FAV_KEY, JSON.stringify(list));
    document.getElementById('favYearInput').value = '';
    document.getElementById('favMakeInput').value = '';
    document.getElementById('favModelInput').value = '';
    renderFavoriteVehicles();
  };
  function renderFavoriteVehicles() {
    const ul = document.getElementById('favVehiclesList');
    ul.innerHTML = '';
    const list = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    list.forEach((v, idx) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
      li.innerHTML = `<span>${v.year} / ${v.make} / ${v.model}</span>
                      <button class="btn btn-sm btn-outline-danger">‚úï</button>`;
      li.querySelector('button').onclick = () => {
        list.splice(idx, 1);
        localStorage.setItem(FAV_KEY, JSON.stringify(list));
        renderFavoriteVehicles();
      };
      ul.appendChild(li);
    });
  }

  // Data Code (sync favorites + picklist + prefs)
  function getDataCode() {
    const pickList   = JSON.parse(localStorage.getItem('myPickList') || '[]');
    const favorites  = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    const homeYard   = localStorage.getItem('homeYard') || '';
    const darkMode   = localStorage.getItem('darkMode') || 'false';
    const combined = JSON.stringify({ pickList, favorites, homeYard, darkMode });
    return LZString.compressToBase64(combined);
  }
  function applyDataCode(code) {
    try {
      const json = LZString.decompressFromBase64(code);
      const obj  = JSON.parse(json);
      localStorage.setItem('myPickList', JSON.stringify(obj.pickList || []));
      localStorage.setItem(FAV_KEY, JSON.stringify(obj.favorites || []));
      localStorage.setItem('homeYard', (obj.homeYard || '').trim().toLowerCase().replace(/\s+/g,'_'));
      localStorage.setItem('darkMode', obj.darkMode || 'false');
      loadPickListData();
      renderFavoriteVehicles();
      if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
      alert('Data synced successfully!');
    } catch(e) {
      alert('Invalid Data Code.');
    }
  }
  document.getElementById('exportDataBtn').onclick = () => {
    const code = getDataCode();
    const out  = document.getElementById('dataCodeOutput');
    out.value  = code;
    out.select(); document.execCommand('copy');
    alert('Data Code copied to clipboard!');
  };
  document.getElementById('importDataBtn').onclick = () => {
    const code = document.getElementById('dataCodeInput').value.trim();
    if (code) applyDataCode(code);
  };
  
function csvEscape(val) {
  const s = String(val ?? '');
  const needsQuotes = /[",\n]/.test(s);
  const escaped = s.replace(/"/g, '""');
  return needsQuotes ? `"${escaped}"` : escaped;
}

function fileStamp() {
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
}

function gatherPickListRowsFromDOM() {
  // Exports in the exact order the user sees in the Pick List table
  const tbody = document.getElementById('pickListBody');
  const rows = [];
  const notesMap = JSON.parse(localStorage.getItem('jalopyNotes') || '{}');

  Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
    const tds = tr.querySelectorAll('td');
    if (tds.length < 6) return;
    const Year  = tds[0].textContent.trim();
    const Make  = tds[1].textContent.trim();
    const Model = tds[2].textContent.trim();
    const Row   = tds[3].textContent.trim();
    const Yard  = tds[4].textContent.trim();
    const key   = [Year, Make, Model, Row].join('|');
    const Notes = (notesMap[key] || '').replace(/\r?\n/g,' ');
    rows.push({ Year, Make, Model, Row, Yard, Notes });
  });

  return rows;
}

function gatherPickListRowsFromStorage() {
  // Uses storage order; useful for grouping/single-yard export
  const pickList = JSON.parse(localStorage.getItem('myPickList') || '[]');
  const notesMap = JSON.parse(localStorage.getItem('jalopyNotes') || '{}');
  return pickList.map(r => {
    const key = [r.Year, r.Make, r.Model, r.Row].join('|');
    return {
      Year:  r.Year || '',
      Make:  r.Make || '',
      Model: r.Model || '',
      Row:   r.Row || '',
      Yard:  r.Yard || '',
      Notes: (notesMap[key] || '').replace(/\r?\n/g,' ')
    };
  });
}

function downloadCSV(rows, filename) {
  const headers = ['Year','Make','Model','Row','Yard','Notes'];
  const lines = [headers.map(csvEscape).join(',')];
  rows.forEach(r => {
    lines.push([r.Year, r.Make, r.Model, r.Row, r.Yard, r.Notes].map(csvEscape).join(','));
  });
  const csv = lines.join('\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function downloadCSVGroupedByYard(rows, filename) {
  // Sort by Yard then Make/Model/Year/Row
  const sorted = [...rows].sort((a,b) =>
    (a.Yard||'').localeCompare(b.Yard||'') ||
    (a.Make||'').localeCompare(b.Make||'') ||
    (a.Model||'').localeCompare(b.Model||'') ||
    (parseInt(a.Year)||0) - (parseInt(b.Year)||0) ||
    (String(a.Row||'')).localeCompare(String(b.Row||''))
  );

  // We‚Äôll insert a "group header" row as: Yard:<name> ,,,,, (keeps Excel readable)
  const headers = ['Year','Make','Model','Row','Yard','Notes'];
  const lines = [];
  let currentYard = null;

  lines.push(headers.map(csvEscape).join(',')); // single header at top

  sorted.forEach(r => {
    if (r.Yard !== currentYard) {
      currentYard = r.Yard;
      // blank line + yard header line
      lines.push('');
      lines.push([`YARD: ${currentYard}`,'','','','',''].map(csvEscape).join(','));
    }
    lines.push([r.Year, r.Make, r.Model, r.Row, r.Yard, r.Notes].map(csvEscape).join(','));
  });

  const csv = lines.join('\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// --- modal wiring ---
function openExportPickListModal() {
  // populate yards
  const rows = gatherPickListRowsFromStorage();
  const yards = Array.from(new Set(rows.map(r => r.Yard).filter(Boolean))).sort();

  const select = document.getElementById('singleYardSelect');
  select.innerHTML = '<option value="">Select Yard‚Ä¶</option>';
  yards.forEach(y => {
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y;
    select.appendChild(opt);
  });

  // default: "as-is"
  document.getElementById('exportAsIs').checked = true;
  select.disabled = true;

  // enable/disable select when "single yard" chosen
  ['exportAsIs','exportGrouped','exportSingleYard'].forEach(id => {
    document.getElementById(id).onchange = () => {
      select.disabled = !document.getElementById('exportSingleYard').checked;
    };
  });

  bootstrap.Modal.getOrCreateInstance(document.getElementById('exportPickListModal')).show();
}

function performPickListExportFromModal() {
  const mode = document.querySelector('input[name="pickExportMode"]:checked')?.value || 'asis';
  const ts = fileStamp();

  if (mode === 'asis') {
    const rows = gatherPickListRowsFromDOM();
    if (!rows.length) return alert('Your pick list is empty.');
    downloadCSV(rows, `pick_list_${ts}.csv`);
    return;
  }

  if (mode === 'grouped') {
    const rows = gatherPickListRowsFromStorage();
    if (!rows.length) return alert('Your pick list is empty.');
    downloadCSVGroupedByYard(rows, `pick_list_grouped_${ts}.csv`);
    return;
  }

  if (mode === 'single') {
    const yard = document.getElementById('singleYardSelect').value.trim();
    if (!yard) return alert('Please choose a yard.');
    const rows = gatherPickListRowsFromStorage().filter(r => r.Yard === yard);
    if (!rows.length) return alert(`No rows found for yard: ${yard}`);
    downloadCSV(rows, `pick_list_${yard.replace(/\s+/g,'_')}_${ts}.csv`);
    return;
  }
}

// Hook up buttons
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('exportPickListBtn');
  if (btn) btn.addEventListener('click', openExportPickListModal);

  const confirm = document.getElementById('confirmExportPick');
  if (confirm) confirm.addEventListener('click', () => {
    performPickListExportFromModal();
    bootstrap.Modal.getInstance(document.getElementById('exportPickListModal')).hide();
  });
});

// Hook up the button
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('exportPickListBtn');
  if (btn) btn.addEventListener('click', exportPickListCSV);
});


  /****************
   * App init     *
   ****************/
  function initApp() {
    try { notes = JSON.parse(localStorage.getItem('jalopyNotes') || '{}'); } catch { notes = {}; }
    if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');

    listCSVFiles();      // Jalopy
    listTrustyFiles();   // Trusty
    loadPickListData();  // Pick list
  }

  // Start the serial gate flow
  validateStoredKey();

  </script>
</body>
</html>
