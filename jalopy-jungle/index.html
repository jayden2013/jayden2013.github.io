<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PROFIT - Parts Resale Optimization &amp; Field Inventory Tool</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <style>
    body.dark-mode { background-color: #121212; color: #f1f1f1; }
    body.dark-mode .table { color: #f1f1f1; }
    body.dark-mode .table-dark { background-color: #2c2c2c; }

    /* orange hover on rows */
    #inventoryTable tbody tr:hover td,
    #myInventoryTable tbody tr:hover td {
      background-color: orange !important;
      color: #000;
    }

    th { cursor: pointer; }
    .display-1:hover { color: orange; cursor: pointer; }
    .btn.disabled-look { opacity: 0.5; cursor: not-allowed; }

    /* Dark-mode styling for modals */
    .dark-mode .modal-content,
    .dark-mode .modal-content .modal-header,
    .dark-mode .modal-content .modal-body,
    .dark-mode .modal-content .modal-footer {
      background-color: #2c2c2c;
      color: #f1f1f1;
    }
	
	/* make the active tab‚Äôs text orange */
	.nav-tabs .nav-link.active,
	.nav-pills .nav-link.active {
	color: orange !important;
}

/* gold styling for unlocked premium button */
.btn-premium {
  background-color: gold !important;
  border-color: goldenrod !important;
  color: #000 !important;
}

  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <div class="display-1">PROFIT</div>
        <div class="h5">Parts Resale Optimization &amp; Field Inventory Tool</div>
		<div class="small text-muted">Cars and Collectibles LLC</div>
		<div class="small">
		<a href="https://carsandcollectibles.com" target="_blank">carsandcollectibles.com</a>
		</div>
      </div>
      <div>
        <button class="btn btn-outline-primary me-2" id="unlockBtn">Unlock Premium Features</button>
        <button class="btn btn-outline-secondary me-2 disabled-look" id="settingsBtn">‚öôÔ∏è Settings</button>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tableTab" type="button">Jalopy</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#statsTab" type="button">Statistics</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#myInventoryTab" type="button">Me</button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content pt-3">
      <!-- Inventory Table Tab -->
      <div class="tab-pane fade show active" id="tableTab">
        <div class="mb-3">
          <label for="csvSelector" class="form-label">Select Inventory CSV</label>
          <select class="form-select" id="csvSelector"></select>
        </div>
        <div class="mb-3">
          <input type="text" id="searchInput" class="form-control" placeholder="Filter rows...">
        </div>
        <div class="mb-3">
          <button class="btn btn-success disabled-look" id="exportBtn">Export Table to CSV</button>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-bordered" id="inventoryTable">
            <thead class="table-dark"><tr id="tableHeader"></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Statistics Tab -->
      <div class="tab-pane fade" id="statsTab">
        <div id="statistics"></div>
        <canvas id="ageChart" style="max-width:100%; margin-top:1em;"></canvas>
      </div>

      <!-- My Inventory Tab -->
      <div class="tab-pane fade" id="myInventoryTab">
	    <!-- start nested pills -->
  <ul class="nav nav-pills mb-3" id="myInvSubTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="inv-table-pill" data-bs-toggle="pill" data-bs-target="#invTablePane" type="button" role="tab">
        My Inventory
      </button>
    </li>
	<li class="nav-item">
  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mySoldTab" type="button">
    My Sold
  </button>
</li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="inv-stats-pill" data-bs-toggle="pill" data-bs-target="#invStatsPane" type="button" role="tab">
        My Statistics
      </button>
    </li>
  </ul>
  <div class="tab-content">
    <!-- inventory table pane -->
    <div class="tab-pane fade show active" id="invTablePane" role="tabpanel">
        <div class="mb-3">
          <button class="btn btn-outline-primary" id="addInventoryRow">Add Row</button>
		  <button class="btn btn-outline-success disabled-look" id="exportMyInventory">Export My Inventory to CSV</button>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-bordered" id="myInventoryTable">
            <thead class="table-dark">
              <tr>
                <th>Part</th>
                <th>List Price</th>
                <th>My Cost</th>
                <th>Shipping Cost</th>
                <th>Listing</th>
                <th>Profit</th>
				<th>Mark Sold</th>
              </tr>
            </thead>
            <tbody id="myInventoryBody"></tbody>
          </table>
        </div>
      </div>
	  <div class="tab-pane fade" id="mySoldTab" role="tabpanel">
  <div class="mb-3">
    <!-- you can add controls here if you like -->
  </div>
  <div class="table-responsive">
    <table class="table table-striped table-bordered" id="mySoldTable">
      <thead class="table-dark">
        <tr>
          <th>Part</th>
          <th>List Price</th>
          <th>My Cost</th>
          <th>Shipping Cost</th>
          <th>Listing</th>
          <th>Profit</th>
		  <th>Date Sold</th>
        </tr>
      </thead>
      <tbody id="mySoldBody"></tbody>
    </table>
  </div>
</div>
	  <div class="tab-pane fade" id="invStatsPane" role="tabpanel">
      <div id="mySoldStatistics" class="p-3">
        <!-- placeholder -->
        <p><strong>Total Items:</strong> <span id="ms-total-items">0</span></p>
        <p><strong>Total Profit:</strong> $<span id="ms-total-profit">0.00</span></p>
        <p><strong>Average Profit per Item:</strong> $<span id="ms-avg-profit">0.00</span></p>
      </div>
    </div>
    </div>
  </div>

  <!-- Serial Key Modal -->
  <div class="modal fade" id="serialModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Enter Serial Key</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input id="serialInput" class="form-control" placeholder="Serial Key">
          <div id="serialFeedback" class="text-danger mt-2" style="display:none;">Invalid serial key.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="submitSerial">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="homeYardSelect" class="form-label">Home Yard</label>
            <select id="homeYardSelect" class="form-select">
              <option value="">-- select yard --</option>
              <option>Boise</option>
              <option>Caldwell</option>
              <option>Garden City</option>
              <option>Nampa</option>
              <option>Twin Falls</option>
            </select>
          </div>
          <button class="btn btn-outline-secondary w-100 mb-2" id="modalToggleDark">Toggle Dark Mode</button>
		  <hr>
		<button class="btn btn-outline-primary w-100 mb-2" id="exportDataBtn">üìã Copy Data Code</button>
		<textarea id="dataCodeOutput" class="form-control mb-2" rows="3" readonly placeholder="Your data code will appear here‚Ä¶"></textarea>
		<label for="dataCodeInput" class="form-label">Paste Data Code to Sync:</label>
		<textarea id="dataCodeInput" class="form-control mb-2" rows="3" placeholder="Paste someone‚Äôs data code here‚Ä¶"></textarea>
		<button class="btn btn-primary w-100" id="importDataBtn">üîÑ Import Data Code</button>

        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" id="saveSettings">Save Settings</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Modal -->
  <div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Note</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <textarea id="noteInput" class="form-control" rows="4" placeholder="Enter your note here..."></textarea>
          <div id="noteLimitInfo" class="text-muted mt-2" style="display:none;">
            Notes are limited to 20 characters. Upgrade to premium for unlimited characters.
          </div>
          <div id="noteLengthFeedback" class="text-danger mt-2" style="display:none;">Max 20 characters for non-premium users.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-danger" id="clearNote">Clear Note</button>
          <button class="btn btn-primary" id="saveNote">Save Note</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Premium feature state
    let isPremium = false, premiumName = '';
    let serialData = [];
    const unlockBtn = document.getElementById('unlockBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const modalToggleDark = document.getElementById('modalToggleDark');
    const exportBtn = document.getElementById('exportBtn');
    const addInventoryRow = document.getElementById('addInventoryRow');
	const exportMyInvBtn = document.getElementById('exportMyInventory');
    const serialModal = new bootstrap.Modal(document.getElementById('serialModal'));
    const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));

    // Load & check serial keys
    fetch('json/serial-keys.json')
      .then(r => r.json())
      .then(data => { serialData = data; checkKey(); })
      .catch(console.error);

    function checkKey() {
      const key = localStorage.getItem('premiumKey');
      const entry = serialData.find(e => e.key === key);
      if (entry) {
        isPremium = true; premiumName = entry.name; enablePremium();
      }
    }

    unlockBtn.onclick = () => {
      document.getElementById('serialFeedback').style.display = 'none';
      document.getElementById('serialInput').value = '';
      serialModal.show();
    };
    document.getElementById('submitSerial').onclick = () => {
      const key = document.getElementById('serialInput').value.trim();
      const entry = serialData.find(e => e.key === key);
      if (entry) {
        localStorage.setItem('premiumKey', key);
        isPremium = true; premiumName = entry.name;
        serialModal.hide(); enablePremium(); alert(`Welcome, ${premiumName}!`);
      } else {
        document.getElementById('serialFeedback').style.display = 'block';
      }
    };

    function enablePremium() {
      settingsBtn.classList.remove('disabled-look');
      exportBtn.classList.remove('disabled-look');
      addInventoryRow.classList.remove('disabled-look');
	  exportMyInvBtn.classList.remove('disabled-look');
      unlockBtn.disabled = true;
      unlockBtn.textContent = `Premium: ${premiumName}`;
	  // remove the old outline style and apply gold
	  unlockBtn.classList.remove('btn-outline-primary');
	  unlockBtn.classList.add('btn-premium');
      applyHomeYardDefault();
    }

    // Dark mode toggle in modal
    modalToggleDark.onclick = () => {
      if (!isPremium) { alert('Dark mode is only available for premium users.'); return; }
		const isDark = document.body.classList.toggle('dark-mode');
		localStorage.setItem('darkMode', isDark);      // ‚Üê save it
    };

    settingsBtn.onclick = () => {
      if (!isPremium) { alert('Settings are only available for premium users.'); return; }
      const sel = document.getElementById('homeYardSelect');
      sel.value = localStorage.getItem('homeYard') || '';
      settingsModal.show();
    };
    document.getElementById('saveSettings').onclick = () => {
      const yard = document.getElementById('homeYardSelect').value;
      localStorage.setItem('homeYard', yard);
      settingsModal.hide();
      applyHomeYardDefault();
    };

    // Export CSV
    exportBtn.onclick = () => {
      if (!isPremium) { alert('Exporting is only available to premium users.'); return; }
      exportTableToCSV();
    };

    // My Inventory: dynamic rows + profit calc
    function addRow() {
      const tbody = document.getElementById('myInventoryBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="form-control part-input" /></td>
        <td><input type="number" step="0.01" class="form-control list-price" /></td>
        <td><input type="number" step="0.01" class="form-control my-cost" /></td>
        <td><input type="number" step="0.01" class="form-control ship-cost" /></td>
        <td><input class="form-control listing-input" /></td>
		<td class="profit-cell">0.00</td>
		<td><button class="btn btn-sm btn-outline-success mark-sold-btn">Mark Sold</button></td>
      `;
      tbody.append(tr);
      ['list-price','my-cost','ship-cost'].forEach(cls => {
        tr.querySelector(`.${cls}`).addEventListener('input', () => calcProfit(tr));
      });
	  // any time any input in this row changes, recalc & save
	tr.querySelectorAll('input').forEach(inp => {
		inp.addEventListener('input', () => {
			calcProfit(tr);
			saveMyInventory();
		});
	});
	
	// when you click ‚ÄúMark Sold‚Äù:
tr.querySelector('.mark-sold-btn').addEventListener('click', () => {
  // 1) gather the values from this row
  const data = {
    part:    tr.querySelector('.part-input').value.trim(),
    list:    tr.querySelector('.list-price').value.trim(),
    cost:    tr.querySelector('.my-cost').value.trim(),
    ship:    tr.querySelector('.ship-cost').value.trim(),
    listing: tr.querySelector('.listing-input').value.trim(),
    profit:  tr.querySelector('.profit-cell').textContent.trim(),
  };

  // 2) append a new row to the My Sold table
  const soldTbody = document.getElementById('mySoldBody');
  const soldTr = document.createElement('tr');
  soldTr.innerHTML = `
    <td>${data.part}</td>
    <td>${data.list}</td>
    <td>${data.cost}</td>
    <td>${data.ship}</td>
    <td>${data.listing}</td>
    <td>${data.profit}</td>
	<td class="sold-date-cell">${new Date().toLocaleDateString()}</td>
  `;
  soldTbody.appendChild(soldTr);

  // 3) remove this row from My Inventory
  tr.remove();

  // 4) persist both tables
  saveMyInventory();  // your existing function
  saveMySoldData();   // see next step
});
	
    }
    function calcProfit(tr) {
      const lp = parseFloat(tr.querySelector('.list-price').value) || 0;
      const mc = parseFloat(tr.querySelector('.my-cost').value) || 0;
      const sc = parseFloat(tr.querySelector('.ship-cost').value) || 0;
      tr.querySelector('.profit-cell').textContent = (lp - mc - sc).toFixed(2);
    }
    addInventoryRow.onclick = () => {
		const rowCount = document.querySelectorAll('#myInventoryTable tr').length;
      if (!isPremium && rowCount > 5) { alert('Adding additional rows is only for premium users.'); return; }
      addRow();
    };
	
	exportMyInvBtn.onclick = () => {
		if (!isPremium) {
		alert('Exporting is only available to premium users.');
		return;
	}
		exportMyInventory();
	};
	
	function exportMyInventory() {
		const headers = ['Part','List Price','My Cost','Shipping Cost','Listing','Profit'];
		const rows = Array.from(
		document.querySelectorAll('#myInventoryTable tbody tr')
	).map(tr => {
		const cells = tr.querySelectorAll('td');
		return [
			cells[0].querySelector('input')?.value.trim() || '',
			cells[1].querySelector('input')?.value.trim() || '',
			cells[2].querySelector('input')?.value.trim() || '',
			cells[3].querySelector('input')?.value.trim() || '',
			cells[4].querySelector('input')?.value.trim() || '',
			cells[5].textContent.trim() || ''
		];
	});

  // build CSV text
  const csv = [
    headers.join(','),
    ...rows.map(r => r.join(','))
  ].join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'my_inventory.csv';
  document.body.append(link);
  link.click();
  link.remove();
}

    // Dashboard logic (Inventory table, notes, stats)
    let notes = JSON.parse(localStorage.getItem('jalopyNotes') || '{}');
    let selectedRowKey = null, currentData = [], sortDirection = {}, ageChart = null;

    async function listCSVFiles() {
      const res = await fetch('./inventory-csvs/index.json');
      const files = await res.json();
      populateSelector(files);
    }
    function populateSelector(files) {
      const sel = document.getElementById('csvSelector');
      sel.innerHTML = '';
      files.slice().reverse().forEach(f => sel.add(new Option(f, f)));
      sel.onchange = () => loadCSV('inventory-csvs/' + sel.value);
      applyHomeYardDefault();
    }
    function applyHomeYardDefault() {
      const sel = document.getElementById('csvSelector');
      const opts = Array.from(sel.options).map(o => o.value);
      let choice = opts[0];
      if (isPremium) {
        const home = localStorage.getItem('homeYard');
        if (home) {
          const prefix = 'inventory_' + home.toLowerCase().replace(/ /g,'_') + '_';
          const found = opts.find(f => f.startsWith(prefix));
          if (found) choice = found;
        }
      }
      sel.value = choice;
      loadCSV('inventory-csvs/' + choice);
    }
    function loadCSV(path) {
      document.getElementById('searchInput').value = '';
      Papa.parse(path, { download: true, header: true, complete(r) {
        currentData = r.data.filter(row => row.Year && row.Make && row.Model && row.Row);
        renderTable(currentData);
        showStatistics(currentData);
      }});
    }
    function renderTable(data) {
      const hdr = document.getElementById('tableHeader'), bd = document.getElementById('tableBody');
      hdr.innerHTML = ''; bd.innerHTML = '';
      if (!data.length) return;
      const cols = Object.keys(data[0]).concat('Note');
      cols.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c;
        th.onclick = () => sortTableByColumn(c);
        hdr.append(th);
      });
      data.forEach(row => {
        const tr = document.createElement('tr');
        const key = Object.values(row).join('|');
        Object.values(row).forEach(v => {
          const td = document.createElement('td');
          td.textContent = v; tr.append(td);
        });
        const nt = document.createElement('td');
        nt.textContent = notes[key] || '';
        nt.style.cursor = 'pointer';
        nt.onclick = e => {
          e.stopPropagation();
          selectedRowKey = key;
          const ni = document.getElementById('noteInput');
          ni.value = notes[key] || '';
          document.getElementById('noteLengthFeedback').style.display = 'none';
          if (isPremium) {
            ni.removeAttribute('maxlength');
            document.getElementById('noteLimitInfo').style.display = 'none';
          } else {
            ni.setAttribute('maxlength','20'); document.getElementById('noteLimitInfo').style.display='block';
          }
          new bootstrap.Modal(document.getElementById('noteModal')).show();
        };
        tr.append(nt);
        bd.append(tr);
      });
      document.getElementById('searchInput').oninput = function() {
        const q = this.value.toLowerCase();
        const fil = currentData.filter(r =>
          Object.values(r).some(v => v.toLowerCase().includes(q))
        );
        renderTable(fil); showStatistics(fil);
      };
    }
    function sortTableByColumn(col) {
      const dir = sortDirection[col]==='asc'?'desc':'asc';
      sortDirection[col] = dir;
      currentData.sort((a,b)=> a[col]<b[col] ? (dir==='asc'? -1:1) : a[col]>b[col] ? (dir==='asc'?1:-1) : 0);
      renderTable(currentData); showStatistics(currentData);
    }
    document.getElementById('saveNote').onclick = () => {
      const ni = document.getElementById('noteInput'), val = ni.value;
      if (!isPremium && val.length>20) {
        document.getElementById('noteLengthFeedback').style.display = 'block'; return;
      }
      document.getElementById('noteLengthFeedback').style.display = 'none';
      if (selectedRowKey) {
        notes[selectedRowKey] = val;
        localStorage.setItem('jalopyNotes', JSON.stringify(notes));
        renderTable(currentData);
      }
      bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
    };
    document.getElementById('clearNote').onclick = () => {
      if (selectedRowKey) {
        delete notes[selectedRowKey];
        localStorage.setItem('jalopyNotes', JSON.stringify(notes));
        renderTable(currentData);
        document.getElementById('noteInput').value='';
        document.getElementById('noteLengthFeedback').style.display='none';
      }
    };
    function exportTableToCSV() {
      const hdrs = Array.from(document.querySelectorAll('#tableHeader th')).map(th=>th.textContent);
      const rows = Array.from(document.querySelectorAll('#tableBody tr')).map(tr=>
        Array.from(tr.cells).map(td=>td.textContent)
      );
      const csv = [hdrs, ...rows].map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='inventory_with_notes.csv';
      document.body.append(a); a.click(); a.remove();
    }
    function showStatistics(data) {
      const s = document.getElementById('statistics');
      const valid = data.map(r=>{
        const y=parseInt(r.Year), rn=parseInt(r.Row);
        return !isNaN(y)&&!isNaN(rn)?{row:rn,age:new Date().getFullYear()-y}:null;
      }).filter(x=>x);
      if (!valid.length) {
        s.innerHTML = `<strong>Average Age:</strong> N/A<br/>
                       <strong># Models:</strong> 0<br/>
                       <strong># Makes:</strong> 0<br/>
                       <strong>Newest Age:</strong> N/A<br/>
                       <strong>Oldest Age:</strong> N/A`;
        if (ageChart){ ageChart.destroy(); ageChart=null; }
        return;
      }
      valid.sort((a,b)=>a.row-b.row);
      const cum=[]; valid.forEach((it,i)=>{
        const slice=valid.slice(0,i+1).map(x=>x.age);
        cum.push(+(slice.reduce((s,v)=>s+v,0)/slice.length).toFixed(1));
      });
      const ages = valid.map(x=>x.age);
      const models=new Set(data.map(r=>`${r.Make}|${r.Model}`));
      const makes=new Set(data.map(r=>r.Make));
      s.innerHTML = `<strong>Average Age:</strong> ${cum[cum.length-1]}<br/>
                     <strong># Models:</strong> ${models.size}<br/>
                     <strong># Makes:</strong> ${makes.size}<br/>
                     <strong>Newest Age:</strong> ${Math.min(...ages)}<br/>
                     <strong>Oldest Age:</strong> ${Math.max(...ages)}`;
      const ctx = document.getElementById('ageChart').getContext('2d');
      if (ageChart) ageChart.destroy();
      ageChart=new Chart(ctx,{
        type:'bar',
        data:{labels:valid.map(x=>x.row),datasets:[{
          label:'Cumulative Avg Age',
          data:cum,
          backgroundColor:'rgba(52,152,219,0.7)',
          borderColor:'rgba(41,128,185,1)',borderWidth:1
        }]},
        options:{responsive:true,scales:{
          x:{title:{display:true,text:'Row'}},
          y:{title:{display:true,text:'Age'},beginAtZero:true}
        },plugins:{legend:{display:false}}}
      });
    }

	/**
	* Read every row in My Inventory and save its input values to localStorage
	*/
	function saveMyInventory() {
		const data = Array.from(
			document.querySelectorAll('#myInventoryTable tbody tr')
		).map(tr => ({
				part:    tr.querySelector('.part-input')?.value.trim()    || '',
				list:    tr.querySelector('.list-price')?.value.trim()    || '',
				cost:    tr.querySelector('.my-cost')?.value.trim()       || '',
				ship:    tr.querySelector('.ship-cost')?.value.trim()     || '',
				listing: tr.querySelector('.listing-input')?.value.trim() || ''
				// profit is computed, no need to store
			}));
		localStorage.setItem('myInventoryData', JSON.stringify(data));
	}

	/**
	* On load, read saved data and repopulate My Inventory rows
	*/
	function loadMyInventory() {
		const saved = JSON.parse(localStorage.getItem('myInventoryData') || '[]');
		const tbody = document.querySelector('#myInventoryTable tbody');
		// if we have fewer rows than saved, add more
		while (tbody.rows.length < Math.max(saved.length, 3)) {
			addRow();
		}
		// fill each saved row
		saved.forEach((rowData, i) => {
			const tr = tbody.rows[i];
			const inputs = tr.querySelectorAll('input');
			inputs[0].value = rowData.part;
			inputs[1].value = rowData.list;
			inputs[2].value = rowData.cost;
			inputs[3].value = rowData.ship;
			inputs[4].value = rowData.listing;
			calcProfit(tr);
		});
	}
	
	function saveMySoldData() {
  const sold = Array.from(
    document.querySelectorAll('#mySoldBody tr')
  ).map(tr => {
    const cells = tr.querySelectorAll('td');
    return {
      part:    cells[0].textContent.trim(),
      list:    cells[1].textContent.trim(),
      cost:    cells[2].textContent.trim(),
      ship:    cells[3].textContent.trim(),
      listing: cells[4].textContent.trim(),
      profit:  cells[5].textContent.trim(),
	  dateSold: tr.querySelector('.sold-date-cell').textContent.trim()
    };
  });
  localStorage.setItem('mySoldData', JSON.stringify(sold));
}

function loadMySoldData() {
  const saved = JSON.parse(localStorage.getItem('mySoldData') || '[]');
  const tbody = document.getElementById('mySoldBody');
  tbody.innerHTML = '';
  saved.forEach(data => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${data.part}</td>
      <td>${data.list}</td>
      <td>${data.cost}</td>
      <td>${data.ship}</td>
      <td>${data.listing}</td>
      <td>${data.profit}</td>
	  <td class="sold-date-cell">${data.dateSold}</td>
    `;
    tbody.appendChild(tr);
  });
}
	
	function updateMySoldStats() {
// grab every sold‚Äêrow
  const rows = Array.from(document.querySelectorAll('#mySoldBody tr'));
  // count them
  const totalItems = rows.length;
  // sum up the profit column (7th cell)
  const totalProfit = rows.reduce((sum, tr) => {
    const p = parseFloat(tr.children[5].textContent) || 0;
    return sum + p;
  }, 0);
  // average per row
  const avgProfit = totalItems
    ? (totalProfit / totalItems).toFixed(2)
    : '0.00';

  // write out
  document.getElementById('ms-total-items').textContent  = totalItems;
  document.getElementById('ms-total-profit').textContent = totalProfit.toFixed(2);
  document.getElementById('ms-avg-profit').textContent   = avgProfit;
}

// call this whenever you add/save rows:
addInventoryRow.addEventListener('click', updateMySoldStats);
exportMyInvBtn.addEventListener('click', updateMySoldStats);
// also after load/save:
saveMyInventory = (function(orig) {
  return function() { orig(); updateMySoldStats(); };
})(saveMyInventory);
loadMyInventory = (function(orig) {
  return function() { orig(); updateMySoldStats(); };
})(loadMyInventory);

// and finally at initial load:
window.addEventListener('DOMContentLoaded', () => {
      // Initialize
	for (let i = 0; i < 3; i++) {
		addRow();
	}
	
	// ‚îÄ‚îÄ‚îÄ Data-Code Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// compress both tables into one Base64 string
function getDataCode() {
  const inv = JSON.parse(localStorage.getItem('myInventoryData') || '[]');
  const sold = JSON.parse(localStorage.getItem('mySoldData')     || '[]');
  const homeYard = localStorage.getItem('homeYard') || '';
  const combined = JSON.stringify({ inventory: inv, sold: sold, homeYard: homeYard });
  return LZString.compressToBase64(combined);
}

// decompress & restore into localStorage, then reload tables
function applyDataCode(code) {
  try {
    const json = LZString.decompressFromBase64(code);
    const obj  = JSON.parse(json);
    localStorage.setItem('myInventoryData', JSON.stringify(obj.inventory));
    localStorage.setItem('mySoldData',      JSON.stringify(obj.sold));
	localStorage.setItem('homeYard',		obj.homeYard || '');
    loadMyInventory();
    loadMySoldData();
    alert('Data synced successfully!');
  } catch(e) {
    alert('Invalid Data Code.');
  }
}

// hook up the buttons
document.getElementById('exportDataBtn').onclick = () => {
  const code = getDataCode();
  const out  = document.getElementById('dataCodeOutput');
  out.value  = code;
  out.select();
  document.execCommand('copy');
  alert('Data Code copied to clipboard!');
};

document.getElementById('importDataBtn').onclick = () => {
  const code = document.getElementById('dataCodeInput').value.trim();
  if (code) applyDataCode(code);
};
	
	
	
    listCSVFiles();
	loadMyInventory();
	loadMySoldData();
  updateMySoldStats();
  
  // restore dark mode if previously set
if (localStorage.getItem('darkMode') === 'true') {
  document.body.classList.add('dark-mode');
}

});



  </script>
</body>
</html>